services:
  app:
    build: .
    container_name: dotmac_sub_app
    restart: unless-stopped
    ports:
    - 127.0.0.1:8001:8001
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:bM8biKVGYQFZvRVyrvvq7b7QP_8VzfVzPrYtPGrIHXg@db:5432/dotmac_sub
      CELERY_BROKER_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/1
      REDIS_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      WIREGUARD_USE_NSENTER: '1'
      VPN_BLOCKED_LAN_SUBNETS: 172.20.255.0/24
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dotmac-sub-admin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-RSF0U0vLTgfaU7wqtOibmpCSXVeLD-5s}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-dotmac-private}
      S3_REGION: ${S3_REGION:-us-east-1}
    env_file:
    - .env
    depends_on:
    - db
    - redis
    - minio
    cap_add:
    - NET_ADMIN
    privileged: true
    pid: host
    sysctls:
      net.ipv4.ip_forward: '1'
    volumes:
    - /etc/wireguard:/etc/wireguard
    - ./app:/app/app
    - ./templates:/app/templates
    - ./static:/app/static
    - ./alembic:/app/alembic
    - ./uploads:/app/uploads
    command:
    - /bin/sh
    - -c
    - alembic upgrade heads && uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
  celery-worker:
    build: .
    container_name: dotmac_sub_celery_worker
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:bM8biKVGYQFZvRVyrvvq7b7QP_8VzfVzPrYtPGrIHXg@db:5432/dotmac_sub
      CELERY_BROKER_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/1
      REDIS_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dotmac-sub-admin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-RSF0U0vLTgfaU7wqtOibmpCSXVeLD-5s}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-dotmac-private}
      S3_REGION: ${S3_REGION:-us-east-1}
    env_file:
    - .env
    depends_on:
    - db
    - redis
    - minio
    volumes:
    - ./app:/app/app
    - ./uploads:/app/uploads
    command:
    - celery
    - -A
    - app.celery_app.celery_app
    - worker
    - --loglevel=info
  celery-beat:
    build: .
    container_name: dotmac_sub_celery_beat
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:bM8biKVGYQFZvRVyrvvq7b7QP_8VzfVzPrYtPGrIHXg@db:5432/dotmac_sub
      CELERY_BROKER_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/1
      REDIS_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dotmac-sub-admin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-RSF0U0vLTgfaU7wqtOibmpCSXVeLD-5s}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-dotmac-private}
      S3_REGION: ${S3_REGION:-us-east-1}
    env_file:
    - .env
    depends_on:
    - db
    - redis
    - minio
    volumes:
    - ./app:/app/app
    command:
    - celery
    - -A
    - app.celery_app.celery_app
    - beat
    - --loglevel=info
  db:
    image: postgis/postgis:16-3.4
    container_name: dotmac_sub_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: bM8biKVGYQFZvRVyrvvq7b7QP_8VzfVzPrYtPGrIHXg
      POSTGRES_DB: dotmac_sub
    ports:
    - 127.0.0.1:5434:5432
    volumes:
    - dotmac_sub_db_data:/var/lib/postgresql/data
  redis:
    image: redis:7
    container_name: dotmac_sub_redis
    restart: unless-stopped
    command: redis-server --requirepass WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q
    ports:
    - 127.0.0.1:6384:6379
  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: dotmac_sub_minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-dotmac-sub-admin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-RSF0U0vLTgfaU7wqtOibmpCSXVeLD-5s}
    command: server /data --console-address ":9001"
    ports:
    - 9002:9000
    - 9003:9001
    volumes:
    - minio_data:/data
  nominatim:
    image: mediagis/nominatim:4.4
    container_name: dotmac_sub_nominatim
    restart: unless-stopped
    environment:
      NOMINATIM_PBF_URL: https://download.geofabrik.de/africa/nigeria-latest.osm.pbf
      NOMINATIM_IMPORT_STYLE: extratags
      NOMINATIM_IMPORT: '1'
    ports:
    - 8080:8080
    volumes:
    - nominatim_data:/var/lib/postgresql/14/main
    - nominatim_flatnode:/var/lib/nominatim/flatnode
  freeradius:
    image: freeradius/freeradius-server:3.2.3
    container_name: dotmac_sub_freeradius
    restart: unless-stopped
    ports:
    - 1812:1812/udp
    - 1813:1813/udp
    volumes:
    - ./config/freeradius/mods-enabled/sql:/etc/raddb/mods-enabled/sql
    - ./config/freeradius/sites-enabled/default:/etc/raddb/sites-enabled/default
    - ./config/freeradius/dictionary.mikrotik:/etc/raddb/dictionary.mikrotik
    - ./config/freeradius/dictionary:/etc/raddb/dictionary
    depends_on:
    - radius-db
    environment:
    - RADIUS_DB_HOST=radius-db
    - RADIUS_DB_NAME=radius
    - RADIUS_DB_USER=radius
    - RADIUS_DB_PASS=U7W9rniJZhRQMqYJHtpyGlT89z28jri_BMOstBduiRk
  radius-db:
    image: postgres:16
    container_name: dotmac_sub_radius_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: radius
      POSTGRES_PASSWORD: U7W9rniJZhRQMqYJHtpyGlT89z28jri_BMOstBduiRk
      POSTGRES_DB: radius
    ports:
    - 127.0.0.1:5437:5432
    volumes:
    - radius_db_data:/var/lib/postgresql/data
    - ./config/freeradius/schema.sql:/docker-entrypoint-initdb.d/schema.sql
  genieacs:
    image: genieacs/genieacs:1.2.9
    container_name: dotmac_sub_genieacs
    restart: unless-stopped
    ports:
    - 7547:7547
    - 7557:7557
    - 7567:7567
    - 3000:3000
    depends_on:
    - genieacs-mongodb
    environment:
    - GENIEACS_MONGODB_CONNECTION_URL=mongodb://genieacs:ihDB8I_ohCytYf9Dq_DTBxs3jOTl6aoZtpxS6GblJWo@genieacs-mongodb/genieacs?authSource=admin
  genieacs-mongodb:
    image: mongo:4.4
    container_name: dotmac_sub_genieacs_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: genieacs
      MONGO_INITDB_ROOT_PASSWORD: ihDB8I_ohCytYf9Dq_DTBxs3jOTl6aoZtpxS6GblJWo
    ports:
    - 127.0.0.1:27017:27017
    volumes:
    - genieacs_mongodb_data:/data/db
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.96.0
    container_name: dotmac_sub_victoriametrics
    restart: unless-stopped
    ports:
    - 8428:8428
    volumes:
    - victoriametrics_data:/victoria-metrics-data
    command:
    - -retentionPeriod=365d
    - -search.maxUniqueTimeseries=1000000
  bandwidth-poller:
    build: .
    container_name: dotmac_sub_bandwidth_poller
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:bM8biKVGYQFZvRVyrvvq7b7QP_8VzfVzPrYtPGrIHXg@db:5432/dotmac_sub
      REDIS_URL: redis://:WjGCq7ve4rTaPQqkOdk9KaAFd_hnxj2z9l_fDJBMj9Q@redis:6379/0
      VICTORIAMETRICS_URL: http://victoriametrics:8428
      BANDWIDTH_POLLING_ENABLED: 'true'
      BANDWIDTH_POLL_INTERVAL_MS: '1000'
      BANDWIDTH_HOT_RETENTION_HOURS: '24'
      BANDWIDTH_REDIS_STREAM: bandwidth:samples
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dotmac-sub-admin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-RSF0U0vLTgfaU7wqtOibmpCSXVeLD-5s}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-dotmac-private}
      S3_REGION: ${S3_REGION:-us-east-1}
    env_file:
    - .env
    depends_on:
    - db
    - redis
    - victoriametrics
    - minio
    volumes:
    - ./app:/app/app
    command:
    - python
    - -m
    - app.poller
volumes:
  dotmac_sub_db_data: null
  nominatim_data: null
  nominatim_flatnode: null
  radius_db_data: null
  genieacs_mongodb_data: null
  victoriametrics_data: null
  minio_data: null
networks:
  default:
    name: dotmac_sub_default
    ipam:
      config:
      - subnet: 172.20.254.0/24
