{% extends "layouts/admin.html" %}

{% block title %}Add VPN Client - Admin{% endblock %}

{% block content %}
<div class="mx-auto max-w-5xl space-y-6 px-4 py-6 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Add VPN Client</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Generate WireGuard `.conf` or OpenVPN `.ovpn` client configuration.</p>
        </div>
        <a href="/admin/network/vpn{% if selected_server_id %}?server_id={{ selected_server_id }}{% endif %}" class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200">Back</a>
    </div>

    {% if errors %}
    <div class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700 dark:border-rose-800 dark:bg-rose-900/20 dark:text-rose-300">
        {% for error in errors %}
        <p>{{ error }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <div class="rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
        <form method="POST" action="/admin/network/vpn/clients/new" class="space-y-5">
            {% include "components/forms/csrf_input.html" %}

            <div>
                <label for="protocol" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Protocol</label>
                <select id="protocol" name="protocol" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white" onchange="this.form.submit()">
                    <option value="wireguard" {% if protocol == 'wireguard' %}selected{% endif %}>WireGuard</option>
                    <option value="openvpn" {% if protocol == 'openvpn' %}selected{% endif %}>OpenVPN</option>
                </select>
            </div>

            <div>
                <label for="name" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Client name</label>
                <input id="name" name="name" type="text" required class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white" placeholder="e.g. HQ Router" />
            </div>

            {% if protocol == 'wireguard' %}
            <div>
                <label for="server_id" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">WireGuard server</label>
                <select id="server_id" name="server_id" required class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">Select server</option>
                    {% for server in servers %}
                    <option value="{{ server.id }}" {% if selected_server_id == server.id|string %}selected{% endif %}>{{ server.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="peer_address" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Client tunnel IP (optional)</label>
                <input id="peer_address" name="peer_address" type="text" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white" placeholder="e.g. 10.10.0.20/32" />
            </div>
            {% else %}
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label for="remote_host" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Remote host</label>
                    <input id="remote_host" name="remote_host" type="text" value="{{ openvpn_config.remote_host }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="remote_port" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Remote port</label>
                    <input id="remote_port" name="remote_port" type="number" value="{{ openvpn_config.remote_port }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
            </div>
            {% endif %}

            <div class="flex items-center justify-end gap-2">
                <a href="/admin/network/vpn" class="rounded-lg px-3 py-2 text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-white">Cancel</a>
                <button type="submit" class="rounded-lg bg-violet-600 px-4 py-2 text-sm font-semibold text-white hover:bg-violet-700">Generate Client Config</button>
            </div>
        </form>
    </div>

    {% if result %}
    <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-5 shadow-sm dark:border-emerald-800/40 dark:bg-emerald-900/10">
        <p class="text-sm font-semibold text-emerald-800 dark:text-emerald-300">Generated {{ result.protocol|title }} client config: {{ result.filename }}</p>
        <textarea readonly rows="16" class="mt-3 w-full rounded-lg border border-emerald-200 bg-white p-3 font-mono text-xs text-slate-700 dark:border-emerald-700 dark:bg-slate-900 dark:text-slate-200">{{ result.config_content }}</textarea>
    </div>
    {% endif %}
</div>
{% endblock %}
