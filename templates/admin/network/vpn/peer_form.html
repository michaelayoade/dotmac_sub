{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, card %}

{% block title %}{% if peer %}Edit{% else %}New{% endif %} VPN Peer - Admin{% endblock %}

{% block content %}
{{ ambient_background("violet", "purple") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% set wg_icon %}
    <svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
    </svg>
    {% endset %}

    {% call page_header(
        title="Edit Peer" if peer else "New Peer",
        subtitle="Server: " ~ server.name,
        icon=wg_icon,
        color="violet",
        color2="purple"
    ) %}
        <a href="/admin/network/vpn?server_id={{ server.id }}" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition-all hover:bg-slate-50 hover:border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Back
        </a>
    {% endcall %}

    {# Errors #}
    {% if errors %}
    <div class="animate-fade-in-up rounded-2xl border border-red-200/60 bg-red-50 p-4 dark:border-red-800/40 dark:bg-red-900/20">
        <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <h3 class="font-medium text-red-800 dark:text-red-200">Please fix the following errors:</h3>
                <ul class="mt-2 list-inside list-disc text-sm text-red-700 dark:text-red-300">
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {# Form #}
    <form action="/admin/network/vpn/{% if peer %}peers/{{ peer.id }}/edit{% else %}servers/{{ server.id }}/peers/new{% endif %}" method="POST" class="space-y-6">
        {% include "components/forms/csrf_input.html" %}

        {# Basic Settings #}
        <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 50ms;">
            <h3 class="mb-4 font-semibold text-slate-900 dark:text-white">Peer Identity</h3>
            <div class="grid gap-6 sm:grid-cols-2">
                <div class="sm:col-span-2">
                    <label for="name" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Peer Name *</label>
                    <input type="text" id="name" name="name" required maxlength="160"
                           value="{{ form_data.name if form_data else (peer.name if peer else '') }}"
                           class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                           placeholder="e.g., Router-Site-A or Monitoring-Device">
                </div>

                <div class="sm:col-span-2">
                    <label for="description" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Description</label>
                    <textarea id="description" name="description" rows="2"
                              class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                              placeholder="Optional description">{{ form_data.description if form_data else (peer.description if peer else '') }}</textarea>
                </div>
            </div>
        </div>

        {# Network Settings #}
        <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 150ms;">
            <h3 class="mb-4 font-semibold text-slate-900 dark:text-white">Network Settings</h3>
            <div class="grid gap-6 sm:grid-cols-2">
                <div>
                    <label for="peer_address" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Peer Address</label>
                    <input type="text" id="peer_address" name="peer_address"
                           value="{{ form_data.peer_address if form_data else (peer.peer_address if peer else '') }}"
                           class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                           placeholder="Auto-assigned if empty">
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Leave empty to auto-allocate from {{ server.vpn_address }}</p>
                </div>

                <div>
                    <label for="peer_address_v6" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Peer Address (IPv6)</label>
                    <input type="text" id="peer_address_v6" name="peer_address_v6"
                           value="{{ form_data.peer_address_v6 if form_data else (peer.peer_address_v6 if peer else '') }}"
                           class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                           placeholder="Auto-assigned if empty">
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Leave empty to auto-allocate from {{ server.vpn_address_v6 or 'IPv6 pool' }}</p>
                </div>

                <div>
                    <label for="persistent_keepalive" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Persistent Keepalive</label>
                    <input type="number" id="persistent_keepalive" name="persistent_keepalive" min="0" max="65535"
                           value="{{ form_data.persistent_keepalive if form_data else (peer.persistent_keepalive if peer else 25) }}"
                           class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Seconds between keepalives (0 to disable, 25 recommended for NAT)</p>
                </div>

                <div class="sm:col-span-2">
                    <label for="known_subnets" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Known Subnets (CIDR)</label>
                    <textarea id="known_subnets" name="known_subnets" rows="2"
                              class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                              placeholder="e.g., 172.20.100.0/24&#10;10.50.0.0/16">{{ form_data.known_subnets if form_data else (peer.metadata_.get('known_subnets') | join('\n') if peer and peer.metadata_ and peer.metadata_.get('known_subnets') else '') }}</textarea>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Used to auto-select routes when management IP is detected.</p>
                </div>

                <div class="sm:col-span-2">
                    <label for="lan_subnets" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">LAN Subnets (CIDR)</label>
                    <textarea id="lan_subnets" name="lan_subnets" rows="2"
                              class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                              placeholder="e.g., 172.16.10.0/24&#10;192.168.100.0/24">{{ form_data.lan_subnets if form_data else (peer.metadata_.get('lan_subnets') | join('\n') if peer and peer.metadata_ and peer.metadata_.get('lan_subnets') else '') }}</textarea>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Networks behind this peer for bidirectional routing through VPN.</p>
                </div>
            </div>
        </div>

        {% if not peer %}
        {# Security Options (only for new peers) #}
        <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 175ms;">
            <h3 class="mb-4 font-semibold text-slate-900 dark:text-white">Security Options</h3>
            <label class="flex items-start gap-3">
                <input type="checkbox" name="use_preshared_key" value="true" checked
                       class="mt-1 h-4 w-4 rounded border-slate-300 text-violet-600 focus:ring-violet-500 dark:border-slate-600">
                <div>
                    <span class="text-sm font-medium text-slate-900 dark:text-white">Generate Preshared Key</span>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Adds post-quantum security layer (recommended)</p>
                </div>
            </label>
        </div>
        {% endif %}

        {% if peer %}
        {# Status (only for existing peers) #}
        <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 175ms;">
            <h3 class="mb-4 font-semibold text-slate-900 dark:text-white">Peer Status</h3>
            <div class="flex items-center gap-4">
                <select id="status" name="status"
                        class="rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="active" {% if peer.status.value == 'active' %}selected{% endif %}>Active</option>
                    <option value="disabled" {% if peer.status.value == 'disabled' %}selected{% endif %}>Disabled</option>
                </select>
            </div>
        </div>
        {% endif %}

        {# Notes #}
        <div class="animate-fade-in-up rounded-2xl border border-slate-200/60 bg-white p-6 shadow-sm dark:border-slate-700/60 dark:bg-slate-800" style="animation-delay: 200ms;">
            <h3 class="mb-4 font-semibold text-slate-900 dark:text-white">Notes</h3>
            <textarea id="notes" name="notes" rows="3"
                      class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                      placeholder="Optional notes about this peer...">{{ form_data.notes if form_data else (peer.notes if peer else '') }}</textarea>
        </div>

        {# Actions #}
        <div class="animate-fade-in-up flex items-center justify-between" style="animation-delay: 250ms;">
            <a href="/admin/network/vpn?server_id={{ server.id }}" class="text-sm font-medium text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200">
                Cancel
            </a>
            <div class="flex items-center gap-3">
                {% if peer %}
                <button type="button" onclick="if(confirm('Are you sure you want to delete this peer?')) document.getElementById('delete-form').submit()" class="inline-flex items-center gap-2 rounded-xl border border-red-200 bg-white px-4 py-2.5 text-sm font-medium text-red-600 transition-all hover:bg-red-50 dark:border-red-800 dark:bg-slate-800 dark:text-red-400 dark:hover:bg-red-900/20">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete
                </button>
                {% endif %}
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-violet-500 to-purple-600 px-6 py-2.5 text-sm font-semibold text-white shadow-lg shadow-violet-500/25 transition-all hover:shadow-xl hover:shadow-violet-500/30">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    {{ 'Update Peer' if peer else 'Create Peer' }}
                </button>
            </div>
        </div>
    </form>

    {% if peer %}
    <form id="delete-form" action="/admin/network/vpn/peers/{{ peer.id }}/delete" method="POST" class="hidden">
        {% include "components/forms/csrf_input.html" %}
    </form>
    {% endif %}
</div>
{% endblock %}
