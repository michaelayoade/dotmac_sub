{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header %}

{% block title %}Network Weathermap - Admin{% endblock %}

{% block content %}
{{ ambient_background("teal", "cyan") }}

<div class="relative space-y-6">
    {% call page_header(
        title="Network Weathermap",
        subtitle="Real-time inter-device link utilization across core infrastructure",
        icon='<svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>',
        color="teal",
        color2="cyan"
    ) %}
        <a href="/admin/network/core-devices" class="inline-flex items-center gap-2 rounded-xl bg-teal-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-teal-700">
            View Core Devices
        </a>
    {% endcall %}

    <div class="grid gap-4 sm:grid-cols-5">
        <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Nodes</p>
            <p class="mt-1 text-3xl font-bold text-slate-900 dark:text-white">{{ stats.nodes }}</p>
        </div>
        <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Links</p>
            <p class="mt-1 text-3xl font-bold text-slate-900 dark:text-white">{{ stats.links }}</p>
        </div>
        <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Low</p>
            <p class="mt-1 text-3xl font-bold text-emerald-600 dark:text-emerald-400">{{ stats.low_links }}</p>
        </div>
        <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Moderate</p>
            <p class="mt-1 text-3xl font-bold text-amber-600 dark:text-amber-400">{{ stats.moderate_links }}</p>
        </div>
        <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">High</p>
            <p class="mt-1 text-3xl font-bold text-rose-600 dark:text-rose-400">{{ stats.high_links }}</p>
        </div>
    </div>

    <div class="rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
        <div class="mb-3 flex flex-wrap items-center gap-4 text-xs font-semibold uppercase tracking-wide">
            <span class="inline-flex items-center gap-2 text-emerald-700"><span class="h-2.5 w-8 rounded bg-emerald-500"></span>Low Utilization</span>
            <span class="inline-flex items-center gap-2 text-amber-700"><span class="h-2.5 w-8 rounded bg-amber-500"></span>Moderate Utilization</span>
            <span class="inline-flex items-center gap-2 text-rose-700"><span class="h-2.5 w-8 rounded bg-rose-500"></span>High Utilization</span>
            <span class="inline-flex items-center gap-2 text-slate-600"><span class="h-2.5 w-8 rounded bg-slate-400"></span>No Telemetry</span>
        </div>

        {% if nodes %}
        <div class="overflow-auto rounded-xl border border-slate-200 dark:border-slate-700">
            <div id="weathermap-canvas" class="relative min-h-[680px] min-w-[1400px] bg-gradient-to-br from-slate-50 to-cyan-50 dark:from-slate-900 dark:to-slate-800"></div>
        </div>
        {% else %}
        <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-6 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
            No active network devices found. Add core devices and telemetry to populate weathermap links.
        </div>
        {% endif %}
    </div>
</div>

{% if nodes %}
<script>
(() => {
    const nodes = {{ nodes | tojson }};
    const links = {{ links | tojson }};
    const container = document.getElementById('weathermap-canvas');
    if (!container) return;

    const NS = 'http://www.w3.org/2000/svg';
    const width = Math.max(...nodes.map(n => n.x), 1200) + 220;
    const height = Math.max(...nodes.map(n => n.y), 600) + 160;

    const svg = document.createElementNS(NS, 'svg');
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.classList.add('absolute', 'inset-0');

    function linkColor(state) {
        if (state === 'high') return '#e11d48';
        if (state === 'moderate') return '#d97706';
        if (state === 'low') return '#16a34a';
        return '#94a3b8';
    }

    function formatBps(value) {
        if (value === null || value === undefined) return 'n/a';
        const units = ['bps', 'Kbps', 'Mbps', 'Gbps', 'Tbps'];
        let v = Number(value);
        let u = 0;
        while (v >= 1000 && u < units.length - 1) { v /= 1000; u += 1; }
        return `${v.toFixed(v < 10 && u > 0 ? 2 : 1)} ${units[u]}`;
    }

    links.forEach((link) => {
        const line = document.createElementNS(NS, 'line');
        line.setAttribute('x1', link.sx + 70);
        line.setAttribute('y1', link.sy + 24);
        line.setAttribute('x2', link.tx);
        line.setAttribute('y2', link.ty + 24);
        line.setAttribute('stroke', linkColor(link.state));
        line.setAttribute('stroke-width', link.state === 'high' ? 5 : (link.state === 'moderate' ? 4 : 3));
        line.setAttribute('stroke-opacity', '0.92');

        const title = document.createElementNS(NS, 'title');
        title.textContent = `Link load: ${formatBps(link.total_bps)} (${link.state})`;
        line.appendChild(title);
        svg.appendChild(line);
    });

    container.appendChild(svg);

    nodes.forEach((node) => {
        const card = document.createElement('div');
        card.className = 'absolute w-[140px] rounded-lg border border-slate-200 bg-white/95 p-2 shadow-sm dark:border-slate-700 dark:bg-slate-900/95';
        card.style.left = `${node.x}px`;
        card.style.top = `${node.y}px`;

        const dotColor = node.status === 'online' ? 'bg-emerald-500' : (node.status === 'offline' ? 'bg-rose-500' : 'bg-amber-500');
        const stateColor = node.traffic_state === 'high' ? 'text-rose-600' : (node.traffic_state === 'moderate' ? 'text-amber-600' : (node.traffic_state === 'low' ? 'text-emerald-600' : 'text-slate-500'));

        card.innerHTML = `
            <div class="flex items-center justify-between gap-2">
                <div class="truncate text-[11px] font-semibold text-slate-900 dark:text-white" title="${node.name}">${node.name}</div>
                <span class="h-2 w-2 rounded-full ${dotColor}"></span>
            </div>
            <div class="mt-1 truncate text-[10px] text-slate-500" title="${node.pop_site || ''}">${node.pop_site || ''}</div>
            <div class="mt-1 text-[10px] ${stateColor}">Load: ${formatBps(node.total_bps)}</div>
        `;
        container.appendChild(card);
    });
})();
</script>
{% endif %}
{% endblock %}
