{% extends "layouts/admin.html" %}

{% block title %}{{ device.name }} - Backups - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between gap-4">
        <div>
            <a href="/admin/network/core-devices/{{ device.id }}" class="text-sm text-primary-600 hover:text-primary-700">Back to Device</a>
            <h1 class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">Device Backups: {{ device.name }}</h1>
        </div>
    </div>

    {% if message %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-900/40 dark:bg-emerald-900/20 dark:text-emerald-300">{{ message }}</div>
    {% endif %}
    {% if error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-300">{{ error }}</div>
    {% endif %}

    {% if nas_device %}
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <h2 class="font-semibold text-slate-900 dark:text-white">Backup Configuration</h2>
        </div>
        <div class="p-6">
            <form method="post" action="/admin/network/core-devices/{{ device.id }}/backups/settings" class="grid gap-3 lg:grid-cols-3">
                {% include "components/forms/csrf_input.html" %}
                <div class="lg:col-span-3">
                    <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                        <input type="checkbox" name="enabled" value="true" {% if backup_config.enabled %}checked{% endif %} class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500">
                        Enabled
                    </label>
                </div>
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">SSH login</label>
                    <input type="text" name="ssh_username" value="{{ backup_config.ssh_username }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">SSH password</label>
                    <input type="password" name="ssh_password" value="" placeholder="Leave empty to keep current" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">SSH port</label>
                    <input type="number" min="1" max="65535" name="ssh_port" value="{{ backup_config.ssh_port }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Backup type</label>
                    <select name="backup_type" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <option value="commands" {% if backup_config.backup_type == 'commands' %}selected{% endif %}>Commands</option>
                        <option value="scp" {% if backup_config.backup_type == 'scp' %}selected{% endif %}>SCP</option>
                        <option value="tftp" {% if backup_config.backup_type == 'tftp' %}selected{% endif %}>TFTP</option>
                    </select>
                </div>
                <div class="lg:col-span-2">
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Commands</label>
                    <input type="text" name="backup_commands" value="{{ backup_config.backup_commands }}" placeholder="export" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm font-mono dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Hours to backup at</label>
                    <input type="text" name="hours_csv" value="{{ backup_config.hours_csv }}" placeholder="2,8,14,20" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm font-mono dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <p class="mt-1 text-[11px] text-slate-500 dark:text-slate-400">Schedule: {{ backup_config.schedule or 'not set' }}</p>
                </div>
                <div class="lg:col-span-3 flex items-center gap-2">
                    <button type="submit" class="inline-flex items-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                <h2 class="font-semibold text-slate-900 dark:text-white">Backup History</h2>
                <div class="flex items-center gap-2">
                    <form method="post" action="/admin/network/core-devices/{{ device.id }}/backups/trigger">
                        {% include "components/forms/csrf_input.html" %}
                        <button type="submit" class="rounded-lg bg-slate-900 px-3 py-2 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-white">Trigger Backup</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="p-6 pt-4">
            <form method="get" class="mb-4 grid gap-3 sm:grid-cols-3">
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">From</label>
                    <input type="date" name="date_from" value="{{ date_from }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">To</label>
                    <input type="date" name="date_to" value="{{ date_to }}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div class="flex items-end gap-2">
                    <button type="submit" class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">Filter</button>
                    <a href="/admin/network/core-devices/{{ device.id }}/backups" class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">Reset</a>
                </div>
            </form>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm dark:divide-slate-700">
                    <thead class="bg-slate-50 dark:bg-slate-900/50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs uppercase text-slate-500">Compare</th>
                            <th class="px-3 py-2 text-left text-xs uppercase text-slate-500">Date</th>
                            <th class="px-3 py-2 text-left text-xs uppercase text-slate-500">Message</th>
                            <th class="px-3 py-2 text-right text-xs uppercase text-slate-500">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                        {% for backup in backups %}
                        <tr>
                            <td class="px-3 py-2"><input type="checkbox" class="backup-compare" value="{{ backup.id }}"></td>
                            <td class="px-3 py-2 text-slate-700 dark:text-slate-300">{{ backup.created_at.strftime('%Y-%m-%d %H:%M:%S') if backup.created_at else '-' }}</td>
                            <td class="px-3 py-2 text-slate-600 dark:text-slate-400">{{ (nas_device.management_ip or nas_device.ip_address or '-') }} | {{ backup.backup_method.value if backup.backup_method else 'manual' }} | {{ backup.config_size_bytes or 0 }} bytes</td>
                            <td class="px-3 py-2">
                                <div class="flex items-center justify-end gap-2">
                                    <a href="/admin/network/core-devices/{{ device.id }}/backups/{{ backup.id }}" class="rounded border border-slate-300 px-2 py-1 text-xs text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">View</a>
                                    <a href="/admin/network/core-devices/{{ device.id }}/backups/{{ backup.id }}/download" class="rounded border border-slate-300 px-2 py-1 text-xs text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">Download</a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-400">No backups found for selected range.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <button type="button" onclick="compareSelectedBackups('{{ device.id }}')" class="rounded-lg border border-primary-300 px-3 py-2 text-sm font-medium text-primary-700 hover:bg-primary-50 dark:border-primary-700 dark:text-primary-300 dark:hover:bg-primary-900/20">Compare Selected</button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function compareSelectedBackups(deviceId) {
    const checked = Array.from(document.querySelectorAll('.backup-compare:checked')).map(el => el.value);
    if (checked.length !== 2) {
        alert('Select exactly two backups to compare.');
        return;
    }
    const url = `/admin/network/core-devices/${deviceId}/backups/compare?backup_id_1=${checked[0]}&backup_id_2=${checked[1]}`;
    window.location.href = url;
}
</script>
{% endblock %}
