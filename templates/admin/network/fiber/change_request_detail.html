{% extends "layouts/admin.html" %}

{% block title %}Fiber Change Request - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
            <a href="/admin/network/fiber-change-requests" class="hover:text-primary-600">Fiber change requests</a>
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            <span class="text-slate-900 dark:text-white">{{ change_request.id }}</span>
        </nav>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Review change request</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Approve or reject vendor edits before they hit live assets.</p>
    </div>

    {% if error == "conflict" %}
    <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 dark:border-rose-700 dark:bg-rose-900/20 dark:text-rose-200">
        Conflict detected. Check "Apply despite conflict" to proceed.
    </div>
    {% elif error == "reject_note_required" %}
    <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 dark:border-rose-700 dark:bg-rose-900/20 dark:text-rose-200">
        Rejection requires a reason.
    </div>
    {% endif %}

    {% if conflict %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700 dark:border-amber-700 dark:bg-amber-900/20 dark:text-amber-300">
        Conflict detected: the live asset was updated after this request was created.
    </div>
    {% endif %}

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-6">
            <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Proposed changes</h2>
                <pre class="mt-3 overflow-auto rounded-lg bg-slate-900 p-4 text-xs text-slate-100">{{ change_request.payload | tojson(indent=2) }}</pre>
            </div>

            <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Live asset snapshot</h2>
                <pre class="mt-3 overflow-auto rounded-lg bg-slate-900 p-4 text-xs text-slate-100">{{ asset_data | tojson(indent=2) }}</pre>
            </div>
        </div>

        <div class="space-y-6">
            <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Request details</h2>
                <dl class="mt-4 space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <div class="flex justify-between">
                        <dt class="font-medium text-slate-500 dark:text-slate-400">Asset</dt>
                        <dd>{{ change_request.asset_type }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="font-medium text-slate-500 dark:text-slate-400">Operation</dt>
                        <dd>{{ change_request.operation.value }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="font-medium text-slate-500 dark:text-slate-400">Status</dt>
                        <dd>{{ change_request.status.value }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="font-medium text-slate-500 dark:text-slate-400">Requested By</dt>
                        <dd>{{ change_request.requested_by.first_name if change_request.requested_by else "-" }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="font-medium text-slate-500 dark:text-slate-400">Vendor</dt>
                        <dd>{{ change_request.requested_vendor.name if change_request.requested_vendor else "-" }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="font-medium text-slate-500 dark:text-slate-400">Submitted</dt>
                        <dd>{{ change_request.created_at.strftime("%Y-%m-%d %H:%M") if change_request.created_at else "-" }}</dd>
                    </div>
                </dl>
            </div>

            <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Recent Activity</h2>
                <div class="mt-4 divide-y divide-slate-200 dark:divide-slate-700">
                    {% if activities %}
                    {% for activity in activities %}
                    <div class="py-3">
                        <div class="text-sm text-slate-700 dark:text-slate-300">{{ activity.title }}</div>
                        {% if activity.description %}
                        <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">{{ activity.description }}</div>
                        {% endif %}
                        {% if activity.occurred_at %}
                        <div class="mt-1 text-xs text-slate-400 dark:text-slate-500">{{ activity.occurred_at.strftime('%b %d, %Y at %H:%M') }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="py-4 text-sm text-slate-500 dark:text-slate-400">No activity yet.</div>
                    {% endif %}
                </div>
            </div>

            {% if pending %}
            <form method="post" action="/admin/network/fiber-change-requests/{{ change_request.id }}/approve" class="rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800 dark:border-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-200">
                <h3 class="font-semibold">Approve</h3>
                <textarea name="review_notes" rows="3" class="mt-2 w-full rounded-lg border border-emerald-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-emerald-400 focus:outline-none dark:border-emerald-700 dark:bg-slate-900 dark:text-slate-200" placeholder="Optional approval notes"></textarea>
                {% if conflict %}
                <label class="mt-3 flex items-center gap-2 text-xs text-emerald-700 dark:text-emerald-200">
                    <input type="checkbox" name="force_apply" value="true" class="h-4 w-4 rounded border-emerald-300">
                    Apply despite conflict
                </label>
                {% endif %}
                <button type="submit" class="mt-3 inline-flex w-full items-center justify-center rounded-lg bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-700">Approve & Apply</button>
            </form>

            <form method="post" action="/admin/network/fiber-change-requests/{{ change_request.id }}/reject" class="rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-800 dark:border-rose-700 dark:bg-rose-900/20 dark:text-rose-200">
                <h3 class="font-semibold">Reject</h3>
                <textarea name="review_notes" rows="3" required class="mt-2 w-full rounded-lg border border-rose-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-rose-400 focus:outline-none dark:border-rose-700 dark:bg-slate-900 dark:text-slate-200" placeholder="Required rejection reason"></textarea>
                <button type="submit" class="mt-3 inline-flex w-full items-center justify-center rounded-lg bg-rose-600 px-3 py-2 text-sm font-medium text-white hover:bg-rose-700">Reject</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
