{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import status_badge %}

{% block title %}{{ pop_site.name }} - POP Site - Admin{% endblock %}

{% block head %}
{% if pop_site.latitude and pop_site.longitude %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #location-map { height: 200px; border-radius: 0.5rem; }
    #site-map { height: 420px; border-radius: 0.5rem; }
    .dark .leaflet-popup-content-wrapper { background: #1e293b; color: #f1f5f9; }
    .dark .leaflet-popup-tip { background: #1e293b; }
</style>
{% endif %}
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/network/pop-sites" class="hover:text-primary-600">POP Sites</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">{{ pop_site.name }}</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ pop_site.name }}</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">{{ pop_site.code or 'No site code' }}</p>
        </div>
        <div class="flex items-center gap-2">
            {% if pop_site.is_active %}
                {{ status_badge("Active", "active") }}
            {% else %}
                {{ status_badge("Inactive", "inactive") }}
            {% endif %}
            <a href="/admin/network/pop-sites/{{ pop_site.id }}/edit" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Edit
            </a>
        </div>
    </div>

    <div class="border-b border-slate-200 dark:border-slate-700">
        <nav class="flex gap-1" aria-label="Tabs">
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=information"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'information' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Information
            </a>
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=hardware"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'hardware' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Hardware
            </a>
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=customer-services"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'customer-services' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Customer Services
                <span class="ml-1 rounded bg-primary-100 px-1.5 py-0.5 text-xs text-primary-700 dark:bg-primary-900/30 dark:text-primary-400">{{ service_impact_count }}</span>
            </a>
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=map"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'map' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Map
            </a>
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=gallery"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'gallery' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Gallery
            </a>
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=documents"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'documents' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Documents
            </a>
            <a href="/admin/network/pop-sites/{{ pop_site.id }}?tab=contacts"
               class="border-b-2 px-4 py-3 text-sm font-medium transition-colors {% if active_tab == 'contacts' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}">
                Contacts
            </a>
        </nav>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            {% if active_tab == 'information' %}
            <!-- Site Info -->
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Site Information</h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Site Code</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white font-mono">{{ pop_site.code or '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Organization</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ pop_site.organization.name if pop_site.organization else '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Partner</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ pop_site.reseller.name if pop_site.reseller else '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Location Reference</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ pop_site.zone.name if pop_site.zone else '-' }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Devices</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">{{ devices | length }}</dd>
                        </div>
                        {% if pop_site.address_line1 %}
                        <div class="sm:col-span-2">
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Address</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white">
                                {{ pop_site.address_line1 }}{% if pop_site.address_line2 %}<br>{{ pop_site.address_line2 }}{% endif %}<br>
                                {{ pop_site.city or '' }}{% if pop_site.region %}, {{ pop_site.region }}{% endif %} {{ pop_site.postal_code or '' }}
                                {% if pop_site.country_code %}<br>{{ pop_site.country_code }}{% endif %}
                            </dd>
                        </div>
                        {% endif %}
                        {% if pop_site.latitude and pop_site.longitude %}
                        <div>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Coordinates</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white font-mono">{{ pop_site.latitude }}, {{ pop_site.longitude }}</dd>
                        </div>
                        {% endif %}
                        {% if pop_site.notes %}
                        <div class="sm:col-span-2">
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Notes</dt>
                            <dd class="mt-1 text-sm text-slate-900 dark:text-white whitespace-pre-wrap">{{ pop_site.notes }}</dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Wireless Masts -->
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-slate-900 dark:text-white">Wireless Masts</h2>
                        <a href="/admin/network/pop-sites/{{ pop_site.id }}/edit" class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400">+ Add Mast</a>
                    </div>
                </div>
                {% if masts %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Height</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Structure</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Owner</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                            {% for mast in masts %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">{{ mast.name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">{{ mast.status or '-' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                                    {% if mast.height_m is not none %}{{ "%.1f"|format(mast.height_m) }} m{% else %}-{% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">{{ mast.structure_type or '-' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">{{ mast.owner or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-6">
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18m7-9H5"/></svg>
                        <h3 class="mt-2 text-sm font-medium text-slate-900 dark:text-white">No masts</h3>
                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Add a mast from the POP site edit form.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if active_tab == 'hardware' %}
            <!-- Hardware at this site -->
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-slate-900 dark:text-white">Hardware</h2>
                        <a href="/admin/network/core-devices/new?pop_site_id={{ pop_site.id }}" class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400">+ Add Device</a>
                    </div>
                </div>
                {% if hardware_devices %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">IP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Ping</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">SNMP</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                            {% for device in hardware_devices %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <a href="{{ device.detail_url }}" class="text-sm font-medium text-primary-600 hover:text-primary-700">{{ device.name }}</a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">{{ device.device_type }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">{{ device.role }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-500 dark:text-slate-400">{{ device.ip }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium {% if device.status == 'Online' or device.status == 'Active' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400{% elif device.status == 'Offline' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400{% endif %}">
                                        <span class="h-1.5 w-1.5 rounded-full {% if device.status == 'Online' or device.status == 'Active' %}bg-green-500{% elif device.status == 'Offline' %}bg-red-500{% else %}bg-blue-500{% endif %}"></span>
                                        {{ device.status }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm {% if device.ping_status == 'OK' %}text-green-600 dark:text-green-400{% else %}text-amber-600 dark:text-amber-400{% endif %}">{{ device.ping_status }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">{{ device.snmp_status }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-6">
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                        <h3 class="mt-2 text-sm font-medium text-slate-900 dark:text-white">No devices</h3>
                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">No network devices are assigned to this site.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if active_tab == 'customer-services' %}
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Customer Services</h2>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Subscribers served by devices at this site.</p>
                </div>
                {% if customer_services %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Subscriber</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Service</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">Login/IP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider dark:text-slate-400">NAS</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                            {% for service in customer_services %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if service.subscriber_id %}
                                    <a href="/admin/customers/{{ service.subscriber_id }}" class="text-sm font-medium text-primary-600 hover:text-primary-700">{{ service.subscriber_name }}</a>
                                    {% else %}
                                    <span class="text-sm text-slate-700 dark:text-slate-300">{{ service.subscriber_name }}</span>
                                    {% endif %}
                                    <div class="text-xs text-slate-500 dark:text-slate-400">{{ service.subscriber_number or '-' }}</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">{{ service.service_description }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 dark:text-slate-300">{{ service.subscription_status }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-xs font-mono text-slate-600 dark:text-slate-300">{{ service.login }}</div>
                                    <div class="text-xs font-mono text-slate-500 dark:text-slate-400">{{ service.ipv4_address }}</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">{{ service.nas_name }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-6">
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5V4H2v16h5m10 0v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2m10 0H7m5-8a3 3 0 100-6 3 3 0 000 6z"/></svg>
                        <h3 class="mt-2 text-sm font-medium text-slate-900 dark:text-white">No linked customer services</h3>
                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">No active subscriber services are mapped to NAS devices at this site yet.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if active_tab == 'map' %}
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Site Map</h2>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                        POP location with nearby customer service and hardware markers.
                    </p>
                </div>
                <div class="p-6">
                    {% if pop_site.latitude and pop_site.longitude %}
                    <div id="site-map" class="rounded-lg"></div>
                    <div class="mt-3 flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400">
                        <span>Site: 1</span>
                        <span>Services: {{ map_markers | selectattr('type', 'equalto', 'service') | list | length }}</span>
                        <span>Hardware: {{ map_markers | selectattr('type', 'equalto', 'hardware') | list | length }}</span>
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 dark:text-slate-400">Set POP coordinates to enable the map tab.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if active_tab == 'gallery' %}
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Site Photo Gallery</h2>
                </div>
                <div class="p-6">
                    <form method="post" action="/admin/network/pop-sites/{{ pop_site.id }}/photos" enctype="multipart/form-data" class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center">
                        {% include "components/forms/csrf_input.html" %}
                        <input type="file" name="file" accept="image/*" required
                               class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                            Upload Photo
                        </button>
                    </form>
                    {% if photo_files %}
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        {% for photo in photo_files %}
                        <div class="overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700">
                            <a href="/admin/network/pop-sites/{{ pop_site.id }}/files/{{ photo.id }}/preview" target="_blank" rel="noopener">
                                <img src="/admin/network/pop-sites/{{ pop_site.id }}/files/{{ photo.id }}/preview"
                                     alt="{{ photo.original_filename }}"
                                     class="h-40 w-full object-cover">
                            </a>
                            <div class="space-y-2 p-3">
                                <p class="truncate text-xs text-slate-600 dark:text-slate-300">{{ photo.original_filename }}</p>
                                <div class="flex items-center justify-between">
                                    <a href="/admin/network/pop-sites/{{ pop_site.id }}/files/{{ photo.id }}/download"
                                       class="text-xs text-primary-600 hover:text-primary-700">Download</a>
                                    <form method="post" action="/admin/network/pop-sites/{{ pop_site.id }}/files/{{ photo.id }}/delete" onsubmit="return confirm('Delete this photo?');">
                                        {% include "components/forms/csrf_input.html" %}
                                        <input type="hidden" name="tab" value="gallery">
                                        <button type="submit" class="text-xs text-red-600 hover:text-red-700">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 dark:text-slate-400">No photos uploaded for this site yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if active_tab == 'documents' %}
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Site Documents</h2>
                </div>
                <div class="p-6">
                    <form method="post" action="/admin/network/pop-sites/{{ pop_site.id }}/documents" enctype="multipart/form-data" class="mb-6 grid grid-cols-1 gap-3 sm:grid-cols-4">
                        {% include "components/forms/csrf_input.html" %}
                        <select name="category" class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                            <option value="lease">Lease Agreement</option>
                            <option value="permit">Permit</option>
                            <option value="survey">Site Survey</option>
                            <option value="asbuilt">As-Built Drawing</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="file" name="file" required
                               class="sm:col-span-2 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                            Upload Document
                        </button>
                    </form>

                    {% if documents %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-900/50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase text-slate-500 dark:text-slate-400">File</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Category</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Uploaded</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                {% for doc in documents %}
                                <tr>
                                    <td class="px-4 py-3 text-sm text-slate-700 dark:text-slate-300">{{ doc.filename }}</td>
                                    <td class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">{{ doc.category_label }}</td>
                                    <td class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">{{ doc.created_at.strftime('%Y-%m-%d %H:%M') if doc.created_at else '-' }}</td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center justify-end gap-3">
                                            <a href="/admin/network/pop-sites/{{ pop_site.id }}/files/{{ doc.id }}/download" class="text-xs text-primary-600 hover:text-primary-700">Download</a>
                                            <form method="post" action="/admin/network/pop-sites/{{ pop_site.id }}/files/{{ doc.id }}/delete" onsubmit="return confirm('Delete this document?');">
                                                {% include "components/forms/csrf_input.html" %}
                                                <input type="hidden" name="tab" value="documents">
                                                <button type="submit" class="text-xs text-red-600 hover:text-red-700">Delete</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 dark:text-slate-400">No documents uploaded for this site yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if active_tab == 'contacts' %}
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Site Contacts</h2>
                </div>
                <div class="p-6">
                    <form method="post" action="/admin/network/pop-sites/{{ pop_site.id }}/contacts" class="mb-6 grid grid-cols-1 gap-3 sm:grid-cols-2">
                        {% include "components/forms/csrf_input.html" %}
                        <input type="text" name="name" required placeholder="Contact name"
                               class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <input type="text" name="role" placeholder="Role (e.g. Site Manager)"
                               class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <input type="text" name="phone" placeholder="Phone"
                               class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <input type="email" name="email" placeholder="Email"
                               class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <textarea name="notes" rows="2" placeholder="Notes"
                                  class="sm:col-span-2 rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white"></textarea>
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                            <input type="checkbox" name="is_primary" value="true" class="rounded border-slate-300 text-primary-600 focus:ring-primary-500">
                            Primary contact
                        </label>
                        <div class="sm:col-span-2">
                            <button type="submit" class="inline-flex items-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">Add Contact</button>
                        </div>
                    </form>

                    {% if contacts %}
                    <div class="space-y-3">
                        {% for contact in contacts %}
                        <div class="rounded-lg border border-slate-200 p-4 dark:border-slate-700">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">{{ contact.name }}</h3>
                                        {% if contact.is_primary %}
                                        <span class="rounded bg-emerald-100 px-2 py-0.5 text-xs text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">Primary</span>
                                        {% endif %}
                                    </div>
                                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">{{ contact.role or '-' }}</p>
                                    <p class="mt-1 text-sm text-slate-700 dark:text-slate-300">{{ contact.phone or '-' }}{% if contact.email %} Â· {{ contact.email }}{% endif %}</p>
                                    {% if contact.notes %}
                                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">{{ contact.notes }}</p>
                                    {% endif %}
                                </div>
                                <form method="post" action="/admin/network/pop-sites/{{ pop_site.id }}/contacts/{{ contact.id }}/delete" onsubmit="return confirm('Delete this contact?');">
                                    {% include "components/forms/csrf_input.html" %}
                                    <button type="submit" class="text-xs text-red-600 hover:text-red-700">Delete</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-slate-500 dark:text-slate-400">No contacts added for this site yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Quick Info -->
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Quick Info</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <p class="text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Site ID</p>
                        <p class="text-sm text-slate-900 dark:text-white font-mono">{{ pop_site.id | string | truncate(20, True, '...') }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Created</p>
                        <p class="text-sm text-slate-900 dark:text-white">{{ pop_site.created_at.strftime('%B %d, %Y') if pop_site.created_at else '-' }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Last Updated</p>
                        <p class="text-sm text-slate-900 dark:text-white">{{ pop_site.updated_at.strftime('%B %d, %Y') if pop_site.updated_at else '-' }}</p>
                    </div>
                </div>
            </div>

            <!-- Map Preview -->
            {% if pop_site.latitude and pop_site.longitude %}
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Location</h2>
                </div>
                <div class="p-6">
                    <div id="location-map" class="rounded-lg"></div>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400 text-center">{{ pop_site.latitude }}, {{ pop_site.longitude }}</p>
                </div>
            </div>
            {% endif %}

            <div class="rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <h2 class="font-semibold text-slate-900 dark:text-white">Recent Activity</h2>
                </div>
                <div class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% if activities %}
                    {% for activity in activities %}
                    <div class="px-6 py-4">
                        <div class="text-sm text-slate-700 dark:text-slate-300">{{ activity.title }}</div>
                        {% if activity.description %}
                        <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">{{ activity.description }}</div>
                        {% endif %}
                        {% if activity.occurred_at %}
                        <div class="mt-1 text-xs text-slate-400 dark:text-slate-500">{{ activity.occurred_at.strftime('%b %d, %Y at %H:%M') }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="px-6 py-6 text-sm text-slate-500 dark:text-slate-400">No activity yet.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if pop_site.latitude and pop_site.longitude %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    const lat = {{ pop_site.latitude }};
    const lng = {{ pop_site.longitude }};
    const popName = {{ pop_site.name | tojson | safe }};
    const popCode = {{ (pop_site.code or "") | tojson | safe }};

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function siteIcon() {
        return L.divIcon({
            html: '<div style="background:#2563eb;width:30px;height:30px;border-radius:9999px;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>',
            className: '',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
    }
    function serviceIcon() {
        return L.divIcon({
            html: '<div style="background:#0d9488;width:16px;height:16px;border-radius:9999px;border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.25)"></div>',
            className: '',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });
    }
    function hardwareIcon() {
        return L.divIcon({
            html: '<div style="background:#f59e0b;width:16px;height:16px;border-radius:4px;border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.25)"></div>',
            className: '',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });
    }

    const markers = {{ map_markers | tojson | safe }};

    function initMap(elementId, zoom) {
        const el = document.getElementById(elementId);
        if (!el) return;
        const map = L.map(elementId).setView([lat, lng], zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);

        const bounds = [];
        L.marker([lat, lng], { icon: siteIcon() })
            .addTo(map)
            .bindPopup(`<strong>${escapeHtml(popName)}</strong><br>${escapeHtml(popCode)}`);
        bounds.push([lat, lng]);

        markers.forEach((marker) => {
            const icon = marker.type === 'hardware' ? hardwareIcon() : serviceIcon();
            L.marker([marker.latitude, marker.longitude], { icon })
                .addTo(map)
                .bindPopup(
                    `<strong>${escapeHtml(marker.title || '')}</strong><br>${escapeHtml(marker.subtitle || '')}<br>${escapeHtml(marker.meta || '')}`
                );
            bounds.push([marker.latitude, marker.longitude]);
        });

        if (bounds.length > 1) {
            map.fitBounds(bounds, { padding: [30, 30] });
        }
    }

    initMap('location-map', 15);
    initMap('site-map', 14);
})();
</script>
{% endif %}
{% endblock %}
