{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, stats_card, card, data_table, table_head, table_row, row_actions, row_action, status_badge, empty_state, action_button, metric_row, step_indicator, icon_plus, icon_view, animation_styles %}

{% block title %}Provisioning - Admin{% endblock %}

{% block content %}
{{ ambient_background("amber", "orange") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% call page_header(
        title="Provisioning",
        subtitle="Service orders, appointments, and provisioning workflows",
        icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>',
        color="amber",
        color2="orange"
    ) %}
        <div class="flex items-center gap-3">
            {{ action_button("Appointments", "/admin/provisioning/appointments", '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>', "secondary", "slate") }}
            {{ action_button("New Order", "/admin/provisioning/orders/new", icon_plus(), "primary", "amber", "orange") }}
        </div>
    {% endcall %}

    {# KPI Cards #}
    {% if stats %}
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 animate-fade-in-up" style="animation-delay: 50ms;">
        {{ stats_card("Total Orders", stats.total, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>', color="slate", color2="gray") }}
        {{ stats_card("Pending", stats.pending, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="blue", color2="indigo") }}
        {{ stats_card("In Progress", stats.in_progress, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>', color="amber", color2="orange") }}
        {{ stats_card("Completed", stats.completed, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald", color2="teal") }}
    </div>
    {% endif %}

    {# Charts Row #}
    {% if stats and stats.chart_data %}
    <div class="grid gap-6 lg:grid-cols-2 animate-fade-in-up" style="animation-delay: 100ms;">
        {# Status Funnel #}
        {% call card("Order Status Distribution", color="amber") %}
        <div class="h-64">
            <canvas id="orderStatusChart"></canvas>
        </div>
        {% endcall %}

        {# Quick Stats + Failed/Canceled #}
        {% call card("Order Summary", color="blue") %}
        <div class="space-y-3">
            {{ metric_row("Draft + Submitted", stats.pending, color="blue") }}
            {{ metric_row("Scheduled + Provisioning", stats.in_progress, color="amber") }}
            {{ metric_row("Completed (Active)", stats.completed, color="emerald") }}
            {{ metric_row("Failed", stats.failed, color="rose") }}
            {{ metric_row("Canceled", stats.canceled, color="slate") }}
        </div>
        {% endcall %}
    </div>
    {% endif %}

    {# Filter Bar + Orders Table #}
    <div class="animate-fade-in-up" style="animation-delay: 150ms;">
    {% call card("Recent Service Orders", color="amber") %}
        {# Filter Bar #}
        <div class="mb-4">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                <select class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white sm:w-48"
                        hx-get="/admin/provisioning/orders"
                        hx-target="#orders-table"
                        hx-trigger="change"
                        hx-include="[name='search']"
                        name="status">
                    <option value="">All Statuses</option>
                    {% for s in statuses|default([]) %}
                    <option value="{{ s }}">{{ s|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="search" placeholder="Search orders..."
                       value=""
                       class="flex-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                       hx-get="/admin/provisioning/orders"
                       hx-target="#orders-table"
                       hx-trigger="keyup changed delay:300ms"
                       hx-include="[name='status']">
                <a href="/admin/provisioning/orders" class="text-sm font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">View All Orders</a>
            </div>
        </div>

        {# Orders Table #}
        <div id="orders-table">
            {% include "admin/provisioning/_table.html" %}
        </div>
    {% endcall %}
    </div>

    {# Quick Actions #}
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 animate-fade-in-up" style="animation-delay: 200ms;">
        <a href="/admin/provisioning/orders/new" class="group flex items-center gap-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-amber-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-800 dark:hover:border-amber-600">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 text-amber-600 group-hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-400">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-900 dark:text-white">New Order</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Create service order</p>
            </div>
        </a>
        <a href="/admin/provisioning/appointments" class="group flex items-center gap-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-blue-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-800 dark:hover:border-blue-600">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 text-blue-600 group-hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-400">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-900 dark:text-white">Appointments</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">View schedule</p>
            </div>
        </a>
        <a href="/admin/provisioning/workflows" class="group flex items-center gap-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-violet-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-800 dark:hover:border-violet-600">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-violet-100 text-violet-600 group-hover:bg-violet-200 dark:bg-violet-900/30 dark:text-violet-400">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-900 dark:text-white">Workflows</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Configure automation</p>
            </div>
        </a>
        <a href="/admin/provisioning/orders" class="group flex items-center gap-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-emerald-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-800 dark:hover:border-emerald-600">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-100 text-emerald-600 group-hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-900 dark:text-white">All Orders</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Full order list</p>
            </div>
        </a>
    </div>
</div>

{{ animation_styles() }}

{# Chart.js Scripts #}
{% if stats and stats.chart_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#cbd5e1' : '#64748b';
    const gridColor = isDark ? 'rgba(100,116,139,0.2)' : 'rgba(226,232,240,0.8)';

    const labels = {{ stats.chart_data["labels"] | tojson | safe }};
    const values = {{ stats.chart_data["values"] | tojson | safe }};
    const colors = {{ stats.chart_data["colors"] | tojson | safe }};

    if (values.some(v => v > 0)) {
        new Chart(document.getElementById('orderStatusChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Orders',
                    data: values,
                    backgroundColor: colors.map(c => c + (isDark ? 'cc' : '')),
                    borderColor: colors,
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: textColor }, grid: { display: false } },
                    y: { ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
