{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import status_badge %}

{% block title %}{{ customer_name }} - Customer - Admin{% endblock %}

{% block content %}
<div x-data="customerDetail()" class="space-y-6">
    {% if map_data %}
    <!-- Leaflet CSS for mini-map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
    <style>
        #customer-mini-map { height: 200px; }
    </style>
    {% endif %}
    <!-- Ambient Background -->
    <div class="fixed inset-0 pointer-events-none opacity-20 dark:opacity-15" aria-hidden="true">
        <div class="absolute inset-0 bg-gradient-to-br from-{% if customer_type == 'person' %}blue{% else %}purple{% endif %}-500/10 via-transparent to-amber-500/5"></div>
        <div class="absolute top-0 right-1/4 w-[600px] h-[600px] bg-{% if customer_type == 'person' %}blue{% else %}purple{% endif %}-500/10 rounded-full blur-3xl"></div>
    </div>

    <!-- Hero Header -->
    <header class="relative">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm mb-4">
            <a href="/admin/customers" class="text-slate-500 hover:text-amber-600 dark:text-slate-400 dark:hover:text-amber-400 transition">Customers</a>
            <svg class="h-4 w-4 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            <span class="text-slate-900 dark:text-white font-medium">{{ customer_name }}</span>
        </nav>

        <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
            <!-- Customer Identity -->
            <div class="flex items-start gap-5">
                <div class="relative">
                    {% if customer_type == 'person' %}
                    <div class="flex h-20 w-20 items-center justify-center rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-xl shadow-blue-500/30">
                        <svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </div>
                    {% else %}
                    <div class="flex h-20 w-20 items-center justify-center rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-xl shadow-purple-500/30">
                        <svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    </div>
                    {% endif %}
                    <!-- Status indicator -->
                    <span class="absolute -bottom-1 -right-1 flex h-6 w-6 items-center justify-center rounded-full ring-4 ring-white dark:ring-slate-900 {% if customer.is_active %}bg-indigo-500{% else %}bg-slate-400{% endif %}">
                        {% if customer.is_active %}
                        <svg class="h-3.5 w-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                        {% else %}
                        <svg class="h-3.5 w-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636"/></svg>
                        {% endif %}
                    </span>
                </div>
                <div>
                    <div class="flex flex-wrap items-center gap-3">
                        <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">{{ customer_name }}</h1>
                        {% if customer_type == 'person' %}
                        <span class="inline-flex items-center gap-1.5 rounded-lg bg-blue-50 px-2.5 py-1 text-xs font-semibold text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">
                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                            Individual
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1.5 rounded-lg bg-purple-50 px-2.5 py-1 text-xs font-semibold text-purple-700 dark:bg-purple-900/30 dark:text-purple-300">
                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg>
                            Organization
                        </span>
                        {% endif %}
                        {% if customer.is_active %}
                        {{ status_badge("Active", "active", size="sm") }}
                        {% else %}
                        {{ status_badge("Inactive", "inactive", size="sm") }}
                        {% endif %}
                    </div>
                    <div class="mt-2 flex flex-wrap items-center gap-4 text-sm text-slate-500 dark:text-slate-400">
                        {% if customer.email %}
                        <a href="mailto:{{ customer.email }}" class="flex items-center gap-1.5 hover:text-amber-600 dark:hover:text-amber-400 transition">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            {{ customer.email }}
                        </a>
                        {% endif %}
                        {% if customer.phone %}
                        <a href="tel:{{ customer.phone }}" class="flex items-center gap-1.5 hover:text-amber-600 dark:hover:text-amber-400 transition">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                            {{ customer.phone }}
                        </a>
                        {% endif %}
                        <span class="flex items-center gap-1.5">
                            {% set start_date = customer.account_start_date or customer.created_at %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Customer since {{ start_date.strftime('%B %Y') if start_date else 'N/A' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap items-center gap-2">
                {% set subscription_link = "/admin/catalog/subscriptions/new" %}
                {% if accounts and accounts|length == 1 %}
                    {% set subscription_link = "/admin/catalog/subscriptions/new?account_id=" ~ accounts[0].id %}
                {% endif %}
                <a href="{{ subscription_link }}"
                   class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-amber-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-amber-500/25 transition hover:from-amber-600 hover:to-amber-700 hover:shadow-amber-500/40">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    New Subscription
                </a>
                <a href="/admin/customers/{{ customer_type }}/{{ customer.id }}/edit"
                   class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    Edit
                </a>

                <!-- More Actions Dropdown -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open"
                            class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-transition x-cloak
                         class="absolute right-0 z-20 mt-2 w-56 rounded-xl border border-slate-200 bg-white py-2 shadow-xl dark:border-slate-700 dark:bg-slate-800">
                        <a href="/admin/billing/invoices/new?customer_id={{ customer.id }}&customer_type={{ customer_type }}" class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:hover:bg-slate-700">
                            <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Create Invoice
                        </a>
                        <div class="my-2 border-t border-slate-100 dark:border-slate-700"></div>
                        {% if customer.is_active %}
                        <button hx-post="/admin/customers/{{ customer_type }}/{{ customer.id }}/deactivate"
                                hx-confirm="Deactivate this customer?"
                                @click="open = false"
                                class="flex w-full items-center gap-2 px-4 py-2 text-sm text-amber-600 hover:bg-amber-50 dark:text-amber-400 dark:hover:bg-amber-900/20">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                            Deactivate Customer
                        </button>
                        {% elif not has_any_subscribers %}
                        <button hx-delete="/admin/customers/{{ customer_type }}/{{ customer.id }}"
                                hx-confirm="Delete this customer permanently? This action cannot be undone."
                                @click="open = false"
                                class="flex w-full items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            Delete Customer
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="border-b border-slate-200 dark:border-slate-700">
        <nav class="flex gap-6" aria-label="Tabs">
            <button @click="activeTab = 'overview'"
                    :class="activeTab === 'overview' ? 'border-amber-500 text-amber-600 dark:text-amber-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'"
                    class="flex items-center gap-2 border-b-2 px-1 py-3 text-sm font-medium transition">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                Overview
            </button>
            <button @click="activeTab = 'billing'"
                    :class="activeTab === 'billing' ? 'border-amber-500 text-amber-600 dark:text-amber-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'"
                    class="flex items-center gap-2 border-b-2 px-1 py-3 text-sm font-medium transition">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Billing
                {% if stats.balance_due and stats.balance_due > 0 %}
                <span class="ml-1 rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">Due</span>
                {% endif %}
            </button>
            <button @click="activeTab = 'subscriptions'"
                    :class="activeTab === 'subscriptions' ? 'border-amber-500 text-amber-600 dark:text-amber-400' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'"
                    class="flex items-center gap-2 border-b-2 px-1 py-3 text-sm font-medium transition">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                Subscriptions
                <span class="ml-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-400">{{ stats.total_subscriptions | default(0) }}</span>
            </button>
        </nav>
    </div>

    <!-- Tab Content: Overview -->
    <div x-show="activeTab === 'overview'" x-cloak class="space-y-6">
        <!-- Stats Grid with Visual Enhancements -->
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Active Services with Ring Progress -->
            <div class="group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm transition-all hover:shadow-md hover:border-indigo-200 dark:border-slate-700/60 dark:bg-slate-800 dark:hover:border-indigo-800">
                <div class="absolute -right-8 -top-8 h-24 w-24 rounded-full bg-gradient-to-br from-indigo-500/10 to-indigo-600/5 transition-transform duration-500 group-hover:scale-150"></div>
                <div class="relative flex items-start justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold uppercase tracking-wider text-indigo-600 dark:text-indigo-400">Active Services</p>
                        <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">{{ stats.active_subscriptions | default(0) }}</p>
                        {% set total_subs = stats.total_subscriptions | default(1) %}
                        {% set active_subs = stats.active_subscriptions | default(0) %}
                        {% set active_pct = ((active_subs / total_subs) * 100) if total_subs > 0 else 0 %}
                        <div class="mt-3 flex items-center gap-2">
                            <div class="flex-1 h-1.5 rounded-full bg-slate-100 dark:bg-slate-700 overflow-hidden">
                                <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-indigo-400 transition-all duration-700" style="width: {{ active_pct | int }}%"></div>
                            </div>
                            <span class="text-xs font-medium text-slate-500 dark:text-slate-400">{{ active_pct | int }}%</span>
                        </div>
                    </div>
                    <!-- Animated ring indicator -->
                    <div class="relative flex h-14 w-14 items-center justify-center">
                        <svg class="h-14 w-14 -rotate-90 transform" viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="15" fill="none" stroke="currentColor" stroke-width="3" class="text-indigo-100 dark:text-indigo-900/30"/>
                            <circle cx="18" cy="18" r="15" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="{{ (active_pct * 94.2) / 100 }}, 94.2" stroke-linecap="round" class="text-indigo-500 transition-all duration-1000"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <svg class="h-5 w-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Balance Due with Status Bar -->
            <div class="group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm transition-all hover:shadow-md hover:border-amber-200 dark:border-slate-700/60 dark:bg-slate-800 dark:hover:border-amber-800">
                <div class="absolute -right-8 -top-8 h-24 w-24 rounded-full bg-gradient-to-br from-amber-500/10 to-amber-600/5 transition-transform duration-500 group-hover:scale-150"></div>
                <div class="relative flex items-start justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold uppercase tracking-wider text-amber-600 dark:text-amber-400">Balance Due</p>
                        <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">₦{{ '{:,.0f}'.format(stats.balance_due | default(0)) }}</p>
                        {% set balance = stats.balance_due | default(0) %}
                        <div class="mt-3 flex items-center gap-2">
                            {% if balance == 0 %}
                            <span class="inline-flex items-center gap-1 rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700 dark:bg-green-900/30 dark:text-green-400">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Paid up
                            </span>
                            {% elif balance > 0 %}
                            <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 px-2 py-0.5 text-xs font-medium text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Outstanding
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 text-xs font-medium text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                Credit
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex h-14 w-14 items-center justify-center rounded-xl {% if balance == 0 %}bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400{% elif balance > 0 %}bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400{% else %}bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400{% endif %}">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Service Orders -->
            <div class="group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm transition-all hover:shadow-md hover:border-violet-200 dark:border-slate-700/60 dark:bg-slate-800 dark:hover:border-violet-800">
                <div class="absolute -right-8 -top-8 h-24 w-24 rounded-full bg-gradient-to-br from-violet-500/10 to-violet-600/5 transition-transform duration-500 group-hover:scale-150"></div>
                <div class="relative flex items-start justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold uppercase tracking-wider text-violet-600 dark:text-violet-400">Service Orders</p>
                        <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">{{ stats.service_orders | default(0) }}</p>
                        <div class="mt-3 flex items-center gap-1.5">
                            <span class="inline-flex items-center gap-1 rounded-full bg-violet-50 px-2 py-0.5 text-xs font-medium text-violet-700 dark:bg-violet-900/30 dark:text-violet-400">
                                Pending & In Progress
                            </span>
                        </div>
                    </div>
                    <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-violet-100 text-violet-600 dark:bg-violet-900/30 dark:text-violet-400">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                    </div>
                </div>
            </div>

            <!-- Monthly Revenue with Mini Trend Chart -->
            <div class="group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm transition-all hover:shadow-md hover:border-emerald-200 dark:border-slate-700/60 dark:bg-slate-800 dark:hover:border-emerald-800">
                <div class="absolute -right-8 -top-8 h-24 w-24 rounded-full bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 transition-transform duration-500 group-hover:scale-150"></div>
                <div class="relative flex items-start justify-between">
                    <div class="flex-1">
                        <p class="text-xs font-semibold uppercase tracking-wider text-emerald-600 dark:text-emerald-400">Monthly Revenue</p>
                        <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">₦{{ '{:,.0f}'.format(financials.monthly_recurring | default(0)) }}</p>
                        {% set mrr = financials.monthly_recurring | default(0) %}
                        <div class="mt-3 flex items-center gap-2">
                            <!-- Mini sparkline chart -->
                            <div class="flex items-end gap-0.5 h-4">
                                <div class="w-1 bg-emerald-200 dark:bg-emerald-800 rounded-t" style="height: 40%"></div>
                                <div class="w-1 bg-emerald-300 dark:bg-emerald-700 rounded-t" style="height: 60%"></div>
                                <div class="w-1 bg-emerald-200 dark:bg-emerald-800 rounded-t" style="height: 50%"></div>
                                <div class="w-1 bg-emerald-300 dark:bg-emerald-700 rounded-t" style="height: 75%"></div>
                                <div class="w-1 bg-emerald-400 dark:bg-emerald-600 rounded-t" style="height: 85%"></div>
                                <div class="w-1 bg-emerald-500 rounded-t" style="height: 100%"></div>
                            </div>
                            {% if mrr > 0 %}
                            <span class="inline-flex items-center gap-0.5 text-xs font-medium text-emerald-600 dark:text-emerald-400">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                                MRR
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid gap-6 lg:grid-cols-3">
            <!-- Left Column: Contact + Login As Customer -->
            <div class="space-y-6">
                <!-- Contact Information Card -->
                <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                    <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                        <h3 class="font-semibold text-slate-900 dark:text-white">Contact Information</h3>
                        <a href="/admin/customers/{{ customer_type }}/{{ customer.id }}/edit" class="text-xs font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">Edit</a>
                    </div>
                    <div class="p-5 space-y-4">
                        {% if customer_type == 'organization' %}
                        <div class="flex items-start gap-3">
                            <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-purple-50 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Organization</p>
                                <p class="text-sm font-medium text-slate-900 dark:text-white">{{ customer.name }}</p>
                            </div>
                        </div>
                        {% endif %}
                        <div class="flex items-start gap-3">
                            <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Email</p>
                                {% if customer.email %}
                                <a href="mailto:{{ customer.email }}" class="text-sm font-medium text-slate-900 hover:text-amber-600 dark:text-white dark:hover:text-amber-400 truncate block">{{ customer.email }}</a>
                                {% else %}
                                <p class="text-sm text-slate-400 dark:text-slate-500">Not provided</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Phone</p>
                                {% if customer.phone %}
                                <a href="tel:{{ customer.phone }}" class="text-sm font-medium text-slate-900 hover:text-amber-600 dark:text-white dark:hover:text-amber-400">{{ customer.phone }}</a>
                                {% else %}
                                <p class="text-sm text-slate-400 dark:text-slate-500">Not provided</p>
                                {% endif %}
                            </div>
                        </div>
                        {% if customer.address %}
                        <div class="flex items-start gap-3">
                            <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-slate-50 text-slate-600 dark:bg-slate-700 dark:text-slate-400">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Address</p>
                                <p class="text-sm text-slate-900 dark:text-white">{{ customer.address }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Location -->
                <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                    <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                        <div class="flex items-center gap-2">
                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </div>
                            <h3 class="font-semibold text-slate-900 dark:text-white">Location</h3>
                        </div>
                        {% if map_data %}
                        <a href="/admin/network/map" class="text-xs font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400">Full Map</a>
                        {% endif %}
                    </div>
                    {% if map_data %}
                    <div class="p-2">
                        <div id="customer-mini-map" class="rounded-xl overflow-hidden"></div>
                    </div>
                    <div class="px-5 pb-4 pt-2 text-xs text-slate-500 dark:text-slate-400">
                        <div id="customer-map-nearby-assets"></div>
                    </div>
                    {% elif geocode_target %}
                    <div class="p-5 space-y-3">
                        <div>
                            <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Address</p>
                            <p class="text-sm text-slate-900 dark:text-white">{{ geocode_target.address_line1 }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                {{ geocode_target.city | default('') }}{% if geocode_target.region %}, {{ geocode_target.region }}{% endif %} {{ geocode_target.postal_code or '' }}
                            </p>
                        </div>
                        <button type="button"
                                id="customer-geocode-btn"
                                data-address-id="{{ geocode_target.id }}"
                                data-address='{{ geocode_target.payload | tojson | safe }}'
                                class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-3 py-2 text-xs font-semibold text-white shadow-sm hover:bg-emerald-700">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Geocode address
                        </button>
                        <p id="customer-geocode-status" class="text-xs text-slate-500 dark:text-slate-400"></p>
                        <div id="customer-geocode-results" class="space-y-2"></div>
                    </div>
                    {% else %}
                    <div class="px-5 py-8 text-center">
                        <p class="text-sm text-slate-500 dark:text-slate-400">No address on file.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Login as Customer -->
                {% if accounts %}
                <div class="rounded-2xl border border-slate-200/60 bg-gradient-to-br from-slate-50 to-white shadow-sm dark:border-slate-700/60 dark:from-slate-800 dark:to-slate-800">
                    <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                        <div class="flex items-center gap-2">
                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"/></svg>
                            </div>
                            <h3 class="font-semibold text-slate-900 dark:text-white">Customer Portal</h3>
                        </div>
                    </div>
                    <form method="post" action="/admin/customers/{{ customer_type }}/{{ customer.id }}/impersonate" class="p-5 space-y-4">
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Account</label>
                            <select name="account_id" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 pl-3 pr-10 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                                {% for account in accounts %}
                                <option value="{{ account.id }}">
                                    {% if account.account_number %}{{ account.account_number }}{% elif account.subscriber and account.subscriber.person %}{{ account.subscriber.person.first_name }} {{ account.subscriber.person.last_name }}{% elif account.subscriber and account.subscriber.organization %}{{ account.subscriber.organization.name }}{% else %}Account{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-amber-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:from-amber-600 hover:to-amber-700">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                            Login as Customer
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>

            <!-- Center Column: Subscriber Accounts + Addresses -->
            <div class="space-y-6 lg:col-span-2">
                <!-- Subscriber Accounts -->
                <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                    <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                        <h3 class="font-semibold text-slate-900 dark:text-white">Subscriber Accounts</h3>
                        {% if customer_type == 'person' %}
                        <button type="button"
                                @click="openConvert('{{ customer.id }}', {{ customer_name | tojson }})"
                                class="inline-flex items-center gap-1 text-xs font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Convert
                        </button>
                        {% else %}
                        <a href="/admin/subscribers/new?{{ customer_type }}_id={{ customer.id }}" class="inline-flex items-center gap-1 text-xs font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add
                        </a>
                        {% endif %}
                    </div>
                    {% if subscribers %}
                    <div class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for subscriber in subscribers %}
                        <a href="/admin/subscribers/{{ subscriber.id }}" class="flex items-center justify-between px-5 py-4 transition hover:bg-slate-50 dark:hover:bg-slate-700/30">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-gradient-to-br from-blue-100 to-blue-50 text-blue-600 dark:from-blue-900/40 dark:to-blue-900/20 dark:text-blue-400">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                    </div>
                                    <span class="absolute -bottom-0.5 -right-0.5 h-3 w-3 rounded-full ring-2 ring-white dark:ring-slate-800 {% if subscriber.is_active %}bg-indigo-500{% else %}bg-slate-400{% endif %}"></span>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-slate-900 dark:text-white">
                                        {% if subscriber.person %}{{ subscriber.person.first_name }} {{ subscriber.person.last_name }}{% elif subscriber.organization %}{{ subscriber.organization.name }}{% else %}Subscriber{% endif %}
                                    </p>
                                    {% set sub_type = subscriber.subscriber_type.value if subscriber.subscriber_type is not string and subscriber.subscriber_type else (subscriber.subscriber_type | default('unknown')) %}
                                    <p class="text-xs text-slate-500 dark:text-slate-400">{{ sub_type | title }} subscriber</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                {% if subscriber.is_active %}
                                {{ status_badge("Active", "active", size="sm") }}
                                {% else %}
                                {{ status_badge("Inactive", "inactive", size="sm") }}
                                {% endif %}
                                <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="px-5 py-10 text-center">
                        <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-2xl bg-slate-100 dark:bg-slate-700">
                            <svg class="h-7 w-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </div>
                        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">No subscriber accounts linked.</p>
                        {% if customer_type == 'person' %}
                        <button type="button"
                                @click="openConvert('{{ customer.id }}', {{ customer_name | tojson }})"
                                class="mt-2 inline-flex items-center gap-1 text-sm font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400">
                            Convert to subscriber
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                        {% else %}
                        <a href="/admin/subscribers/new?{{ customer_type }}_id={{ customer.id }}" class="mt-2 inline-flex items-center gap-1 text-sm font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">
                            Create subscriber account
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Active Subscriptions Preview -->
                {% if subscriptions %}
                <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                    <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                        <h3 class="font-semibold text-slate-900 dark:text-white">Active Subscriptions</h3>
                        <button @click="activeTab = 'subscriptions'" class="text-xs font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">View all</button>
                    </div>
                    <div class="divide-y divide-slate-100 dark:divide-slate-700">
                        {% for subscription in subscriptions[:3] %}
                        {% set sub_status = subscription.status.value if subscription.status is not string and subscription.status else (subscription.status | default('pending')) %}
                        <div class="px-5 py-4">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start gap-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-xl {% if sub_status == 'active' %}bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400{% else %}bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ subscription.offer.name if subscription.offer else 'Subscription' }}</p>
                                        <div class="mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                                            {% if subscription.login %}
                                            <span class="flex items-center gap-1">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                                {{ subscription.login }}
                                            </span>
                                            {% endif %}
                                            {% if subscription.ipv4_address %}
                                            <span class="flex items-center gap-1">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                                                {{ subscription.ipv4_address }}
                                            </span>
                                            {% endif %}
                                            {% if subscription.ipv6_address %}
                                            <span class="flex items-center gap-1">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                                                {{ subscription.ipv6_address }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    {% if subscription.unit_price is not none %}
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">₦{{ '{:,.0f}'.format(subscription.unit_price) }}</p>
                                    <p class="text-xs text-slate-400">/month</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-violet-500/10 to-violet-600/20 text-violet-600 dark:text-violet-400">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h3 class="font-semibold text-slate-900 dark:text-white">Recent Activity</h3>
                </div>
            </div>
            <div class="relative p-5">
                <!-- Timeline connector line -->
                <div class="absolute left-[2.125rem] top-5 bottom-5 w-px bg-gradient-to-b from-slate-200 via-slate-200 to-transparent dark:from-slate-700 dark:via-slate-700"></div>

                <div class="space-y-4">
                    {% if activity_items %}
                    {% for activity in activity_items[:8] %}
                    <div class="relative flex gap-4">
                        <!-- Timeline dot -->
                        <div class="relative z-10 flex-shrink-0">
                            {% if activity.type == 'invoice' %}
                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-amber-100 text-amber-600 ring-4 ring-white dark:bg-amber-900/30 dark:text-amber-400 dark:ring-slate-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </div>
                            {% elif activity.type == 'payment' %}
                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-green-100 text-green-600 ring-4 ring-white dark:bg-green-900/30 dark:text-green-400 dark:ring-slate-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
                            </div>
                            {% elif activity.type == 'subscription' %}
                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-100 text-indigo-600 ring-4 ring-white dark:bg-indigo-900/30 dark:text-indigo-400 dark:ring-slate-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                            </div>
                            {% else %}
                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-100 text-slate-500 ring-4 ring-white dark:bg-slate-700 dark:text-slate-400 dark:ring-slate-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Activity content -->
                        <div class="flex-1 min-w-0 pt-1">
                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                <span class="font-medium text-slate-900 dark:text-white">{{ activity.title }}</span>
                                {% if activity.description %}<span class="text-slate-500 dark:text-slate-400"> - {{ activity.description }}</span>{% endif %}
                            </p>
                            <p class="mt-0.5 text-xs text-slate-400 dark:text-slate-500">
                                {{ activity.timestamp.strftime('%b %d, %Y at %I:%M %p') if activity.timestamp else 'Unknown time' }}
                                {% if activity.amount %}<span class="ml-2 font-medium text-slate-600 dark:text-slate-400">₦{{ '{:,.0f}'.format(activity.amount) }}</span>{% endif %}
                            </p>
                        </div>
                        {% if activity.link %}
                        <a href="{{ activity.link }}" class="flex-shrink-0 self-center text-slate-400 hover:text-amber-500 transition">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <!-- Demo/fallback timeline when no activity data -->
                    {% if invoices or payments %}
                    {% for invoice in invoices[:3] %}
                    <div class="relative flex gap-4">
                        <div class="relative z-10 flex-shrink-0">
                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-amber-100 text-amber-600 ring-4 ring-white dark:bg-amber-900/30 dark:text-amber-400 dark:ring-slate-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0 pt-1">
                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                <span class="font-medium text-slate-900 dark:text-white">Invoice {{ invoice.invoice_number | default('created') }}</span>
                                {% set inv_status = invoice.status.value if invoice.status is not string and invoice.status else (invoice.status | default('draft')) %}
                                <span class="text-slate-500 dark:text-slate-400"> - {{ inv_status | title }}</span>
                            </p>
                            <p class="mt-0.5 text-xs text-slate-400 dark:text-slate-500">
                                {{ invoice.created_at.strftime('%b %d, %Y at %I:%M %p') if invoice.created_at else 'Unknown' }}
                                {% set amount = invoice.total_amount if invoice.total_amount is defined and invoice.total_amount is not none else (invoice.total if invoice.total is not none else 0) %}
                                <span class="ml-2 font-medium text-slate-600 dark:text-slate-400">₦{{ '{:,.0f}'.format(amount) }}</span>
                            </p>
                        </div>
                        <a href="/admin/billing/invoices/{{ invoice.id }}" class="flex-shrink-0 self-center text-slate-400 hover:text-amber-500 transition">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    {% endfor %}
                    {% for payment in payments[:2] %}
                    <div class="relative flex gap-4">
                        <div class="relative z-10 flex-shrink-0">
                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-green-100 text-green-600 ring-4 ring-white dark:bg-green-900/30 dark:text-green-400 dark:ring-slate-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0 pt-1">
                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                <span class="font-medium text-slate-900 dark:text-white">Payment received</span>
                                {% set pay_status = payment.status.value if payment.status is not string and payment.status else (payment.status | default('pending')) %}
                                <span class="text-slate-500 dark:text-slate-400"> - {{ pay_status | title }}</span>
                            </p>
                            <p class="mt-0.5 text-xs text-slate-400 dark:text-slate-500">
                                {{ (payment.paid_at or payment.created_at).strftime('%b %d, %Y at %I:%M %p') if payment.paid_at or payment.created_at else 'Unknown' }}
                                <span class="ml-2 font-medium text-green-600 dark:text-green-400">₦{{ '{:,.0f}'.format(payment.amount | default(0)) }}</span>
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="flex flex-col items-center justify-center py-8 text-center">
                        <div class="flex h-14 w-14 items-center justify-center rounded-2xl bg-slate-100 dark:bg-slate-700">
                            <svg class="h-7 w-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">No recent activity</p>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Billing -->
    <div x-show="activeTab === 'billing'" x-cloak class="space-y-6">
        <!-- Billing Overview Cards -->
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Balance Due</p>
                <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(stats.balance_due | default(0)) }}</p>
            </div>
            <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Monthly Recurring</p>
                <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(financials.monthly_recurring | default(0)) }}</p>
            </div>
            <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Total Invoiced</p>
                <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(financials.total_invoiced | default(0)) }}</p>
            </div>
            <div class="rounded-2xl border border-slate-200/60 bg-white p-5 shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Total Paid</p>
                <p class="mt-2 text-3xl font-bold tabular-nums text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(financials.total_paid | default(0)) }}</p>
            </div>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
            <!-- Recent Invoices -->
            <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                    <h3 class="font-semibold text-slate-900 dark:text-white">Recent Invoices</h3>
                    <a href="/admin/billing/invoices" class="text-xs font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">View all</a>
                </div>
                {% if invoices %}
                <div class="divide-y divide-slate-100 dark:divide-slate-700">
                    {% for invoice in invoices[:5] %}
                    {% set status = invoice.status | default('draft') %}
                    {% set status_val = status.value if status is not string else status %}
                    <a href="/admin/billing/invoices/{{ invoice.id }}" class="flex items-center justify-between px-5 py-3 transition hover:bg-slate-50 dark:hover:bg-slate-700/30">
                        <div class="flex items-center gap-3">
                            <div class="flex h-9 w-9 items-center justify-center rounded-lg {% if status_val == 'paid' %}bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400{% elif status_val == 'overdue' %}bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400{% else %}bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400{% endif %}">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-900 dark:text-white">{{ invoice.invoice_number | default('Invoice') }}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">{{ invoice.created_at.strftime('%b %d, %Y') if invoice.created_at else 'N/A' }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            {% set amount = invoice.total_amount if invoice.total_amount is defined and invoice.total_amount is not none else (invoice.total if invoice.total is not none else 0) %}
                            <p class="text-sm font-semibold text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(amount) }}</p>
                            {% if status_val == 'paid' %}
                            <span class="text-xs text-green-600 dark:text-green-400">Paid</span>
                            {% elif status_val == 'overdue' %}
                            <span class="text-xs text-red-600 dark:text-red-400">Overdue</span>
                            {% else %}
                            <span class="text-xs text-amber-600 dark:text-amber-400">{{ status_val | title }}</span>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="px-5 py-10 text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400">No invoices found.</p>
                </div>
                {% endif %}
            </div>

            <!-- Recent Payments -->
            <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
                <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                    <h3 class="font-semibold text-slate-900 dark:text-white">Recent Payments</h3>
                    <a href="/admin/billing/payments" class="text-xs font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">View all</a>
                </div>
                {% if payments %}
                <div class="divide-y divide-slate-100 dark:divide-slate-700">
                    {% for payment in payments[:5] %}
                    {% set pay_status = payment.status.value if payment.status is not string and payment.status else (payment.status | default('pending')) %}
                    <div class="flex items-center justify-between px-5 py-3">
                        <div class="flex items-center gap-3">
                            <div class="flex h-9 w-9 items-center justify-center rounded-lg {% if pay_status == 'succeeded' %}bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400{% elif pay_status == 'failed' %}bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400{% else %}bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-900 dark:text-white">{{ (payment.id|string)[0:8] | upper }}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">{{ payment.paid_at.strftime('%b %d, %Y') if payment.paid_at else payment.created_at.strftime('%b %d, %Y') }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(payment.amount | default(0)) }}</p>
                            <span class="text-xs {% if pay_status == 'succeeded' %}text-green-600 dark:text-green-400{% elif pay_status == 'failed' %}text-red-600 dark:text-red-400{% else %}text-slate-500{% endif %}">{{ pay_status | title }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="px-5 py-10 text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400">No payments recorded.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab Content: Subscriptions -->
    <div x-show="activeTab === 'subscriptions'" x-cloak class="space-y-6">
        <div class="rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800">
            <div class="flex items-center justify-between border-b border-slate-100 px-5 py-4 dark:border-slate-700">
                <h3 class="font-semibold text-slate-900 dark:text-white">All Subscriptions</h3>
                {% set subscription_link = "/admin/catalog/subscriptions/new" %}
                {% if accounts and accounts|length == 1 %}
                    {% set subscription_link = "/admin/catalog/subscriptions/new?account_id=" ~ accounts[0].id %}
                {% endif %}
                <a href="{{ subscription_link }}" class="inline-flex items-center gap-1 text-xs font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400">
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Subscription
                </a>
            </div>
            {% if subscriptions %}
            <div class="divide-y divide-slate-100 dark:divide-slate-700">
                {% for subscription in subscriptions %}
                {% set sub_status = subscription.status.value if subscription.status is not string and subscription.status else (subscription.status | default('pending')) %}
                {% set account = account_lookup.get(subscription.account_id|string) %}
                <div class="px-5 py-4 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl {% if sub_status == 'active' %}bg-green-50 text-green-600 dark:bg-green-900/30 dark:text-green-400{% elif sub_status in ['pending', 'suspended'] %}bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400{% else %}bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                                {% if sub_status == 'active' %}
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                {% elif sub_status == 'suspended' %}
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                {% else %}
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                {% endif %}
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ subscription.offer.name if subscription.offer else 'Subscription' }}</p>
                                    {% if sub_status == 'active' %}
                                    {{ status_badge("Active", "active", size="sm") }}
                                    {% elif sub_status == 'suspended' %}
                                    <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 px-2 py-0.5 text-xs font-medium text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">Suspended</span>
                                    {% else %}
                                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-400">{{ sub_status | replace('_', ' ') | title }}</span>
                                    {% endif %}
                                </div>
                                <div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-xs text-slate-500 dark:text-slate-400">
                                    {% if account and account.account_number %}
                                    <span class="flex items-center gap-1">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Account: {{ account.account_number }}
                                    </span>
                                    {% endif %}
                                    {% if subscription.login %}
                                    <span class="flex items-center gap-1">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                        {{ subscription.login }}
                                    </span>
                                    {% endif %}
                                    {% if subscription.ipv4_address %}
                                    <span class="flex items-center gap-1">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                                        {{ subscription.ipv4_address }}
                                    </span>
                                    {% endif %}
                                    {% if subscription.ipv6_address %}
                                    <span class="flex items-center gap-1">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                                        {{ subscription.ipv6_address }}
                                    </span>
                                    {% endif %}
                                    {% if subscription.mac_address %}
                                    <span class="flex items-center gap-1">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                                        {{ subscription.mac_address }}
                                    </span>
                                    {% endif %}
                                    {% if subscription.next_billing_at %}
                                    <span class="flex items-center gap-1">
                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                        Next bill: {{ subscription.next_billing_at.strftime('%b %d, %Y') }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if subscription.unit_price is not none %}
                            <p class="text-lg font-bold text-slate-900 dark:text-white">₦{{ '{:,.2f}'.format(subscription.unit_price) }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">per month</p>
                            {% else %}
                            <p class="text-xs text-slate-400 dark:text-slate-500">Price not set</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="px-5 py-16 text-center">
                <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-2xl bg-slate-100 dark:bg-slate-700">
                    <svg class="h-8 w-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                </div>
                <p class="mt-4 text-sm font-medium text-slate-900 dark:text-white">No subscriptions</p>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">This customer doesn't have any subscriptions yet.</p>
                <a href="{{ subscription_link }}" class="mt-4 inline-flex items-center gap-2 rounded-xl bg-amber-500 px-4 py-2 text-sm font-semibold text-white hover:bg-amber-600">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Create Subscription
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Address Modal -->
    <div x-show="showAddressModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm"
         @click.self="showAddressModal = false">
        <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-800"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100">
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Add Address</h3>
                <button @click="showAddressModal = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <form hx-post="/admin/customers/addresses" hx-target="body" hx-swap="innerHTML">
                <input type="hidden" name="subscriber_id" value="{{ subscribers[0].id if subscribers else '' }}">
                <input type="hidden" name="customer_type" value="{{ customer_type }}">
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Type</label>
                            <select name="address_type" required class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 pl-3 pr-10 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                                <option value="service">Service</option>
                                <option value="billing">Billing</option>
                                <option value="mailing">Mailing</option>
                            </select>
                        </div>
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Label</label>
                            <input type="text" name="label" placeholder="e.g., Home, Office" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Address Line 1 <span class="text-red-500">*</span></label>
                        <input type="text" name="address_line1" required class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                    </div>
                    <div>
                        <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Address Line 2</label>
                        <input type="text" name="address_line2" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">City</label>
                            <input type="text" name="city" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                        </div>
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">State/Region</label>
                            <input type="text" name="region" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" name="is_primary" id="addr_primary" value="true" class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500">
                        <label for="addr_primary" class="text-sm text-slate-700 dark:text-slate-300">Set as primary address</label>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 border-t border-slate-200 bg-slate-50 px-6 py-4 dark:border-slate-700 dark:bg-slate-800/50">
                    <button type="button" @click="showAddressModal = false" class="rounded-lg px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 dark:text-slate-400">Cancel</button>
                    <button type="submit" class="rounded-xl bg-amber-500 px-4 py-2 text-sm font-semibold text-white hover:bg-amber-600">Add Address</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div x-show="showContactModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm"
         @click.self="showContactModal = false">
        <div class="w-full max-w-lg rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-800">
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Add Contact</h3>
                <button @click="showContactModal = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <form hx-post="/admin/customers/contacts" hx-target="body" hx-swap="innerHTML">
                <input type="hidden" name="account_id" value="{{ accounts[0].id if accounts else '' }}">
                <input type="hidden" name="customer_type" value="{{ customer_type }}">
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">First Name <span class="text-red-500">*</span></label>
                            <input type="text" name="first_name" required class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                        </div>
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Last Name <span class="text-red-500">*</span></label>
                            <input type="text" name="last_name" required class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Role</label>
                            <select name="role" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 pl-3 pr-10 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                                <option value="primary">Primary</option>
                                <option value="billing">Billing</option>
                                <option value="technical">Technical</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                        <div>
                            <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Title</label>
                            <input type="text" name="title" placeholder="e.g., IT Manager" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Email</label>
                        <input type="email" name="email" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                    </div>
                    <div>
                        <label class="mb-1.5 block text-xs font-medium text-slate-600 dark:text-slate-400">Phone</label>
                        <input type="tel" name="phone" class="block w-full rounded-xl border-0 bg-slate-100 py-2.5 px-3 text-sm text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:bg-white focus:ring-2 focus:ring-amber-500 dark:bg-slate-900 dark:text-white dark:ring-slate-700">
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" name="is_primary" id="contact_primary" value="true" class="h-4 w-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500">
                        <label for="contact_primary" class="text-sm text-slate-700 dark:text-slate-300">Set as primary contact</label>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 border-t border-slate-200 bg-slate-50 px-6 py-4 dark:border-slate-700 dark:bg-slate-800/50">
                    <button type="button" @click="showContactModal = false" class="rounded-lg px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 dark:text-slate-400">Cancel</button>
                    <button type="submit" class="rounded-xl bg-amber-500 px-4 py-2 text-sm font-semibold text-white hover:bg-amber-600">Add Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Animations for data visualizations */
@keyframes ringProgress {
    from { stroke-dashoffset: 94.2; }
    to { stroke-dashoffset: 0; }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Apply entrance animation to timeline items */
[x-show="activeTab === 'overview'"] .space-y-4 > div {
    animation: fadeInUp 0.4s ease-out backwards;
}

[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(1) { animation-delay: 0.1s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(2) { animation-delay: 0.15s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(3) { animation-delay: 0.2s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(4) { animation-delay: 0.25s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(5) { animation-delay: 0.3s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(6) { animation-delay: 0.35s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(7) { animation-delay: 0.4s; }
[x-show="activeTab === 'overview'"] .space-y-4 > div:nth-child(8) { animation-delay: 0.45s; }

/* Stats card hover effects */
.group:hover .transition-transform { transform: scale(1.5); }

/* Ring progress animation on load */
.group svg circle:last-child {
    animation: ringProgress 1.5s ease-out forwards;
}

/* Sparkline bar animation */
.flex.items-end.gap-0\.5 > div {
    animation: fadeInUp 0.6s ease-out backwards;
}
.flex.items-end.gap-0\.5 > div:nth-child(1) { animation-delay: 0.1s; }
.flex.items-end.gap-0\.5 > div:nth-child(2) { animation-delay: 0.15s; }
.flex.items-end.gap-0\.5 > div:nth-child(3) { animation-delay: 0.2s; }
.flex.items-end.gap-0\.5 > div:nth-child(4) { animation-delay: 0.25s; }
.flex.items-end.gap-0\.5 > div:nth-child(5) { animation-delay: 0.3s; }
.flex.items-end.gap-0\.5 > div:nth-child(6) { animation-delay: 0.35s; }
</style>

<!-- Convert Modal -->
<div x-show="convertOpen"
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="fixed inset-0 bg-slate-900/50" @click="convertOpen = false"></div>
    <div class="relative w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl dark:bg-slate-800">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Convert to Subscriber</h3>
            <button type="button" @click="convertOpen = false" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
            Create a subscriber and billing account for
            <span class="font-semibold text-slate-700 dark:text-slate-200" x-text="convertName"></span>.
        </p>

        <form method="post" :action="`/admin/contacts/${convertId}/convert`" class="mt-5 space-y-4">
            {% include "components/forms/csrf_input.html" %}
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Subscriber Type</label>
                <select name="subscriber_type"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="person">Individual</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Account Status</label>
                <select name="account_status"
                        class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="active" selected>Active</option>
                    <option value="delinquent">Delinquent</option>
                    <option value="suspended">Suspended</option>
                    <option value="canceled">Canceled</option>
                </select>
            </div>
            <div class="flex items-center justify-end gap-3 pt-2">
                <button type="button" @click="convertOpen = false" class="rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
                    Cancel
                </button>
                <button type="submit" class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
                    Convert & Create Account
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function customerDetail() {
    return {
        activeTab: 'overview',
        showAddressModal: false,
        showContactModal: false,
        convertOpen: false,
        convertId: null,
        convertName: "",

        openConvert(id, name) {
            this.convertId = id;
            this.convertName = name || "this customer";
            this.convertOpen = true;
        },

        init() {
            // Check URL hash for tab
            const hash = window.location.hash.slice(1);
            if (['overview', 'billing', 'subscriptions', 'support'].includes(hash)) {
                this.activeTab = hash;
            }

            // Update URL hash on tab change
            this.$watch('activeTab', (tab) => {
                window.location.hash = tab;
            });
        }
    };
}
</script>

{% if map_data %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    const mapData = {{ map_data | tojson | safe }};
    if (!mapData || !mapData.center) return;

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    const map = L.map('customer-mini-map', {
        zoomControl: false,
        attributionControl: false
    }).setView(mapData.center, 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    const icons = {
        customer: L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#10b981,#059669);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 4px 12px rgba(16,185,129,0.4)"><svg style="width:14px;height:14px;color:white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg></div>',
            className: '',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
        }),
        fdh_cabinet: L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 8px rgba(139,92,246,0.4)"><svg style="width:12px;height:12px;color:white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/></svg></div>',
            className: '',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
        }),
        splice_closure: L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#14b8a6,#0d9488);width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 6px rgba(20,184,166,0.4)"></div>',
            className: '',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
        })
    };

    const nearbyAssets = { fdh: [], closure: [] };

    if (mapData.geojson && mapData.geojson.features) {
        mapData.geojson.features.forEach(feature => {
            const p = feature.properties || {};
            const coords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            const icon = icons[p.type] || icons.customer;
            const marker = L.marker(coords, { icon: icon }).addTo(map);

            if (p.type === 'fdh_cabinet') {
                nearbyAssets.fdh.push({ name: p.name, distance: p.distance_m });
                marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${p.distance_m}m away`);
            } else if (p.type === 'splice_closure') {
                nearbyAssets.closure.push({ name: p.name, distance: p.distance_m });
                marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${p.distance_m}m away`);
            } else if (p.type === 'customer') {
                marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${escapeHtml(p.address)}`);
            }
        });
    }

    const summaryEl = document.getElementById('customer-map-nearby-assets');
    if (summaryEl) {
        let html = '';
        if (nearbyAssets.fdh.length > 0) {
            const nearest = nearbyAssets.fdh.sort((a, b) => a.distance - b.distance)[0];
            html += `<span class="inline-flex items-center gap-1.5 mr-3"><span class="h-2.5 w-2.5 rounded bg-gradient-to-r from-violet-500 to-purple-600"></span>Nearest FDH: ${escapeHtml(nearest.name)} (${nearest.distance}m)</span>`;
        }
        if (nearbyAssets.closure.length > 0) {
            html += `<span class="inline-flex items-center gap-1.5"><span class="h-2.5 w-2.5 rounded-full bg-gradient-to-r from-teal-500 to-emerald-500"></span>${nearbyAssets.closure.length} splice closure${nearbyAssets.closure.length > 1 ? 's' : ''} nearby</span>`;
        }
        if (!html) {
            html = '<span class="text-slate-400 dark:text-slate-500">No nearby infrastructure found</span>';
        }
        summaryEl.innerHTML = html;
    }
})();
</script>
{% endif %}

{% if geocode_target %}
<script>
(function() {
    const button = document.getElementById('customer-geocode-btn');
    const statusEl = document.getElementById('customer-geocode-status');
    const resultsEl = document.getElementById('customer-geocode-results');
    if (!button || !resultsEl || !statusEl) return;

    function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^|;\\s*)' + name + '=([^;]*)'));
        return match ? decodeURIComponent(match[2]) : '';
    }

    async function previewGeocode(payload) {
        const resp = await fetch('/api/v1/geocode/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCookie('csrf_token')
            },
            body: JSON.stringify(payload)
        });
        if (!resp.ok) {
            throw new Error('Geocode preview failed');
        }
        return resp.json();
    }

    async function persistSelection(addressId, latitude, longitude) {
        const resp = await fetch(`/admin/customers/addresses/${addressId}/geocode`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCookie('csrf_token')
            },
            body: JSON.stringify({ latitude, longitude })
        });
        if (!resp.ok) {
            throw new Error('Geocode save failed');
        }
        return resp.json();
    }

    button.addEventListener('click', async () => {
        const addressId = button.dataset.addressId;
        const payload = JSON.parse(button.dataset.address || '{}');
        if (!addressId || !payload.address_line1) return;

        button.disabled = true;
        statusEl.textContent = 'Searching for matches...';
        resultsEl.innerHTML = '';

        try {
            const results = await previewGeocode({ ...payload, limit: 3 });
            if (!results || results.length === 0) {
                statusEl.textContent = 'No results found.';
                return;
            }
            statusEl.textContent = 'Select a result to save:';
            resultsEl.innerHTML = results.map(result => {
                const label = result.display_name || `${result.latitude}, ${result.longitude}`;
                return `
                    <button type="button"
                        class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-left text-xs text-slate-700 hover:border-emerald-300 hover:bg-emerald-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-emerald-900/20"
                        data-lat="${result.latitude}" data-lng="${result.longitude}">
                        ${label}
                    </button>
                `;
            }).join('');
        } catch (err) {
            statusEl.textContent = 'Geocoding failed. Please try again.';
        } finally {
            button.disabled = false;
        }
    });

    resultsEl.addEventListener('click', async (event) => {
        const target = event.target.closest('[data-lat][data-lng]');
        if (!target) return;
        const addressId = button.dataset.addressId;
        const latitude = Number(target.dataset.lat);
        const longitude = Number(target.dataset.lng);
        if (!addressId || Number.isNaN(latitude) || Number.isNaN(longitude)) return;

        statusEl.textContent = 'Saving coordinates...';
        try {
            await persistSelection(addressId, latitude, longitude);
            window.location.reload();
        } catch (err) {
            statusEl.textContent = 'Failed to save coordinates.';
        }
    });
})();
</script>
{% endif %}
{% endblock %}
