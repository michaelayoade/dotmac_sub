{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import
    ambient_background, detail_header, card, info_grid, info_row,
    metric_row, timeline_item, table_head, status_badge,
    action_button, animation_styles,
    icon_edit, icon_invoice
%}

{% block title %}Invoice Detail - Admin{% endblock %}

{% block content %}
{{ ambient_background("emerald", "teal") }}

{% set status = invoice.status|default('draft') %}
{% set status_val = status.value if status is not string else status %}

<div class="relative space-y-6">
    {# ── Detail Header ── #}
    {% set status_html %}
        {% if status_val == 'paid' %}
        {{ status_badge("Paid", variant="paid") }}
        {% elif status_val in ['pending', 'sent'] %}
        {{ status_badge("Pending", variant="pending") }}
        {% elif status_val == 'overdue' %}
        {{ status_badge("Overdue", variant="overdue") }}
        {% else %}
        {{ status_badge(status_val | title, variant="draft") }}
        {% endif %}
    {% endset %}

    {% call detail_header(
        title="Invoice",
        subtitle="Invoice Number: " ~ (invoice.invoice_number | default('N/A')),
        icon=icon_invoice(),
        color="emerald",
        color2="teal",
        back_href="/admin/billing/invoices",
        back_label="Invoices",
        status=status_html
    ) %}
        {{ action_button("Edit", href="/admin/billing/invoices/" ~ invoice.id ~ "/edit", icon=icon_edit(), variant="secondary", color="emerald") }}
        {{ action_button("Download PDF", href="/admin/billing/invoices/" ~ invoice.id ~ "/pdf", icon='<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>', variant="secondary", color="emerald") }}
        {% if status_val in ['draft', 'pending'] %}
        {{ action_button("Send Invoice", href="#", icon='<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>', variant="primary", color="emerald", color2="teal") }}
        {% endif %}
    {% endcall %}

    {% if error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-200">
        {{ error }}
    </div>
    {% endif %}

    {% if pdf_notice == 'queued' %}
    <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 dark:border-emerald-900/40 dark:bg-emerald-900/20 dark:text-emerald-200">
        PDF generation queued. Refresh this page in a few seconds to download.
    </div>
    {% elif pdf_notice == 'processing' %}
    <div class="rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700 dark:border-blue-900/40 dark:bg-blue-900/20 dark:text-blue-200">
        PDF generation is already in progress.
    </div>
    {% elif pdf_notice == 'not_ready' %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700 dark:border-amber-900/40 dark:bg-amber-900/20 dark:text-amber-200">
        PDF is not ready yet. Please refresh and try again.
    </div>
    {% elif pdf_notice == 'failed' %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-200">
        PDF generation failed. Click Generate PDF to retry.
    </div>
    {% endif %}

    <div class="grid gap-6 lg:grid-cols-3">
        {# ── Left Column ── #}
        <div class="lg:col-span-2 space-y-6">
            {# Invoice Summary #}
            {% call card("Invoice Summary", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>', color="emerald") %}
                {% call info_grid() %}
                    {% call info_row("Billed To") %}
                        {% if invoice.account and invoice.account.subscriber %}
                            {% if invoice.account.subscriber.person %}
                                {{ invoice.account.subscriber.person.first_name }} {{ invoice.account.subscriber.person.last_name }}
                            {% elif invoice.account.subscriber.organization %}
                                {{ invoice.account.subscriber.organization.name }}
                            {% else %}
                                Account
                            {% endif %}
                        {% else %}
                            Account
                        {% endif %}
                        <br><span class="text-slate-500 dark:text-slate-400 text-xs">{{ invoice.account.email if invoice.account and invoice.account.email else 'No email on file' }}</span>
                    {% endcall %}
                    {% call info_row("Dates") %}
                        Issued: <span class="font-medium text-slate-900 dark:text-white">{{ invoice.issued_at.strftime('%b %d, %Y') if invoice.issued_at else 'N/A' }}</span><br>
                        Due: <span class="font-medium text-slate-900 dark:text-white">{{ invoice.due_at.strftime('%b %d, %Y') if invoice.due_at else 'N/A' }}</span>
                    {% endcall %}
                {% endcall %}

                <div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-4">
                    {{ metric_row("Subtotal", "₦" ~ '{:,.2f}'.format(invoice.subtotal or 0), color="slate", mono=True) }}
                    {{ metric_row("Tax", "₦" ~ '{:,.2f}'.format(invoice.tax_total or 0), color="slate", mono=True) }}
                    <div class="flex items-center justify-between py-2.5 mt-2">
                        <span class="text-base font-semibold text-slate-900 dark:text-white">Total</span>
                        <span class="text-base font-bold text-slate-900 dark:text-white font-mono tabular-nums">₦{{ '{:,.2f}'.format(invoice.total or 0) }}</span>
                    </div>
                </div>
            {% endcall %}

            {# Line Items #}
            {% call card("Line Items", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>', color="emerald", padding=False) %}
                <div class="border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                    <form method="post" action="/admin/billing/invoices/{{ invoice.id }}/lines" class="grid gap-3 sm:grid-cols-6">
                        {% include "components/forms/csrf_input.html" %}
                        <div class="sm:col-span-3">
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Description</label>
                            <input type="text" name="description" required
                                   class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        </div>
                        <div class="sm:col-span-1">
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Qty</label>
                            <input type="number" name="quantity" step="0.001" value="1" min="0.001" required
                                   class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        </div>
                        <div class="sm:col-span-1">
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Unit Price</label>
                            <input type="number" name="unit_price" step="0.01" value="0.00" min="0" required
                                   class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        </div>
                        <div class="sm:col-span-1">
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Tax Rate</label>
                            <select name="tax_rate_id"
                                    class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                                <option value="">None</option>
                                {% for rate in tax_rates %}
                                <option value="{{ rate.id }}">{{ rate.name }} ({{ (rate.rate * 100) | round(2) }}%)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="sm:col-span-6 flex justify-end">
                            <button type="submit"
                                    class="inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:shadow-md transition-all">
                                Add Line Item
                            </button>
                        </div>
                    </form>
                </div>
                {% set line_items = invoice.lines if invoice.lines is defined else (invoice.line_items if invoice.line_items is defined else (invoice.items if invoice.items is defined else [])) %}
                {% if line_items %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        {{ table_head([
                            {"label": "Description"},
                            {"label": "Qty"},
                            {"label": "Unit"},
                            {"label": "Amount", "align": "right"}
                        ]) }}
                        <tbody class="divide-y divide-slate-200 bg-white dark:divide-slate-700 dark:bg-slate-800">
                            {% for item in line_items %}
                            <tr>
                                <td class="px-6 py-4 text-sm text-slate-900 dark:text-white">{{ item.description | default('Service charge') }}</td>
                                <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">{{ item.quantity | default(1) }}</td>
                                <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400 font-mono tabular-nums">₦{{ '{:,.2f}'.format(item.unit_amount or item.unit_price or 0) }}</td>
                                <td class="px-6 py-4 text-right text-sm font-semibold text-slate-900 dark:text-white font-mono tabular-nums">₦{{ '{:,.2f}'.format(item.total_amount or item.amount or 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="px-6 py-12 text-center">
                    <svg class="mx-auto h-10 w-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">No line items recorded for this invoice.</p>
                </div>
                {% endif %}
            {% endcall %}
        </div>

        {# ── Right Column ── #}
        <div class="space-y-6">
            {# PDF Export #}
            {% call card("PDF Export", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>', color="emerald") %}
                {% set pdf_status = (pdf_export.status.value if pdf_export and pdf_export.status is not string else (pdf_export.status if pdf_export else 'not_generated')) %}
                <div class="mb-4">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Current status</p>
                    <p class="mt-1 text-base font-semibold text-slate-900 dark:text-white">
                        {% if pdf_status == 'completed' %}
                            Ready
                        {% elif pdf_status == 'processing' %}
                            Processing
                        {% elif pdf_status == 'queued' %}
                            Queued
                        {% elif pdf_status == 'failed' %}
                            Failed
                        {% else %}
                            Not generated
                        {% endif %}
                    </p>
                    {% if pdf_export and pdf_export.completed_at %}
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Updated {{ pdf_export.completed_at.strftime('%b %d, %Y %H:%M') }}</p>
                    {% endif %}
                </div>

                {% if pdf_status == 'completed' and pdf_export and pdf_export.file_path %}
                <a href="/admin/billing/invoices/{{ invoice.id }}/pdf/download" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition-all hover:shadow-xl hover:-translate-y-0.5">
                    Download PDF
                </a>
                {% elif pdf_status in ['queued', 'processing'] %}
                <a href="/admin/billing/invoices/{{ invoice.id }}/pdf" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">
                    Refresh PDF Status
                </a>
                {% else %}
                <a href="/admin/billing/invoices/{{ invoice.id }}/pdf" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition-all hover:shadow-xl hover:-translate-y-0.5">
                    Generate PDF
                </a>
                {% endif %}

                {% if pdf_status == 'failed' and pdf_export and pdf_export.error %}
                <p class="mt-3 text-xs text-red-600 dark:text-red-300">{{ pdf_export.error }}</p>
                {% endif %}
            {% endcall %}

            {# Payment Status #}
            {% call card("Payment Status", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>', color="emerald") %}
                {% set totals = namespace(paid=0, credit=0) %}
                {% if invoice.payments %}
                    {% for payment in invoice.payments %}
                        {% if payment.is_active %}
                            {% set pstatus = payment.status | default('pending') %}
                            {% set pstatus_val = pstatus.value if pstatus is not string else pstatus %}
                            {% if pstatus_val == 'succeeded' %}
                                {% set totals.paid = totals.paid + (payment.amount or 0) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if invoice.credit_note_applications %}
                    {% for application in invoice.credit_note_applications %}
                        {% set totals.credit = totals.credit + (application.amount or 0) %}
                    {% endfor %}
                {% endif %}

                <div class="mb-4">
                    <p class="text-2xl font-bold text-slate-900 dark:text-white font-mono tabular-nums">₦{{ '{:,.2f}'.format(invoice.balance_due or 0) }}</p>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Balance due</p>
                </div>
                {{ metric_row("Payments", "₦" ~ '{:,.2f}'.format(totals.paid), color="emerald", mono=True) }}
                {{ metric_row("Credits", "₦" ~ '{:,.2f}'.format(totals.credit), color="blue", mono=True) }}

                <div class="mt-4">
                    <a href="/admin/billing/payments/new?invoice={{ invoice.id }}" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition-all hover:shadow-xl hover:-translate-y-0.5">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                        Record Payment
                    </a>
                </div>
            {% endcall %}

            {# Recent Activity #}
            {% call card("Recent Activity", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald") %}
                {% if activities %}
                {% for activity in activities %}
                {{ timeline_item(
                    title=activity.title,
                    description=activity.description|default(''),
                    time=activity.occurred_at.strftime('%b %d, %Y at %H:%M') if activity.occurred_at else '',
                    color="emerald",
                    is_last=loop.last
                ) }}
                {% endfor %}
                {% else %}
                <p class="text-sm text-slate-500 dark:text-slate-400">No activity yet.</p>
                {% endif %}
            {% endcall %}

            {# Apply Credit #}
            {% call card("Apply Credit", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald") %}
                {% if credit_notes %}
                <form method="post" action="/admin/billing/invoices/{{ invoice.id }}/apply-credit" class="space-y-3">
                    {% include "components/forms/csrf_input.html" %}
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Credit Note</label>
                        <select name="credit_note_id" required
                                class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                            <option value="">Select credit note...</option>
                            {% for note in credit_notes %}
                                {% set available = (note.total or 0) - (note.applied_total or 0) %}
                                {% if available > 0 %}
                                <option value="{{ note.id }}">
                                    {{ note.credit_number | default('Credit Note') }} - ₦{{ '{:,.2f}'.format(available) }} available
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Amount (optional)</label>
                        <input type="number" name="amount" step="0.01" min="0"
                               placeholder="Leave blank to apply full available"
                               class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Memo (optional)</label>
                        <input type="text" name="memo"
                               class="block w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    </div>
                    <button type="submit"
                            class="inline-flex w-full items-center justify-center rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:shadow-md transition-all">
                        Apply Credit
                    </button>
                </form>
                {% else %}
                <p class="text-sm text-slate-500 dark:text-slate-400">No available credit notes for this account.</p>
                {% endif %}
            {% endcall %}

            {# Customer Notes #}
            {% call card("Customer Notes", icon='<svg class="h-4 w-4 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>', color="slate") %}
                <p class="text-sm text-slate-600 dark:text-slate-300">{{ invoice.notes | default('No notes added for this invoice.') }}</p>
            {% endcall %}
        </div>
    </div>
</div>

{{ animation_styles() }}
{% endblock %}
