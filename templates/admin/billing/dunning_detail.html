{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import
    ambient_background, detail_header, card, info_row, info_grid,
    status_badge, table_head, table_row, empty_state,
    timeline_item, animation_styles
%}

{% block title %}Dunning Case - Admin{% endblock %}

{% block content %}
{{ ambient_background("emerald", "teal") }}

{% set status_val = case.status.value %}
{% set status_variants = {
    'open': 'error',
    'paused': 'warning',
    'resolved': 'success',
    'closed': 'inactive'
} %}
{% set status_html %}{{ status_badge(status_val | capitalize, variant=status_variants.get(status_val, 'default')) }}{% endset %}

<div class="relative space-y-6">
    {# ── Detail Header ── #}
    {% call(content) detail_header(
        title="Dunning Case",
        icon='<svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        color="emerald",
        color2="teal",
        back_href="/admin/billing/dunning",
        back_label="Dunning",
        status=status_html
    ) %}
        {% if case.status.value == 'open' %}
        <button
            hx-post="/admin/billing/dunning/{{ case.id }}/pause"
            hx-swap="none"
            class="inline-flex items-center gap-2 rounded-lg border border-amber-300 bg-amber-50 px-4 py-2 text-sm font-medium text-amber-700 hover:bg-amber-100 dark:border-amber-600 dark:bg-amber-900/20 dark:text-amber-400 dark:hover:bg-amber-900/40"
        >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Pause Case
        </button>
        {% elif case.status.value == 'paused' %}
        <button
            hx-post="/admin/billing/dunning/{{ case.id }}/resume"
            hx-swap="none"
            class="inline-flex items-center gap-2 rounded-lg border border-green-300 bg-green-50 px-4 py-2 text-sm font-medium text-green-700 hover:bg-green-100 dark:border-green-600 dark:bg-green-900/20 dark:text-green-400 dark:hover:bg-green-900/40"
        >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Resume Case
        </button>
        {% endif %}
        {% if case.status.value not in ['closed', 'resolved'] %}
        <button
            hx-post="/admin/billing/dunning/{{ case.id }}/close"
            hx-swap="none"
            hx-confirm="Are you sure you want to close this case? This action cannot be undone."
            class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
        >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Close Case
        </button>
        {% endif %}
    {% endcall %}

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        {# ── Main Content ── #}
        <div class="lg:col-span-2 space-y-6">
            {# Case Status Card #}
            {% call card("Case Status", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald") %}
                {% call info_grid() %}
                    {{ info_row("Current Step", ("Day " ~ case.current_step) if case.current_step is not none else "-") }}
                    {{ info_row("Started", case.started_at.strftime('%b %d, %Y %H:%M') if case.started_at else 'N/A') }}
                    {{ info_row("Resolved", case.resolved_at.strftime('%b %d, %Y %H:%M') if case.resolved_at else '-') }}
                    {{ info_row("Policy Set", case.policy_set.name if case.policy_set else '-') }}
                {% endcall %}
            {% endcall %}

            {# Action History #}
            {% call card("Action History", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald") %}
                {% if actions %}
                {% set action_icons = {
                    'notify': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>',
                    'suspend': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>',
                    'throttle': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>',
                    'reject': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
                } %}
                {% set action_colors = {
                    'notify': 'blue',
                    'suspend': 'rose',
                    'throttle': 'amber',
                    'reject': 'slate'
                } %}
                {% for action in actions %}
                    {% set color = action_colors.get(action.action.value, 'slate') %}
                    {{ timeline_item(
                        title=(action.action.value | capitalize) ~ (" - Day " ~ action.step_day if action.step_day is not none else ""),
                        description=((("Outcome: " ~ action.outcome) if action.outcome else "") ~ (("\n" ~ action.notes) if action.notes else "")) or "",
                        time=action.executed_at.strftime('%b %d, %Y %H:%M') if action.executed_at else '',
                        color=color,
                        is_last=loop.last
                    ) }}
                {% endfor %}
                {% else %}
                <p class="py-4 text-center text-sm text-slate-500 dark:text-slate-400">No actions recorded yet</p>
                {% endif %}
            {% endcall %}

            {# Overdue Invoices #}
            {% call card("Overdue Invoices", icon='<svg class="h-4 w-4 text-rose-600 dark:text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>', color="rose", padding=False) %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        {{ table_head([
                            {"label": "Invoice"},
                            {"label": "Due Date"},
                            {"label": "Balance", "align": "right"}
                        ]) }}
                        <tbody class="divide-y divide-slate-100 bg-white dark:divide-slate-700/50 dark:bg-slate-800">
                            {% if invoices %}
                            {% for invoice in invoices %}
                            {% call table_row(color="emerald") %}
                                <td class="whitespace-nowrap px-6 py-4">
                                    <a href="/admin/billing/invoices/{{ invoice.id }}" class="font-semibold text-slate-900 hover:text-amber-600 dark:text-white dark:hover:text-amber-400 transition-colors">
                                        {{ invoice.invoice_number or invoice.id | string | truncate(12, True, '') }}
                                    </a>
                                </td>
                                <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                                    {{ invoice.due_at.strftime('%b %d, %Y') if invoice.due_at else 'N/A' }}
                                </td>
                                <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-bold text-slate-900 dark:text-white font-mono tabular-nums">
                                    {{ invoice.currency }} {{ '{:,.2f}'.format(invoice.balance_due or 0) }}
                                </td>
                            {% endcall %}
                            {% endfor %}
                            {% else %}
                            {{ empty_state(
                                title="No overdue invoices",
                                message="No overdue invoices associated with this case",
                                icon='<svg class="h-8 w-8 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
                                color="emerald",
                                colspan=3
                            ) }}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            {% endcall %}
        </div>

        {# ── Sidebar ── #}
        <div class="space-y-6">
            {# Account Info #}
            {% call card("Account", icon='<svg class="h-4 w-4 text-violet-600 dark:text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>', color="violet") %}
                {% if account %}
                <div class="space-y-3">
                    <div>
                        <a href="/admin/billing/accounts/{{ account.id }}" class="text-sm font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">
                            {% if account.subscriber and account.subscriber.person %}
                                {{ account.subscriber.person.display_name or account.subscriber.person.first_name }}
                            {% else %}
                                {{ account.account_number or (account.id | string | truncate(12, True, '')) }}
                            {% endif %}
                        </a>
                    </div>
                    {% if account.account_number %}
                    <div class="text-sm text-slate-500 dark:text-slate-400">
                        Account #{{ account.account_number }}
                    </div>
                    {% endif %}
                    <div class="flex items-center gap-2">
                        {% set acct_status = account.status.value %}
                        {% set acct_variants = {
                            'active': 'active',
                            'suspended': 'error',
                            'canceled': 'inactive',
                            'delinquent': 'warning'
                        } %}
                        {{ status_badge(acct_status | capitalize, variant=acct_variants.get(acct_status, 'default')) }}
                    </div>
                    {% if account.subscriber and account.subscriber.person %}
                    <div class="pt-2 border-t border-slate-200 dark:border-slate-700">
                        {% if account.subscriber.person.email %}
                        <p class="text-sm text-slate-500 dark:text-slate-400">{{ account.subscriber.person.email }}</p>
                        {% endif %}
                        {% if account.subscriber.person.phone %}
                        <p class="text-sm text-slate-500 dark:text-slate-400">{{ account.subscriber.person.phone }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-sm text-slate-500 dark:text-slate-400">Account not found</p>
                {% endif %}
            {% endcall %}

            {# Notes #}
            {% call card("Notes", icon='<svg class="h-4 w-4 text-slate-600 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>', color="slate") %}
                {% if case.notes %}
                <div class="text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap">{{ case.notes }}</div>
                {% else %}
                <p class="text-sm text-slate-500 dark:text-slate-400 italic">No notes added</p>
                {% endif %}
                <form hx-post="/admin/billing/dunning/{{ case.id }}/notes" hx-swap="none" class="mt-4">
                    {% include "components/forms/csrf_input.html" %}
                    <textarea
                        name="note"
                        rows="3"
                        placeholder="Add a note..."
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-500"
                    ></textarea>
                    <button
                        type="submit"
                        class="mt-2 w-full rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700"
                    >
                        Add Note
                    </button>
                </form>
            {% endcall %}

            {# Quick Links #}
            {% call card("Quick Links", icon='<svg class="h-4 w-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>', color="blue") %}
                <div class="space-y-2">
                    <a href="/admin/billing/accounts/{{ case.account_id }}" class="flex items-center gap-2 text-sm text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        View Account
                    </a>
                    <a href="/admin/billing/invoices?account_id={{ case.account_id }}" class="flex items-center gap-2 text-sm text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        All Invoices
                    </a>
                    <a href="/admin/billing/payments/new?account_id={{ case.account_id }}" class="flex items-center gap-2 text-sm text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        Record Payment
                    </a>
                </div>
            {% endcall %}
        </div>
    </div>
</div>

{{ animation_styles() }}
{% endblock %}
