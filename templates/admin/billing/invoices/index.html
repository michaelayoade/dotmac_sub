{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import
    ambient_background, page_header, stats_card, card, table_head, table_row,
    status_badge, empty_state, animation_styles
%}

{% set inv_status_variants = {
    'paid': 'paid',
    'overdue': 'overdue',
    'issued': 'info',
    'partially_paid': 'pending',
    'draft': 'draft',
    'void': 'inactive'
} %}

{% block title %}Invoices - Admin{% endblock %}

{% block content %}
{{ ambient_background("emerald", "teal") }}

<div class="relative space-y-6">
    {# ── Page Header ── #}
    {% call(content) page_header(
        title="Invoices",
        subtitle="Manage billing and invoices",
        icon='<svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        color="emerald",
        color2="teal",
        breadcrumbs=[
            {"label": "Billing", "href": "/admin/billing"},
            {"label": "Invoices"}
        ]
    ) %}
        <button type="button"
                hx-post="/admin/billing/invoices/generate-batch"
                hx-confirm="Generate invoices for all subscribers with upcoming billing dates?"
                class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Generate Batch
        </button>
        <a href="/admin/billing/invoices/create"
           class="group inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition-all hover:shadow-xl hover:shadow-emerald-500/30 hover:-translate-y-0.5">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            New Invoice
        </a>
    {% endcall %}

    {# ── Summary Cards ── #}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {{ stats_card("Total Outstanding", "₦" ~ "%.2f" | format(stats.total_outstanding),
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            color="amber", color2="orange"
        ) }}
        {{ stats_card("Overdue", "₦" ~ "%.2f" | format(stats.total_overdue),
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
            color="red", color2="rose"
        ) }}
        {{ stats_card("Paid This Month", "₦" ~ "%.2f" | format(stats.paid_this_month),
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            color="emerald", color2="green"
        ) }}
        {{ stats_card("Draft", stats.draft_count,
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>',
            color="slate"
        ) }}
    </div>

    {# ── Filters & Search ── #}
    {% call card(color="emerald") %}
        <div class="flex flex-col lg:flex-row gap-4">
            <div class="flex-1">
                <div class="relative">
                    <input type="text" name="search"
                           placeholder="Search by invoice #, subscriber name..."
                           hx-get="/admin/billing/invoices/search"
                           hx-trigger="input changed delay:300ms"
                           hx-target="#invoices-table-body"
                           class="block w-full rounded-lg border border-slate-300 bg-white pl-10 pr-4 py-2 text-sm shadow-sm placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white dark:placeholder-slate-500" />
                    <svg class="absolute left-3 top-2.5 h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <select name="status"
                        hx-get="/admin/billing/invoices/filter"
                        hx-trigger="change"
                        hx-target="#invoices-table-body"
                        class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <option value="">All Status</option>
                    <option value="draft">Draft</option>
                    <option value="issued">Issued</option>
                    <option value="partially_paid">Partially Paid</option>
                    <option value="paid">Paid</option>
                    <option value="overdue">Overdue</option>
                    <option value="void">Void</option>
                </select>
                <input type="date" name="date_from"
                       hx-get="/admin/billing/invoices/filter"
                       hx-trigger="change"
                       hx-target="#invoices-table-body"
                       class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <input type="date" name="date_to"
                       hx-get="/admin/billing/invoices/filter"
                       hx-trigger="change"
                       hx-target="#invoices-table-body"
                       class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
            </div>
        </div>
    {% endcall %}

    {# ── Invoices Table ── #}
    {% call card(color="emerald", padding=False) %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                {{ table_head([
                    {"label": "Invoice"},
                    {"label": "Subscriber"},
                    {"label": "Amount"},
                    {"label": "Status"},
                    {"label": "Due Date"},
                    {"label": "Created"},
                    {"label": "Actions", "align": "right"}
                ]) }}
                <tbody id="invoices-table-body" class="divide-y divide-slate-100 bg-white dark:divide-slate-700/50 dark:bg-slate-800">
                    {% for invoice in invoices %}
                    {% call table_row(color="emerald") %}
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="/admin/billing/invoices/{{ invoice.id }}" class="text-sm font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400">
                                #{{ invoice.number }}
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="/admin/subscribers/{{ invoice.subscriber.id }}" class="text-sm text-slate-900 hover:text-emerald-600 dark:text-white dark:hover:text-emerald-400">
                                {{ invoice.subscriber.name }}
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-slate-900 dark:text-white">₦{{ "%.2f" | format(invoice.total or 0) }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ status_badge(invoice.status | replace('_', ' ') | title, variant=inv_status_variants.get(invoice.status, 'default')) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                            {{ invoice.due_date.strftime('%b %d, %Y') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                            {{ invoice.created_at.strftime('%b %d, %Y') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <div x-data="{ open: false }" class="relative">
                                <button x-on:click="open = !open"
                                        aria-label="Invoice actions"
                                        :aria-expanded="open.toString()"
                                        aria-controls="invoice-actions-{{ invoice.id }}"
                                        class="rounded p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:hover:bg-slate-700 dark:hover:text-slate-300">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
                                </button>
                                <div x-show="open" x-on:click.outside="open = false" x-transition
                                     id="invoice-actions-{{ invoice.id }}" role="menu"
                                     class="absolute right-0 z-10 mt-1 w-48 rounded-lg border border-slate-200 bg-white py-1 shadow-lg dark:border-slate-700 dark:bg-slate-800">
                                    <a href="/admin/billing/invoices/{{ invoice.id }}" role="menuitem" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-700">View</a>
                                    <a href="/admin/billing/invoices/{{ invoice.id }}/pdf" role="menuitem" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-700">Download PDF</a>
                                    {% if invoice.status == 'draft' %}
                                    <button hx-post="/admin/billing/invoices/{{ invoice.id }}/send" role="menuitem"
                                            class="block w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-700">
                                        Send Invoice
                                    </button>
                                    {% endif %}
                                    {% if invoice.status in ['sent', 'overdue'] %}
                                    <a href="/admin/billing/payments/create?invoice={{ invoice.id }}" role="menuitem" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-700">Record Payment</a>
                                    {% endif %}
                                    <hr class="my-1 border-slate-200 dark:border-slate-700">
                                    <button hx-post="/admin/billing/invoices/{{ invoice.id }}/void"
                                            hx-confirm="Are you sure you want to void this invoice?"
                                            role="menuitem"
                                            class="block w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20">
                                        Void Invoice
                                    </button>
                                </div>
                            </div>
                        </td>
                    {% endcall %}
                    {% else %}
                    {{ empty_state(
                        title="No invoices found",
                        message="Create your first invoice to get started.",
                        icon='<svg class="h-8 w-8 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
                        color="emerald",
                        action_label="New Invoice",
                        action_href="/admin/billing/invoices/create",
                        colspan=7
                    ) }}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if pagination %}
        <div class="border-t border-slate-200 bg-white px-4 py-3 dark:border-slate-700 dark:bg-slate-800 sm:px-6">
            {% include "components/data/table_pagination.html" %}
        </div>
        {% endif %}
    {% endcall %}
</div>

{{ animation_styles() }}
{% endblock %}
