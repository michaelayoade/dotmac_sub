{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import status_badge %}

{% block title %}Integration Jobs - Integrations{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Integration Jobs</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Sync, export, and import jobs for external systems</p>
        </div>
        <div class="flex items-center gap-2">
            <a href="/admin/integrations/jobs/new" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-700">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add Job
            </a>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid gap-4 sm:grid-cols-4">
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Jobs</p>
            <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">{{ stats.total }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Active</p>
            <p class="mt-1 text-2xl font-bold text-green-600 dark:text-green-400">{{ stats.active }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Scheduled</p>
            <p class="mt-1 text-2xl font-bold text-blue-600 dark:text-blue-400">{{ stats.scheduled }}</p>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Manual</p>
            <p class="mt-1 text-2xl font-bold text-amber-600 dark:text-amber-400">{{ stats.manual }}</p>
        </div>
    </div>

    <!-- Jobs Table -->
    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead class="bg-slate-50 dark:bg-slate-800/50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Job</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Target</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Schedule</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Last Run</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Status</th>
                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% for job in jobs %}
                    {% set job_type = job.job_type.value if job.job_type else 'sync' %}
                    {% set schedule_type = job.schedule_type.value if job.schedule_type else 'manual' %}
                    {% set recent_runs = job_runs.get(job.id|string, []) %}
                    {% set last_run = recent_runs[0] if recent_runs else None %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-cyan-100 dark:bg-cyan-900/30">
                                    <svg class="h-5 w-5 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                </div>
                                <div>
                                    <a href="/admin/integrations/jobs/{{ job.id }}" class="text-sm font-medium text-primary-600 hover:text-primary-700 dark:text-primary-400">{{ job.name }}</a>
                                    {% if job.notes %}
                                    <p class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-xs">{{ job.notes }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-slate-900 dark:text-white">{{ job.target.name if job.target else '-' }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set type_colors = {'sync': 'blue', 'export': 'green', 'import': 'purple'} %}
                            {% set color = type_colors.get(job_type, 'slate') %}
                            <span class="inline-flex items-center rounded-full bg-{{ color }}-100 px-2.5 py-0.5 text-xs font-medium text-{{ color }}-700 dark:bg-{{ color }}-900/30 dark:text-{{ color }}-400">{{ job_type | title }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if schedule_type == 'interval' %}
                            <span class="text-sm text-slate-900 dark:text-white">Every {{ job.interval_minutes }} min</span>
                            {% else %}
                            <span class="text-sm text-slate-500 dark:text-slate-400">Manual</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if last_run %}
                            {% set run_status = last_run.status.value if last_run.status else 'running' %}
                            {% if run_status == 'success' %}
                            <span class="inline-flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                {{ last_run.started_at.strftime('%b %d %H:%M') }}
                            </span>
                            {% elif run_status == 'failed' %}
                            <span class="inline-flex items-center gap-1 text-xs text-red-600 dark:text-red-400">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                {{ last_run.started_at.strftime('%b %d %H:%M') }}
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1 text-xs text-amber-600 dark:text-amber-400">
                                <svg class="h-3.5 w-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                Running
                            </span>
                            {% endif %}
                            {% else %}
                            <span class="text-xs text-slate-400">Never</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if job.is_active %}
                            {{ status_badge("Active", "active", size="sm") }}
                            {% else %}
                            {{ status_badge("Inactive", "inactive", size="sm") }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <a href="/admin/integrations/jobs/{{ job.id }}" class="text-primary-600 hover:text-primary-700 dark:text-primary-400">View</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            <h3 class="mt-2 text-sm font-medium text-slate-900 dark:text-white">No integration jobs</h3>
                            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Get started by adding an integration job.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% set activity_title = "Integrations Activity" %}
    {% set activity_link = "/admin/system/audit" %}
    {% include "components/data/recent_activity_panel.html" %}
</div>
{% endblock %}
