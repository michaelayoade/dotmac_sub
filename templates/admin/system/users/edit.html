{% extends "layouts/admin.html" %}

{% block title %}Edit User - Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-2">
                <a href="/admin/system/users" class="hover:text-primary-600">Users</a>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                <span class="text-slate-900 dark:text-white">Edit</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Edit User</h1>
        </div>
        <a href="/admin/system/users/{{ user.id }}"
           class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
            Back to User
        </a>
    </div>

    {% if error %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-200">
        {{ error }}
    </div>
    {% endif %}

    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <form method="post" action="/admin/system/users/{{ user.id }}/edit" class="space-y-6 p-6">
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">First Name</label>
                    <input type="text" name="first_name" required value="{{ user.first_name }}"
                           class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Last Name</label>
                    <input type="text" name="last_name" required value="{{ user.last_name }}"
                           class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Display Name</label>
                    <input type="text" name="display_name" value="{{ user.display_name or '' }}"
                           class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Email</label>
                    <input type="email" name="email" required value="{{ user.email }}"
                           class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Phone</label>
                    <input type="text" name="phone" value="{{ user.phone or '' }}"
                           class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Roles</label>
                    <div class="rounded-lg border border-slate-300 bg-white p-3 max-h-48 overflow-y-auto dark:border-slate-600 dark:bg-slate-700">
                        <div class="space-y-2">
                            {% for role in roles %}
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="role_ids" value="{{ role.id }}"
                                       {% if role.id|string in current_role_ids %}checked{% endif %}
                                       class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700">
                                <span class="text-sm text-slate-700 dark:text-slate-300">{{ role.name }}</span>
                                {% if role.name == 'admin' %}
                                <span class="text-xs text-purple-600 dark:text-purple-400">(full access)</span>
                                {% endif %}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Select one or more roles</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" name="is_active" id="is_active"
                       {% if user.is_active %}checked{% endif %}
                       class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700">
                <label for="is_active" class="text-sm text-slate-700 dark:text-slate-300">Active</label>
            </div>

            <!-- Direct Permissions Section -->
            <div class="rounded-lg border border-slate-200 p-4 dark:border-slate-700" x-data="{ expanded: false, search: '' }">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Direct Permissions</h2>
                        <p class="text-xs text-slate-400 dark:text-slate-500">Grant specific permissions directly to this user (bypasses role-based access)</p>
                    </div>
                    <button type="button" @click="expanded = !expanded"
                            class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400">
                        <span x-show="!expanded">Show</span>
                        <span x-show="expanded">Hide</span>
                    </button>
                </div>
                <div x-show="expanded" x-transition class="mt-4">
                    <input type="text" x-model="search" placeholder="Search permissions..."
                           class="mb-3 block w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    <div class="max-h-64 overflow-y-auto space-y-1">
                        {% for permission in all_permissions %}
                        <label class="flex items-center gap-2 cursor-pointer py-1"
                               x-show="search === '' || '{{ permission.key }}'.toLowerCase().includes(search.toLowerCase())">
                            <input type="checkbox" name="direct_permission_ids" value="{{ permission.id }}"
                                   {% if permission.id|string in direct_permission_ids %}checked{% endif %}
                                   class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700">
                            <span class="text-sm font-mono text-slate-700 dark:text-slate-300">{{ permission.key }}</span>
                            {% if permission.description %}
                            <span class="text-xs text-slate-400">- {{ permission.description }}</span>
                            {% endif %}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% if can_update_password %}
            <div class="rounded-lg border border-slate-200 p-4 dark:border-slate-700">
                <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Password</h2>
                <div class="mt-4 grid gap-4 sm:grid-cols-2">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">New Password</label>
                        <input type="password" name="new_password"
                               class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Confirm Password</label>
                        <input type="password" name="confirm_password"
                               class="block w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-2">
                    <input type="checkbox" name="require_password_change" id="require_password_change" checked
                           class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 dark:border-slate-600 dark:bg-slate-700">
                    <label for="require_password_change" class="text-sm text-slate-700 dark:text-slate-300">Require password change on next login</label>
                </div>
            </div>
            {% endif %}
            <div class="flex justify-end gap-3">
                <a href="/admin/system/users/{{ user.id }}"
                   class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">
                    Cancel
                </a>
                <button type="submit"
                        class="inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
