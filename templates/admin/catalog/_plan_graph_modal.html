{# Plan Usage Graph Modal â€” loaded via HTMX into #graph-modal-container #}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm"
     x-data="{ show: true }"
     x-show="show"
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     @click.self="show = false; setTimeout(() => document.getElementById('graph-modal-container').innerHTML = '', 200)"
     @keydown.escape.window="show = false; setTimeout(() => document.getElementById('graph-modal-container').innerHTML = '', 200)">

    <div class="mx-4 w-full max-w-3xl rounded-xl border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-800"
         x-show="show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">

        {# Header #}
        <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <div>
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Plan Usage</h2>
                {% if offer %}
                <p class="text-sm text-slate-500 dark:text-slate-400">{{ offer.name }}</p>
                {% endif %}
            </div>
            <button type="button"
                    @click="show = false; setTimeout(() => document.getElementById('graph-modal-container').innerHTML = '', 200)"
                    class="rounded-lg p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:hover:bg-slate-700 dark:hover:text-slate-300">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>

        {# Summary Stats #}
        <div class="grid grid-cols-4 gap-4 border-b border-slate-200 px-6 py-4 dark:border-slate-700">
            <div class="text-center">
                <p class="text-2xl font-bold text-violet-600 dark:text-violet-400">{{ graph.total_now }}</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Total</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{{ graph.active_now }}</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Active</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ graph.max_total }}</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Max</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-slate-600 dark:text-slate-400">{{ graph.avg_total }}</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Avg</p>
            </div>
        </div>

        {# Period Toggle #}
        <div class="flex items-center gap-2 px-6 pt-4">
            {% for p in ["daily", "weekly", "monthly"] %}
            <button type="button"
                    hx-get="/admin/catalog/offers/{{ offer_id }}/usage-graph?period={{ p }}"
                    hx-target="#graph-modal-container"
                    hx-swap="innerHTML"
                    class="rounded-lg px-3 py-1.5 text-xs font-medium transition-colors {% if graph.period == p %}bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-300{% else %}bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600{% endif %}">
                {{ p | title }}
            </button>
            {% endfor %}
        </div>

        {# Chart #}
        <div class="px-6 py-4">
            {% if graph.labels %}
            <canvas id="planUsageChart" height="220"></canvas>
            {% else %}
            <div class="flex flex-col items-center justify-center py-12 text-center">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">No subscription data available for the selected period.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if graph.labels %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
(function() {
    const ctx = document.getElementById('planUsageChart');
    if (!ctx) return;

    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? 'rgba(148,163,184,0.15)' : 'rgba(148,163,184,0.2)';
    const textColor = isDark ? '#94a3b8' : '#64748b';

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ graph.labels | tojson | safe }},
            datasets: [
                {
                    label: 'Total Subscriptions',
                    data: {{ graph.total_counts | tojson | safe }},
                    borderColor: isDark ? '#a78bfa' : '#7c3aed',
                    backgroundColor: isDark ? 'rgba(167,139,250,0.1)' : 'rgba(124,58,237,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                },
                {
                    label: 'Active',
                    data: {{ graph.active_counts | tojson | safe }},
                    borderColor: isDark ? '#34d399' : '#059669',
                    backgroundColor: isDark ? 'rgba(52,211,153,0.1)' : 'rgba(5,150,105,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: textColor, usePointStyle: true, pointStyle: 'circle', padding: 16 }
                },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#fff',
                    titleColor: isDark ? '#f1f5f9' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? '#334155' : '#e2e8f0',
                    borderWidth: 1,
                }
            },
            scales: {
                x: {
                    grid: { color: gridColor },
                    ticks: { color: textColor, maxRotation: 45 }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: gridColor },
                    ticks: { color: textColor, precision: 0 }
                }
            }
        }
    });
})();
</script>
{% endif %}
