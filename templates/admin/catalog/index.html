{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, stats_card, card, data_table, table_head, table_row, row_actions, row_action, status_badge, empty_state, action_button, metric_row, icon_plus, icon_view, animation_styles %}

{% block title %}Service Catalog - Admin{% endblock %}

{% block content %}
{{ ambient_background("violet", "purple") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% call page_header(
        title="Service Catalog",
        subtitle="Manage tariffs, plans, and service definitions",
        icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>',
        color="violet",
        color2="purple"
    ) %}
        {{ action_button("Add Tariff", "/admin/catalog/offers/create", icon_plus(), "primary", "violet", "purple") }}
    {% endcall %}

    {# KPI Cards #}
    {% if catalog_stats %}
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 animate-fade-in-up" style="animation-delay: 50ms;">
        {{ stats_card("Active Offers", catalog_stats.active_count, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="violet", color2="purple") }}
        {{ stats_card("Total Plans", catalog_stats.total_count, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>', color="blue", color2="indigo") }}
        {{ stats_card("Active Subscriptions", catalog_stats.total_subscriptions, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>', color="emerald", color2="teal") }}
        {{ stats_card("Archived", catalog_stats.archived_count, icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>', color="slate", color2="gray") }}
    </div>
    {% endif %}

    {# Charts Row #}
    {% if catalog_stats %}
    <div class="grid gap-6 lg:grid-cols-2 animate-fade-in-up" style="animation-delay: 100ms;">
        {# Subscriptions by Plan #}
        {% call card("Subscriptions by Plan", color="violet") %}
        <div class="h-64">
            <canvas id="subscriptionsByPlanChart"></canvas>
        </div>
        {% endcall %}

        {# Offer Status Distribution #}
        {% call card("Offer Status", color="blue") %}
        <div class="flex items-center gap-6">
            <div class="h-48 w-48 flex-shrink-0">
                <canvas id="offerStatusChart"></canvas>
            </div>
            <div class="flex-1 space-y-2">
                {% for label, value, color_class in [
                    ("Active", catalog_stats.chart_data["values"][0], "bg-emerald-500"),
                    ("Inactive", catalog_stats.chart_data["values"][1], "bg-amber-500"),
                    ("Archived", catalog_stats.chart_data["values"][2], "bg-slate-400"),
                    ("Draft", catalog_stats.chart_data["values"][3], "bg-slate-600"),
                ] %}
                {% if value %}
                {{ metric_row(label, value, color="slate") }}
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endcall %}
    </div>
    {% endif %}

    {# Tariffs Table #}
    <div class="animate-fade-in-up" style="animation-delay: 150ms;">
    {% call card("Tariffs", color="violet") %}
        {# Category Tabs #}
        {% set category_tab_labels = {"internet": "Internet", "recurring": "Recurring", "one_time": "One-time", "bundle": "Bundles"} %}
        <div class="mb-4 flex flex-wrap items-center gap-2 border-b border-slate-200 pb-3 dark:border-slate-700">
            <a href="/admin/catalog{% if status %}?status={{ status }}{% endif %}{% if search %}{% if status %}&{% else %}?{% endif %}search={{ search }}{% endif %}{% if plan_kind %}{% if status or search %}&{% else %}?{% endif %}plan_kind={{ plan_kind }}{% endif %}"
               class="inline-flex items-center rounded-lg px-3 py-1.5 text-sm font-medium transition-colors {% if not plan_category %}bg-violet-100 text-violet-800 dark:bg-violet-900/30 dark:text-violet-400{% else %}bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600{% endif %}">
                All
            </a>
            {% for cat in plan_categories %}
            <a href="/admin/catalog?plan_category={{ cat }}{% if status %}&status={{ status }}{% endif %}{% if search %}&search={{ search }}{% endif %}{% if plan_kind %}&plan_kind={{ plan_kind }}{% endif %}"
               class="inline-flex items-center rounded-lg px-3 py-1.5 text-sm font-medium transition-colors {% if plan_category == cat %}bg-violet-100 text-violet-800 dark:bg-violet-900/30 dark:text-violet-400{% else %}bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600{% endif %}">
                {{ category_tab_labels.get(cat, cat | replace("_", " ") | title) }}
            </a>
            {% endfor %}
        </div>

        {# Filter Bar #}
        <div class="mb-4">
            <form method="get" action="/admin/catalog" class="flex flex-col gap-3 sm:flex-row sm:items-center">
                {% if plan_category %}
                <input type="hidden" name="plan_category" value="{{ plan_category }}">
                {% endif %}
                <div class="relative flex-1">
                    <input type="text" name="search" value="{{ search or '' }}" placeholder="Search tariffs..."
                           class="block h-10 w-full rounded-lg border border-slate-300 bg-white py-2 pl-10 pr-3 text-sm focus:border-violet-500 focus:outline-none focus:ring-1 focus:ring-violet-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                    <svg class="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.85-5.65a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <select name="status" class="block h-10 w-full rounded-lg border border-slate-300 bg-white px-3 text-sm focus:border-violet-500 focus:outline-none focus:ring-1 focus:ring-violet-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white sm:w-48">
                    <option value="">All statuses</option>
                    {% for item in offer_statuses %}
                    <option value="{{ item }}" {% if status == item %}selected{% endif %}>{{ item | replace('_', ' ') | title }}</option>
                    {% endfor %}
                </select>
                <select name="plan_kind" class="block h-10 w-full rounded-lg border border-slate-300 bg-white px-3 text-sm focus:border-violet-500 focus:outline-none focus:ring-1 focus:ring-violet-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white sm:w-52">
                    <option value="">All plan kinds</option>
                    <option value="standard" {% if plan_kind == "standard" %}selected{% endif %}>Standard</option>
                    <option value="ip_address" {% if plan_kind == "ip_address" %}selected{% endif %}>IP Address</option>
                    <option value="device_replacement" {% if plan_kind == "device_replacement" %}selected{% endif %}>Device Replacement</option>
                </select>
                <button type="submit" class="inline-flex h-10 items-center justify-center rounded-lg bg-violet-600 px-4 text-sm font-medium text-white hover:bg-violet-700 sm:w-auto">Filter</button>
            </form>
        </div>

        {% if offers %}
        {% call data_table() %}
            {{ table_head(["Tariff", "Category", "Type", "Plan", "Bandwidth", "Subscriptions", "Status", ""]) }}
            <tbody class="divide-y divide-slate-200 bg-white dark:divide-slate-700 dark:bg-slate-800">
                {% for offer in offers %}
                {% set offer_status = offer.status.value if offer.status is not string and offer.status else (offer.status | default('active')) %}
                {% set plan_meta = offer_plan_metadata.get(offer.id|string, {}) %}
                {% set plan_kind_value = plan_meta.get("plan_kind", "standard") %}
                {% call table_row(offer.id) %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="/admin/catalog/offers/{{ offer.id }}" class="text-sm font-medium text-violet-600 hover:text-violet-700 dark:text-violet-400">{{ offer.name }}</a>
                        {% if offer.code %}
                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ offer.code }}</p>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% set cat_val = offer.plan_category.value if offer.plan_category is not string and offer.plan_category else (offer.plan_category | default('internet')) %}
                        {% set cat_colors = {
                            "internet": "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
                            "recurring": "bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-300",
                            "one_time": "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
                            "bundle": "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"
                        } %}
                        {% set cat_labels = {"internet": "Internet", "recurring": "Recurring", "one_time": "One-time", "bundle": "Bundle"} %}
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium {{ cat_colors.get(cat_val, 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300') }}">
                            {{ cat_labels.get(cat_val, cat_val | replace('_', ' ') | title) }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                        {{ offer.service_type.value if offer.service_type is not string and offer.service_type else offer.service_type }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium
                            {% if plan_kind_value == 'ip_address' %}
                                bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300
                            {% elif plan_kind_value == 'device_replacement' %}
                                bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300
                            {% else %}
                                bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300
                            {% endif %}">
                            {{ plan_kind_value | replace('_', ' ') | title }}
                        </span>
                        {% if plan_kind_value == 'ip_address' and plan_meta.get('ip_block_size') %}
                        <p class="mt-1 text-xs font-mono text-slate-400 dark:text-slate-500">{{ plan_meta.get('ip_block_size') }}</p>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-500 dark:text-slate-400">
                        {% if offer.speed_download_mbps or offer.speed_upload_mbps %}
                        {{ offer.speed_download_mbps or '-' }}/{{ offer.speed_upload_mbps or '-' }} Kbps
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="font-medium text-slate-900 dark:text-white">{{ offer_active_subscription_counts.get(offer.id|string, 0) }}</span>
                        <span class="text-xs text-slate-400 dark:text-slate-500">active</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if offer_status == 'active' %}
                        {{ status_badge("Active", "active", size="sm") }}
                        {% elif offer_status == 'inactive' %}
                        {{ status_badge("Inactive", "warning", size="sm") }}
                        {% elif offer_status == 'archived' %}
                        {{ status_badge("Archived", "neutral", size="sm") }}
                        {% else %}
                        {{ status_badge(offer_status | title, "neutral", size="sm") }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        {% call row_actions() %}
                            {{ row_action("/admin/catalog/offers/" ~ offer.id, icon_view(), "View") }}
                            {{ row_action("/admin/catalog/offers/" ~ offer.id ~ "/edit", '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>', "Edit") }}
                        {% endcall %}
                    </td>
                {% endcall %}
                {% endfor %}
            </tbody>
        {% endcall %}

        {# Pagination #}
        {% if total_pages and total_pages > 1 %}
        <div class="mt-4 flex flex-col items-center justify-between gap-4 sm:flex-row">
            <p class="text-sm text-slate-500 dark:text-slate-400">Page {{ page }} of {{ total_pages }}</p>
            <div class="flex items-center gap-2">
                {% if page > 1 %}
                <a href="/admin/catalog?page={{ page - 1 }}&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if plan_kind %}&plan_kind={{ plan_kind }}{% endif %}{% if plan_category %}&plan_category={{ plan_category }}{% endif %}"
                   class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Previous</a>
                {% endif %}
                {% if page < total_pages %}
                <a href="/admin/catalog?page={{ page + 1 }}&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if plan_kind %}&plan_kind={{ plan_kind }}{% endif %}{% if plan_category %}&plan_category={{ plan_category }}{% endif %}"
                   class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        {% call empty_state("No tariffs found", "Create your first tariff to power subscriptions, billing, and provisioning.") %}
            {{ action_button("Create Tariff", "/admin/catalog/offers/create", icon_plus(), "primary", "violet", "purple") }}
        {% endcall %}
        {% endif %}
    {% endcall %}
    </div>
</div>

{{ animation_styles() }}

{# Chart.js Scripts #}
{% if catalog_stats %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#cbd5e1' : '#64748b';
    const gridColor = isDark ? 'rgba(100,116,139,0.2)' : 'rgba(226,232,240,0.8)';

    // Subscriptions by Plan (horizontal bar)
    const planLabels = {{ catalog_stats.subscriptions_by_plan["labels"] | tojson | safe }};
    const planValues = {{ catalog_stats.subscriptions_by_plan["values"] | tojson | safe }};
    if (planLabels.length > 0) {
        new Chart(document.getElementById('subscriptionsByPlanChart'), {
            type: 'bar',
            data: {
                labels: planLabels,
                datasets: [{
                    label: 'Active Subscriptions',
                    data: planValues,
                    backgroundColor: isDark ? 'rgba(139, 92, 246, 0.6)' : 'rgba(139, 92, 246, 0.8)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor }, grid: { display: false } }
                }
            }
        });
    }

    // Offer Status (doughnut)
    const statusLabels = {{ catalog_stats.chart_data["labels"] | tojson | safe }};
    const statusValues = {{ catalog_stats.chart_data["values"] | tojson | safe }};
    const statusColors = {{ catalog_stats.chart_data["colors"] | tojson | safe }};
    if (statusValues.some(v => v > 0)) {
        new Chart(document.getElementById('offerStatusChart'), {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: statusColors,
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
