{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, stats_card, card, data_table, table_head, table_row, status_badge, empty_state, action_button, animation_styles %}

{% block title %}Notification Queue - Admin{% endblock %}

{% block content %}
{{ ambient_background("rose", "pink") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% call page_header(
        title="Notification Queue",
        subtitle="View and manage pending notifications",
        icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>',
        color="rose",
        color2="pink"
    ) %}
        <div class="flex items-center gap-2">
            {{ action_button("Templates", "/admin/notifications/templates", '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>', "secondary", "slate") }}
            {{ action_button("History", "/admin/notifications/history", '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', "secondary", "slate") }}
        </div>
    {% endcall %}

    {# Status Filter Pills #}
    {% if statuses %}
    <div class="flex flex-wrap items-center gap-2 animate-fade-in-up" style="animation-delay: 50ms;">
        <a href="/admin/notifications/queue{% if channel %}?channel={{ channel }}{% endif %}"
           class="inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-sm font-medium transition-colors
                  {% if not status %}bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-400
                  {% else %}bg-slate-100 text-slate-700 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600{% endif %}">
            All
            <span class="rounded-full bg-white/50 px-1.5 py-0.5 text-xs dark:bg-slate-800">{{ total }}</span>
        </a>
        {% for st in statuses %}
        <a href="/admin/notifications/queue?status={{ st }}{% if channel %}&channel={{ channel }}{% endif %}"
           class="inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-sm font-medium transition-colors
                  {% if status == st %}bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-400
                  {% else %}bg-slate-100 text-slate-700 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600{% endif %}">
            {{ st|capitalize }}
            <span class="rounded-full bg-white/50 px-1.5 py-0.5 text-xs dark:bg-slate-800">{{ status_counts.get(st, 0) }}</span>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    {# Notifications Table #}
    <div class="animate-fade-in-up" style="animation-delay: 100ms;">
    {% call card("Queue", color="rose") %}
        {% if notifications %}
        {% call data_table() %}
            {{ table_head(["Recipient", "Channel", "Subject / Body", "Status", "Scheduled"]) }}
            <tbody class="divide-y divide-slate-200 bg-white dark:divide-slate-700 dark:bg-slate-800">
                {% for notification in notifications %}
                {% call table_row(notification.id) %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-slate-900 dark:text-white">{{ notification.recipient or 'N/A' }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% set channel_status = {'email': 'info', 'sms': 'active', 'push': 'neutral', 'whatsapp': 'active', 'webhook': 'warning'} %}
                        {{ status_badge(notification.channel.value|capitalize, channel_status.get(notification.channel.value, 'neutral'), size="sm") }}
                    </td>
                    <td class="px-6 py-4">
                        {% if notification.subject %}
                        <p class="text-sm font-medium text-slate-900 dark:text-white truncate max-w-xs">{{ notification.subject }}</p>
                        {% endif %}
                        <p class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-xs">{{ notification.body[:100] }}{% if notification.body|length > 100 %}...{% endif %}</p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% set notif_status_map = {'queued': 'warning', 'sending': 'info', 'delivered': 'active', 'failed': 'error', 'canceled': 'neutral'} %}
                        {{ status_badge(notification.status.value|capitalize, notif_status_map.get(notification.status.value, 'neutral'), size="sm") }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">
                        {{ notification.send_at.strftime('%b %d, %H:%M') if notification.send_at else 'Immediate' }}
                    </td>
                {% endcall %}
                {% endfor %}
            </tbody>
        {% endcall %}

        {# Pagination #}
        {% if total_pages > 1 %}
        <div class="mt-4 flex flex-col items-center justify-between gap-4 sm:flex-row">
            <p class="text-sm text-slate-500 dark:text-slate-400">
                Showing {{ ((page - 1) * per_page) + 1 }} to {{ [page * per_page, total]|min }} of {{ total }} notifications
            </p>
            <div class="flex items-center gap-2">
                {% if page > 1 %}
                <a href="?page={{ page - 1 }}{% if status %}&status={{ status }}{% endif %}{% if channel %}&channel={{ channel }}{% endif %}"
                   class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Previous</a>
                {% endif %}
                <span class="text-sm text-slate-600 dark:text-slate-400">Page {{ page }} of {{ total_pages }}</span>
                {% if page < total_pages %}
                <a href="?page={{ page + 1 }}{% if status %}&status={{ status }}{% endif %}{% if channel %}&channel={{ channel }}{% endif %}"
                   class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% else %}
        {{ empty_state("No notifications in queue", "Notifications will appear here when they are queued for delivery.") }}
        {% endif %}
    {% endcall %}
    </div>
</div>

{{ animation_styles() }}
{% endblock %}
