{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import
    ambient_background, page_header, stats_card, card,
    table_head, table_row, status_badge, animation_styles
%}

{% block title %}Technician Performance Report - Admin{% endblock %}

{% block charts_js %}
<script src="/static/js/vendor/chart.min.js"></script>
<script src="/static/js/charts.js"></script>
{% endblock %}

{% block content %}
{{ ambient_background("teal", "cyan") }}

<div class="relative space-y-6">
    {# ── Page Header ── #}
    {% call(content) page_header(
        title="Technician Performance",
        subtitle="Compare field service completion and efficiency",
        icon='<svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
        color="teal",
        color2="cyan",
        breadcrumbs=[
            {"label": "Reports", "href": "/admin/reports"},
            {"label": "Technician Performance"}
        ]
    ) %}
        <form method="GET" action="/admin/reports/technician/export" class="flex items-center gap-2">
            <label for="days" class="sr-only">Export period</label>
            <select id="days" name="days" class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
            <button type="submit" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Export
            </button>
        </form>
    {% endcall %}

    {# ── Summary Stats ── #}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {{ stats_card(
            "Total Technicians",
            total_technicians | default(0),
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
            color="teal", color2="cyan"
        ) }}
        {{ stats_card(
            "Jobs Completed",
            jobs_completed | default(0),
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            color="emerald", color2="green"
        ) }}
        {{ stats_card(
            "Avg Completion Time",
            ("%.1f" | format(avg_completion_hours | default(0))) ~ "h",
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            color="blue", color2="indigo"
        ) }}
        {{ stats_card(
            "First-Visit Resolution",
            ("%.1f" | format(first_visit_rate | default(0))) ~ "%",
            icon='<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>',
            color="amber", color2="orange"
        ) }}
    </div>

    {# ── Technician Leaderboard ── #}
    {% call card("Performance Leaderboard", icon='<svg class="h-4 w-4 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>', color="teal", padding=False) %}
        {% if technician_stats %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                {{ table_head([
                    {"label": "Rank"},
                    {"label": "Technician"},
                    {"label": "Jobs"},
                    {"label": "Completed"},
                    {"label": "Avg Time"},
                    {"label": "Rating"}
                ]) }}
                <tbody class="divide-y divide-slate-100 bg-white dark:divide-slate-700/50 dark:bg-slate-800">
                    {% for tech in technician_stats %}
                    {% call table_row(color="teal") %}
                        <td class="whitespace-nowrap px-6 py-4 text-sm">
                            {% if loop.index == 1 %}
                            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-yellow-100 text-yellow-800 font-bold text-xs">1</span>
                            {% elif loop.index == 2 %}
                            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-200 text-slate-700 font-bold text-xs">2</span>
                            {% elif loop.index == 3 %}
                            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-amber-100 text-amber-800 font-bold text-xs">3</span>
                            {% else %}
                            <span class="text-slate-500 dark:text-slate-400">{{ loop.index }}</span>
                            {% endif %}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="flex h-8 w-8 items-center justify-center rounded-full bg-teal-100 dark:bg-teal-900/30">
                                    <span class="text-sm font-medium text-teal-600 dark:text-teal-400">{{ tech.name[0] | upper if tech.name else 'T' }}</span>
                                </div>
                                <span class="text-sm font-medium text-slate-900 dark:text-white">{{ tech.name }}</span>
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-900 dark:text-white">{{ tech.total_jobs }}</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-green-600 dark:text-green-400 font-semibold">{{ tech.completed_jobs }}</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-500 dark:text-slate-400">{{ "%.1f" | format(tech.avg_hours) }}h</td>
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="flex items-center gap-1">
                                {% for i in range(5) %}
                                <svg class="h-4 w-4 {% if i < tech.rating %}text-yellow-400{% else %}text-slate-300 dark:text-slate-600{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                {% endfor %}
                            </div>
                        </td>
                    {% endcall %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-8 text-center text-sm text-slate-500 dark:text-slate-400">No technician data available.</div>
        {% endif %}
    {% endcall %}

    {# ── Job Types and Recent Completions ── #}
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        {% call card("Jobs by Type", icon='<svg class="h-4 w-4 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>', color="cyan") %}
            <div class="chart-container mb-4" style="min-height: 200px;">
                <canvas id="job-types-chart"></canvas>
            </div>
            <div class="space-y-3">
                {% for job_type, count in job_type_breakdown.items() %}
                <div class="flex items-center justify-between">
                    <span class="text-sm text-slate-700 dark:text-slate-300">{{ job_type | title | replace('_', ' ') }}</span>
                    <span class="text-sm font-semibold text-slate-900 dark:text-white">{{ count }}</span>
                </div>
                {% else %}
                <p class="text-sm text-slate-500 dark:text-slate-400">No job type data available.</p>
                {% endfor %}
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('job-types-chart');
                if (!ctx) return;
                const chartData = {
                    labels: [{% for job_type, count in job_type_breakdown.items() %}'{{ job_type | title | replace("_", " ") }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    values: [{% for job_type, count in job_type_breakdown.items() %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    colors: ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899']
                };
                if (chartData.labels.length > 0) {
                    const chart = DotmacCharts.createDoughnutChart(ctx, chartData, { plugins: { legend: { display: false } } });
                    DotmacCharts.registerChart('job-types-chart', chart);
                }
            });
            </script>
        {% endcall %}

        {% call card("Recent Completions", icon='<svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald") %}
            {% if recent_completions %}
            <div class="space-y-3">
                {% for job in recent_completions %}
                <div class="flex items-center justify-between py-2 border-b border-slate-100 dark:border-slate-700 last:border-0">
                    <div>
                        <p class="text-sm font-medium text-slate-900 dark:text-white">{{ job.order_type.value | title if job.order_type else 'Service Order' }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            {{ job.assigned_technician.person.first_name if job.assigned_technician and job.assigned_technician.person else 'Unassigned' }} -
                            {{ job.completed_at.strftime('%b %d') if job.completed_at else job.updated_at.strftime('%b %d') if job.updated_at else '-' }}
                        </p>
                    </div>
                    {{ status_badge("Completed", variant="success") }}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-slate-500 dark:text-slate-400">No recent completions.</p>
            {% endif %}
        {% endcall %}
    </div>

    {% set activity_title = "Reports Activity" %}
    {% set activity_link = "/admin/system/audit" %}
    {% include "components/data/recent_activity_panel.html" %}
</div>

{{ animation_styles() }}
{% endblock %}
