{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import ambient_background, page_header, stats_card, card, data_table, table_head, table_row, empty_state, action_button, metric_row, animation_styles %}

{% block title %}Revenue Report - Admin{% endblock %}

{% block charts_js %}
<script src="/static/js/vendor/chart.min.js"></script>
<script src="/static/js/charts.js"></script>
{% endblock %}

{% block content %}
{{ ambient_background("teal", "cyan") }}

<div class="relative space-y-6">
    {# Page Header #}
    {% call page_header(
        title="Revenue Report",
        subtitle="Track revenue trends and billing performance",
        icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>',
        color="teal",
        color2="cyan"
    ) %}
        <form method="GET" action="/admin/reports/revenue/export" class="flex items-center gap-2">
            <label for="days" class="sr-only">Export period</label>
            <select id="days" name="days" class="rounded-lg border border-slate-300 px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="365">Last Year</option>
            </select>
            <button type="submit" class="group inline-flex items-center px-4 py-2.5 text-sm gap-2 rounded-xl border border-slate-200 bg-white font-semibold text-slate-700 shadow-sm transition-all hover:border-slate-300 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:border-slate-500 dark:hover:bg-slate-700">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Export
            </button>
        </form>
    {% endcall %}

    {# KPI Cards #}
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 animate-fade-in-up" style="animation-delay: 50ms;">
        {{ stats_card("Total Revenue", "₦" ~ "{:,.2f}".format(total_revenue), icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="emerald", color2="teal", change=revenue_growth|default(0)) }}
        {{ stats_card("Recurring Revenue", "₦" ~ "{:,.2f}".format(recurring_revenue), icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>', color="blue", color2="indigo") }}
        {{ stats_card("Outstanding", "₦" ~ "{:,.2f}".format(outstanding_amount), icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="amber", color2="orange") }}
        {{ stats_card("Collection Rate", "%.1f"|format(collection_rate) ~ "%", icon='<svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>', color="violet", color2="purple") }}
    </div>

    {# Revenue Trend Chart #}
    <div class="animate-fade-in-up" style="animation-delay: 100ms;">
    {% call card("Revenue Trend", color="teal") %}
        <div class="chart-container" style="min-height: 280px;">
            <canvas id="revenue-chart"></canvas>
        </div>
        {% set revenue_data = revenue_data|default({'labels': ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], 'revenue': [0,0,0,0,0,0], 'collected': [0,0,0,0,0,0]}) %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('revenue-chart');
            if (!ctx) return;
            const chartData = {
                labels: {{ revenue_data["labels"] | tojson | safe }},
                datasets: [
                    {
                        label: 'Total Revenue',
                        data: {{ revenue_data["revenue"] | tojson | safe }},
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Collected',
                        data: {{ revenue_data["collected"] | tojson | safe }},
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            };
            const chart = DotmacCharts.createAreaChart(ctx, chartData, {});
            DotmacCharts.registerChart('revenue-chart', chart);
        });
        </script>
    {% endcall %}
    </div>

    {# Recent Payments #}
    <div class="animate-fade-in-up" style="animation-delay: 150ms;">
    {% call card("Recent Payments", color="teal") %}
        {% if recent_payments %}
        {% call data_table() %}
            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                {{ table_head([
                    {"label": "Date"},
                    {"label": "Account"},
                    {"label": "Amount"},
                    {"label": "Method"}
                ]) }}
                <tbody class="divide-y divide-slate-200 bg-white dark:divide-slate-700 dark:bg-slate-800">
                    {% for payment in recent_payments %}
                    {% call table_row(payment.id) %}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">
                            {{ payment.paid_at.strftime('%b %d, %Y') if payment.paid_at else (payment.created_at.strftime('%b %d, %Y') if payment.created_at else '-') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">
                            {% if payment.account and payment.account.subscriber and payment.account.subscriber.person %}
                                {{ payment.account.subscriber.person.first_name }} {{ payment.account.subscriber.person.last_name }}
                            {% elif payment.account and payment.account.subscriber and payment.account.subscriber.organization %}
                                {{ payment.account.subscriber.organization.name }}
                            {% else %}
                                {{ payment.account.account_number if payment.account and payment.account.account_number else 'Account' }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium font-mono tabular-nums text-emerald-600 dark:text-emerald-400">₦{{ "{:,.2f}".format(payment.amount) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">
                            {% if payment.payment_method %}
                                {{ payment.payment_method.label or payment.payment_method.method_type.value | title }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    {% endcall %}
                    {% endfor %}
                </tbody>
            </table>
        {% endcall %}
        {% else %}
        {% call empty_state("No recent payments", "Payments will appear here as they are recorded.") %}
        {% endcall %}
        {% endif %}
    {% endcall %}
    </div>

    {% set activity_title = "Reports Activity" %}
    {% set activity_link = "/admin/system/audit" %}
    {% include "components/data/recent_activity_panel.html" %}
</div>

{{ animation_styles() }}
{% endblock %}
