{% extends "layouts/admin.html" %}
{% from "components/ui/macros.html" import status_badge %}

{% block title %}{{ subscriber.person.first_name if subscriber.person else subscriber.organization.name }} - Subscriber{% endblock %}

{% block head %}
{% if map_data %}
<!-- Leaflet CSS for mini-map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
{% endif %}
<style>
    #subscriber-mini-map {
        z-index: 0;
    }
    .dark .leaflet-tile-pane {
        filter: brightness(0.9) saturate(0.9);
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
        50% { box-shadow: 0 0 20px 10px rgba(245, 158, 11, 0); }
    }
    .stat-card:hover .stat-glow { transform: scale(1.5); opacity: 1; }
    .section-card { transition: all 0.3s ease; }
    .section-card:hover { box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1); }
    .dark .section-card:hover { box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.3); }
    .bandwidth-bar { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .bandwidth-bar:hover { transform: scaleY(1.1); filter: brightness(1.1); }
</style>
{% endblock %}

{% block page_header %}
<!-- Ambient Background -->
<div class="pointer-events-none fixed inset-0 overflow-hidden">
    <div class="absolute -top-40 right-0 h-[500px] w-[500px] rounded-full bg-gradient-to-br from-amber-400/5 to-orange-500/5 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-40 h-[400px] w-[400px] rounded-full bg-gradient-to-tr from-emerald-400/5 to-cyan-500/5 blur-3xl"></div>
</div>

<div class="relative flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between mb-6 animate-fade-in-up">
    <div class="flex items-start gap-4">
        <!-- Enhanced Avatar -->
        <div class="relative group">
            <div class="absolute inset-0 rounded-2xl bg-gradient-to-br {% if subscriber.subscriber_type == 'organization' %}from-amber-500 to-orange-600{% else %}from-violet-500 to-purple-600{% endif %} opacity-0 blur-xl transition-opacity group-hover:opacity-50"></div>
            <div class="relative flex h-16 w-16 items-center justify-center rounded-2xl text-xl font-bold shadow-lg
                {% if subscriber.is_active %}bg-gradient-to-br {% if subscriber.subscriber_type == 'organization' %}from-amber-500 to-orange-600 shadow-amber-500/25{% else %}from-violet-500 to-purple-600 shadow-violet-500/25{% endif %} text-white
                {% else %}bg-slate-200 text-slate-500 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                {% if subscriber.person %}
                    {{ subscriber.person.first_name[0] }}{{ subscriber.person.last_name[0] if subscriber.person.last_name else '' }}
                {% else %}
                    {{ subscriber.organization.name[0:2] | upper }}
                {% endif %}
            </div>
        </div>
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white font-display tracking-tight">
                    {% if subscriber.person %}{{ subscriber.person.first_name }} {{ subscriber.person.last_name }}{% else %}{{ subscriber.organization.name }}{% endif %}
                </h1>
                {% if subscriber.is_active %}
                {{ status_badge("Active", "active", size="sm") }}
                {% else %}
                {{ status_badge("Inactive", "inactive", size="sm") }}
                {% endif %}
            </div>
            <div class="mt-1.5 flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-slate-500 dark:text-slate-400">
                {% if subscriber.subscriber_number %}
                <span class="flex items-center gap-1.5">
                    <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/></svg>
                    <span class="font-mono text-xs">{{ subscriber.subscriber_number }}</span>
                </span>
                {% endif %}
                <span class="flex items-center gap-1.5">
                    <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                    {{ subscriber.subscriber_type | title }}
                </span>
                <span class="flex items-center gap-1.5">
                    <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Since {{ subscriber.created_at.strftime('%b %Y') if subscriber.created_at else 'Jan 2024' }}
                </span>
            </div>
        </div>
    </div>
    <div class="flex flex-wrap items-center gap-2">
        {% set subscription_link = "/admin/catalog/subscriptions/new" %}
        {% if accounts and accounts|length == 1 %}
            {% set subscription_link = "/admin/catalog/subscriptions/new?account_id=" ~ accounts[0].id %}
        {% endif %}
        <a href="{{ subscription_link }}" class="group inline-flex items-center gap-2 rounded-xl border border-amber-200 bg-gradient-to-r from-amber-50 to-orange-50 px-4 py-2.5 text-sm font-semibold text-amber-700 shadow-sm transition-all hover:shadow-md hover:border-amber-300 hover:-translate-y-0.5 dark:border-amber-800/60 dark:bg-gradient-to-r dark:from-amber-900/20 dark:to-orange-900/20 dark:text-amber-300 dark:hover:border-amber-700">
            <svg class="h-4 w-4 transition-transform group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Create Subscription
        </a>
        <a href="/admin/operations/service-orders/new?subscriber={{ subscriber.id }}" class="group inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-amber-500/25 transition-all hover:shadow-xl hover:shadow-amber-500/30 hover:-translate-y-0.5">
            <svg class="h-4 w-4 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            New Service
        </a>
        <a href="/admin/support/tickets/create?subscriber={{ subscriber.id }}" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm transition-all hover:bg-slate-50 hover:border-slate-300 hover:-translate-y-0.5 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
            Create Ticket
        </a>
        <div x-data="{ open: false }" class="relative">
            <button x-on:click="open = !open" class="inline-flex items-center gap-1 rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-medium text-slate-700 shadow-sm transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
            </button>
            <div x-show="open" x-on:click.outside="open = false" x-cloak
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 class="absolute right-0 mt-2 w-52 rounded-2xl border border-slate-200 bg-white/95 py-2 shadow-xl backdrop-blur-sm dark:border-slate-700 dark:bg-slate-800/95 z-10">
                <a href="/admin/subscribers/{{ subscriber.id }}/edit" class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 transition-colors">
                    <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    Edit Details
                </a>
                <a href="/admin/billing/invoices/create?subscriber={{ subscriber.id }}" class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 transition-colors">
                    <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Create Invoice
                </a>
                {% if accounts %}
                <div class="border-t border-slate-100 dark:border-slate-700 my-1"></div>
                {% for account in accounts %}
                {% set account_status = account.status | default('active') %}
                {% set account_status_val = account_status.value if account_status is not string else account_status %}
                {% if account_status_val == 'active' %}
                <button hx-post="/admin/billing/accounts/{{ account.id }}/deactivate"
                        hx-confirm="Deactivate account {{ account.account_number or account.id }} before deleting?"
                        class="flex w-full items-center gap-3 px-4 py-2.5 text-sm text-amber-600 hover:bg-amber-50 dark:text-amber-400 dark:hover:bg-amber-900/20 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                    Deactivate Account {{ account.account_number or (account.id | string)[:8] }}
                </button>
                {% endif %}
                <button hx-delete="/admin/billing/accounts/{{ account.id }}"
                        hx-confirm="Delete billing account {{ account.account_number or account.id }}? This action cannot be undone."
                        class="flex w-full items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete Account {{ account.account_number or (account.id | string)[:8] }}
                </button>
                {% endfor %}
                {% endif %}
                <a href="/admin/subscribers/{{ subscriber.id }}/suspend" class="flex items-center gap-3 px-4 py-2.5 text-sm text-amber-600 hover:bg-amber-50 dark:text-amber-400 dark:hover:bg-amber-900/20 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                    Suspend Service
                </a>
                <div class="border-t border-slate-100 dark:border-slate-700 my-1"></div>
                {% if subscriber.is_active %}
                <button hx-post="/admin/subscribers/{{ subscriber.id }}/deactivate"
                        hx-confirm="Deactivate this subscriber before deleting?"
                        class="flex w-full items-center gap-3 px-4 py-2.5 text-sm text-amber-600 hover:bg-amber-50 dark:text-amber-400 dark:hover:bg-amber-900/20 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                    Deactivate Subscriber
                </button>
                {% else %}
                <button hx-delete="/admin/subscribers/{{ subscriber.id }}"
                        hx-confirm="Delete this deactivated subscriber? This action cannot be undone."
                        class="flex w-full items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete Subscriber
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if request.query_params.get('missing_email') %}
<div class="mb-6 rounded-xl border border-amber-200 bg-amber-50 px-5 py-4 text-sm text-amber-800 shadow-sm dark:border-amber-900/50 dark:bg-amber-900/20 dark:text-amber-300">
    <div class="flex items-start gap-3">
        <svg class="h-5 w-5 text-amber-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>
            <p class="font-semibold">Email missing for this subscriber.</p>
            <p class="mt-1">Add an email to send invoices, notifications, and recovery messages.</p>
            {% if subscriber.person %}
            <a href="/admin/customers/person/{{ subscriber.person.id }}/edit" class="mt-2 inline-flex text-sm font-semibold text-amber-700 hover:text-amber-800 dark:text-amber-300">
                Add email now
                <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block content %}
<!-- Quick Stats Bar -->
<div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-6 mb-6">
    <div class="stat-card group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 50ms;">
        <div class="stat-glow absolute -right-4 -top-4 h-20 w-20 rounded-full bg-gradient-to-br from-emerald-500/10 to-green-500/10 blur-2xl transition-all opacity-50"></div>
        <div class="relative">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">Monthly Bill</p>
            <p class="mt-1 text-xl font-bold text-slate-900 dark:text-white font-display">₦{{ "{:,.2f}".format(stats.monthly_bill | default(89.99)) }}</p>
        </div>
    </div>
    <div class="stat-card group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 75ms;">
        <div class="stat-glow absolute -right-4 -top-4 h-20 w-20 rounded-full bg-gradient-to-br {% if (stats.balance_due | default(0)) > 0 %}from-red-500/10 to-rose-500/10{% else %}from-emerald-500/10 to-green-500/10{% endif %} blur-2xl transition-all opacity-50"></div>
        <div class="relative">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">Balance Due</p>
            <p class="mt-1 text-xl font-bold {% if (stats.balance_due | default(0)) > 0 %}text-red-600 dark:text-red-400{% else %}text-emerald-600 dark:text-emerald-400{% endif %} font-display">
                ₦{{ "{:,.2f}".format(stats.balance_due | default(0)) }}
            </p>
        </div>
    </div>
    <div class="stat-card group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 100ms;">
        <div class="stat-glow absolute -right-4 -top-4 h-20 w-20 rounded-full bg-gradient-to-br from-blue-500/10 to-indigo-500/10 blur-2xl transition-all opacity-50"></div>
        <div class="relative">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">Data Usage</p>
            <p class="mt-1 text-xl font-bold text-slate-900 dark:text-white font-display">{{ stats.data_usage | default('842') }} GB</p>
        </div>
    </div>
    <div class="stat-card group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 125ms;">
        <div class="stat-glow absolute -right-4 -top-4 h-20 w-20 rounded-full bg-gradient-to-br from-amber-500/10 to-orange-500/10 blur-2xl transition-all opacity-50"></div>
        <div class="relative">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">Open Tickets</p>
            <p class="mt-1 text-xl font-bold text-slate-900 dark:text-white font-display">{{ stats.open_tickets | default(0) }}</p>
        </div>
    </div>
    <div class="stat-card group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 150ms;">
        <div class="stat-glow absolute -right-4 -top-4 h-20 w-20 rounded-full bg-gradient-to-br from-emerald-500/10 to-teal-500/10 blur-2xl transition-all opacity-50"></div>
        <div class="relative">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">ONT Status</p>
            <p class="mt-1 flex items-center gap-2 text-lg font-bold text-emerald-600 dark:text-emerald-400 font-display">
                <span class="relative flex h-2.5 w-2.5">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                    <span class="relative inline-flex h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
                </span>
                Online
            </p>
        </div>
    </div>
    <div class="stat-card group relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:-translate-y-0.5 dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 175ms;">
        <div class="stat-glow absolute -right-4 -top-4 h-20 w-20 rounded-full bg-gradient-to-br from-violet-500/10 to-purple-500/10 blur-2xl transition-all opacity-50"></div>
        <div class="relative">
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">Services</p>
            <p class="mt-1 text-xl font-bold text-slate-900 dark:text-white font-display">{{ subscriptions|length if subscriptions else 0 }}</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Left Column: Services & Equipment -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Active Services -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 200ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Subscriptions</h2>
                </div>
                <button type="button" @click="$dispatch('open-subscription-modal')" class="inline-flex items-center gap-1.5 text-sm font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Subscription
                </button>
            </div>
            <div class="p-5">
                {% if subscriptions %}
                <div class="space-y-3">
                    {% for sub in subscriptions %}
                    {% set sub_status = sub.status.value if sub.status is not string and sub.status else (sub.status | default('active')) %}
                    {% set is_online = online_status.get(sub.id|string, false) %}
                    <a href="/admin/catalog/subscriptions/{{ sub.id }}" class="group flex items-center gap-4 rounded-xl border border-slate-100 dark:border-slate-700 p-4 hover:border-amber-200 hover:bg-gradient-to-r hover:from-amber-50/50 hover:to-orange-50/30 dark:hover:border-amber-800/50 dark:hover:from-amber-900/10 dark:hover:to-orange-900/5 transition-all cursor-pointer">
                        {# Icon with online indicator #}
                        <div class="relative">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl {% if is_online %}bg-gradient-to-br from-emerald-100 to-teal-100 dark:from-emerald-900/40 dark:to-teal-800/30{% else %}bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600{% endif %} transition-transform group-hover:scale-105">
                                <svg class="h-6 w-6 {% if is_online %}text-emerald-600 dark:text-emerald-400{% else %}text-slate-400 dark:text-slate-500{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            {# Online pulse indicator #}
                            {% if is_online and sub_status == 'active' %}
                            <span class="absolute -top-1 -right-1 flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ sub.offer.name if sub.offer else 'Service #' ~ sub.id|string|truncate(8, True, '') }}</p>
                                {# Exception-based badges: only show when there's a problem #}
                                {% if sub_status == 'active' and not is_online %}
                                {# Active but offline - needs attention #}
                                <span class="inline-flex items-center gap-1 rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-700 dark:bg-red-900/30 dark:text-red-400">
                                    <span class="h-1 w-1 rounded-full bg-red-500"></span>Offline
                                </span>
                                {% elif sub_status == 'suspended' %}
                                <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
                                    <span class="h-1 w-1 rounded-full bg-amber-500"></span>Suspended
                                </span>
                                {% elif sub_status == 'pending' %}
                                <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">
                                    <span class="h-1 w-1 rounded-full bg-blue-500"></span>Pending
                                </span>
                                {% elif sub_status == 'canceled' %}
                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-400">
                                    <span class="h-1 w-1 rounded-full bg-slate-400"></span>Canceled
                                </span>
                                {% elif sub_status not in ['active'] %}
                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-400">{{ sub_status | title }}</span>
                                {% endif %}
                                {# Active + online = no badge needed, the green icon + pulse says it all #}
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
                                {% if is_online %}Connected{% else %}Last seen: {{ sub.updated_at.strftime('%d %b %H:%M') if sub.updated_at else 'Never' }}{% endif %}
                            </p>
                        </div>
                        <div class="text-right">
                            {% set price = sub.offer.prices[0].amount if sub.offer and sub.offer.prices else 0 %}
                            <p class="text-sm font-bold text-slate-900 dark:text-white">₦{{ "{:,.0f}".format(price) }}<span class="text-xs font-normal text-slate-400">/mo</span></p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Since {{ sub.created_at.strftime('%b %Y') if sub.created_at else 'N/A' }}</p>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="p-2 rounded-lg text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300 transition-colors">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-10">
                    <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600">
                        <svg class="h-8 w-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <h3 class="mt-4 text-sm font-semibold text-slate-900 dark:text-white">No active subscriptions</h3>
                    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Add a subscription to get this subscriber connected.</p>
                    <button type="button" @click="$dispatch('open-subscription-modal')" class="mt-4 inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-amber-500/25 transition-all hover:shadow-xl hover:-translate-y-0.5">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Add Subscription
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Equipment & Network -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 250ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-cyan-500 to-teal-600 shadow-lg shadow-cyan-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Equipment & Network</h2>
                </div>
                <button class="text-sm font-medium text-cyan-600 hover:text-cyan-700 dark:text-cyan-400 transition-colors">Manage Devices</button>
            </div>
            <div class="p-5">
                {% if equipment %}
                <div class="grid gap-4 sm:grid-cols-2">
                    {% for device in equipment %}
                    <div class="group rounded-xl border border-slate-100 dark:border-slate-700 p-4 hover:border-cyan-200 hover:bg-gradient-to-br hover:from-cyan-50/50 hover:to-teal-50/30 dark:hover:border-cyan-800/50 dark:hover:from-cyan-900/10 dark:hover:to-teal-900/5 transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">{{ device.type }}</span>
                            <span class="flex items-center gap-1.5 text-xs font-semibold {% if device.online %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                <span class="relative flex h-2 w-2">
                                    {% if device.online %}<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>{% endif %}
                                    <span class="relative inline-flex h-2 w-2 rounded-full {% if device.online %}bg-emerald-500{% else %}bg-red-500{% endif %}"></span>
                                </span>
                                {{ 'Online' if device.online else 'Offline' }}
                            </span>
                        </div>
                        <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ device.model }}</p>
                        <div class="mt-2 space-y-1 text-xs text-slate-500 dark:text-slate-400">
                            <p>SN: <span class="font-mono text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">{{ device.serial }}</span></p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-10">
                    <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600">
                        <svg class="h-8 w-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                    </div>
                    <h3 class="mt-4 text-sm font-semibold text-slate-900 dark:text-white">No equipment assigned</h3>
                    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Equipment will appear here once provisioned.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Tickets -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 275ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Tickets</h2>
                </div>
                <a href="/admin/support/tickets?subscriber={{ subscriber.id }}" class="text-sm font-medium text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">View All</a>
            </div>
            <div class="p-5">
                {% if tickets %}
                <div class="space-y-2">
                    {% for ticket in tickets[:3] %}
                    {% set ticket_status = ticket.status.value if ticket.status is not string and ticket.status else (ticket.status | default('open')) %}
                    <a href="/admin/support/tickets/{{ ticket.id }}" class="flex items-start gap-3 p-3 rounded-xl hover:bg-gradient-to-r hover:from-amber-50/50 hover:to-orange-50/30 dark:hover:from-amber-900/10 dark:hover:to-orange-900/5 transition-all group">
                        <span class="flex h-8 w-8 items-center justify-center rounded-lg text-xs font-bold
                            {% if ticket_status in ['open', 'new', 'in_progress'] %}bg-gradient-to-br from-amber-100 to-orange-100 text-amber-700 dark:from-amber-900/40 dark:to-orange-900/30 dark:text-amber-400
                            {% elif ticket_status == 'resolved' %}bg-gradient-to-br from-emerald-100 to-green-100 text-emerald-700 dark:from-emerald-900/40 dark:to-green-900/30 dark:text-emerald-400
                            {% else %}bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                            {{ (ticket.id|string)[0:2] | upper }}
                        </span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-slate-900 dark:text-white truncate group-hover:text-amber-600 dark:group-hover:text-amber-400 transition-colors">{{ ticket.subject | default('Ticket #' ~ ticket.id|string|truncate(8, True, '')) }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">{{ ticket.created_at.strftime('%b %d, %Y') if ticket.created_at else 'N/A' }}</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6">
                    <p class="text-sm text-slate-500 dark:text-slate-400">No recent tickets</p>
                    <a href="/admin/support/tickets/create?subscriber={{ subscriber.id }}" class="mt-2 inline-block text-sm font-semibold text-amber-600 hover:text-amber-700 dark:text-amber-400 transition-colors">Create Ticket</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Bandwidth Usage Chart -->
        {% if subscriptions and subscriptions|length > 0 %}
        {% set first_subscription = subscriptions[0] %}
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 300ms;"
             x-data="BandwidthChart.bandwidthChart({ subscriptionId: '{{ first_subscription.id }}' })"
             x-init="init()"
             x-on:destroy.window="destroy()">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 shadow-lg shadow-violet-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Bandwidth Usage</h2>
                </div>
                <div class="flex items-center gap-1 rounded-xl bg-slate-100 p-1 dark:bg-slate-700">
                    <template x-for="range in timeRanges" :key="range.value">
                        <button @click="setTimeRange(range.value)"
                                :class="timeRange === range.value ? 'bg-white text-slate-900 shadow-sm dark:bg-slate-600 dark:text-white' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200'"
                                class="rounded-lg px-3 py-1.5 text-xs font-semibold transition-colors"
                                x-text="range.label">
                        </button>
                    </template>
                </div>
            </div>
            <div class="p-5">
                <!-- Loading state -->
                <div x-show="loading" class="flex items-center justify-center h-36">
                    <svg class="animate-spin h-8 w-8 text-violet-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <!-- Error state -->
                <div x-show="error && !loading" class="flex flex-col items-center justify-center h-36 text-center">
                    <svg class="h-8 w-8 text-red-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <p class="text-sm text-slate-500 dark:text-slate-400" x-text="error"></p>
                </div>

                <!-- Chart -->
                <div x-show="!loading && !error">
                    <div class="h-36 mb-3">
                        <canvas x-ref="canvas"></canvas>
                    </div>
                    <div class="flex items-center justify-center gap-6 text-xs">
                        <span class="flex items-center gap-2">
                            <span class="h-2.5 w-2.5 rounded bg-gradient-to-r from-amber-400 to-amber-300"></span>
                            <span class="text-slate-500 dark:text-slate-400">Download</span>
                        </span>
                        <span class="flex items-center gap-2">
                            <span class="h-2.5 w-2.5 rounded bg-gradient-to-r from-cyan-400 to-cyan-300"></span>
                            <span class="text-slate-500 dark:text-slate-400">Upload</span>
                        </span>
                    </div>
                    <div class="mt-4 grid grid-cols-4 gap-4 pt-4 border-t border-slate-100 dark:border-slate-700 text-center">
                        <div class="group">
                            <p class="text-xs font-medium text-slate-400 dark:text-slate-500">Current</p>
                            <p class="text-sm font-bold text-slate-900 dark:text-white mt-0.5">
                                <span x-text="currentRxFormatted"></span> <span class="text-amber-500">↓</span>
                            </p>
                        </div>
                        <div class="group">
                            <p class="text-xs font-medium text-slate-400 dark:text-slate-500">Peak</p>
                            <p class="text-sm font-bold text-slate-900 dark:text-white mt-0.5" x-text="peakRxFormatted"></p>
                        </div>
                        <div class="group">
                            <p class="text-xs font-medium text-slate-400 dark:text-slate-500">Download</p>
                            <p class="text-sm font-bold text-slate-900 dark:text-white mt-0.5" x-text="totalRxFormatted"></p>
                        </div>
                        <div class="group">
                            <p class="text-xs font-medium text-slate-400 dark:text-slate-500">Upload</p>
                            <p class="text-sm font-bold text-slate-900 dark:text-white mt-0.5" x-text="totalTxFormatted"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- No subscriptions placeholder -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 300ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 shadow-lg shadow-violet-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Bandwidth Usage</h2>
                </div>
            </div>
            <div class="p-5 text-center py-10">
                <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600">
                    <svg class="h-8 w-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <h3 class="mt-4 text-sm font-semibold text-slate-900 dark:text-white">No bandwidth data</h3>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Bandwidth data will appear once a subscription is active.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Contact, Billing, Tickets, Timeline -->
    <div class="space-y-6">
        <!-- Contact Info -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 200ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Contact Info</h2>
                </div>
                <a href="/admin/subscribers/{{ subscriber.id }}/edit" class="text-sm font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 transition-colors">Edit</a>
            </div>
            <div class="p-5 space-y-4">
                <div class="flex items-start gap-3 group">
                    <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 transition-colors">
                        <svg class="h-4.5 w-4.5 text-slate-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-900 dark:text-white truncate">{{ subscriber.person.email if subscriber.person else 'contact@company.com' }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Primary Email</p>
                    </div>
                </div>
                <div class="flex items-start gap-3 group">
                    <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 group-hover:bg-emerald-50 dark:group-hover:bg-emerald-900/20 transition-colors">
                        <svg class="h-4.5 w-4.5 text-slate-400 group-hover:text-emerald-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-900 dark:text-white">{{ subscriber.person.phone if subscriber.person else '(555) 123-4567' }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Primary Phone</p>
                    </div>
                </div>
                <div class="flex items-start gap-3 group">
                    <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 group-hover:bg-amber-50 dark:group-hover:bg-amber-900/20 transition-colors">
                        <svg class="h-4.5 w-4.5 text-slate-400 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        {% if primary_address %}
                        <p class="text-sm font-medium text-slate-900 dark:text-white">{{ primary_address.address_line1 }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ primary_address.city }}{% if primary_address.region %}, {{ primary_address.region }}{% endif %} {{ primary_address.postal_code or '' }}</p>
                        {% else %}
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">No address on file</p>
                        <p class="text-xs text-slate-400 dark:text-slate-500">Add an address to enable location features</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Mini-Map -->
        {% if map_data %}
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 225ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-lg shadow-emerald-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Location</h2>
                </div>
                <a href="/admin/network/map" class="text-sm font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 transition-colors">Full Map</a>
            </div>
            <div class="p-2">
                <div id="subscriber-mini-map" class="rounded-xl overflow-hidden" style="height: 200px;"></div>
            </div>
            <div class="px-5 pb-4 pt-2 text-xs text-slate-500 dark:text-slate-400">
                <div id="map-nearby-assets"></div>
            </div>
        </div>
        {% endif %}

        <!-- Billing Summary -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 250ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 shadow-lg shadow-emerald-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Billing</h2>
                </div>
                <a href="/admin/billing?subscriber={{ subscriber.id }}" class="text-sm font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 transition-colors">View All</a>
            </div>
            <div class="p-5">
                <div class="flex items-center justify-between mb-4 pb-4 border-b border-slate-100 dark:border-slate-700">
                    <div>
                        <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Current Balance</p>
                        <p class="text-2xl font-bold {% if (stats.balance_due | default(0)) > 0 %}text-red-600 dark:text-red-400{% else %}text-emerald-600 dark:text-emerald-400{% endif %} font-display">₦{{ "{:,.2f}".format(stats.balance_due | default(0)) }}</p>
                    </div>
                    <button class="rounded-xl bg-gradient-to-r from-emerald-500 to-green-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition-all hover:shadow-xl hover:-translate-y-0.5">Take Payment</button>
                </div>
                <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-3">Recent Invoices</p>
                {% if invoices %}
                <div class="space-y-2">
                    {% for invoice in invoices[:3] %}
                    {% set inv_status = invoice.status.value if invoice.status is not string and invoice.status else (invoice.status | default('draft')) %}
                    <div class="flex items-center justify-between py-2.5 px-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                        <div>
                            <p class="text-sm font-medium text-slate-900 dark:text-white group-hover:text-amber-600 dark:group-hover:text-amber-400 transition-colors">{{ invoice.invoice_number | default('Invoice') }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">{{ invoice.created_at.strftime('%b %d, %Y') if invoice.created_at else 'N/A' }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-slate-900 dark:text-white">₦{{ "{:,.2f}".format(invoice.total_amount | default(0)) }}</p>
                            {% if inv_status == 'paid' %}
                            <span class="inline-flex rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">Paid</span>
                            {% elif inv_status in ['pending', 'sent'] %}
                            <span class="inline-flex rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">Pending</span>
                            {% elif inv_status == 'overdue' %}
                            <span class="inline-flex rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-700 dark:bg-red-900/30 dark:text-red-400">Overdue</span>
                            {% else %}
                            <span class="inline-flex rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-400">{{ inv_status | title }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6">
                    <p class="text-sm text-slate-500 dark:text-slate-400">No invoices yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Communications -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 287ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 shadow-lg shadow-violet-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Communications</h2>
                </div>
                <a href="/admin/crm/inbox?person={{ subscriber.person_id }}" class="text-sm font-medium text-violet-600 hover:text-violet-700 dark:text-violet-400 transition-colors">View All</a>
            </div>
            <div class="p-5">
                <!-- Conversations -->
                {% if conversations %}
                <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-3">Recent Conversations</p>
                <div class="space-y-2 mb-4">
                    {% for conv in conversations[:3] %}
                    {% set conv_status = conv.status.value if conv.status is not string and conv.status else (conv.status | default('open')) %}
                    <a href="/admin/crm/inbox/conversation/{{ conv.id }}" class="flex items-start gap-3 p-3 rounded-xl hover:bg-gradient-to-r hover:from-violet-50/50 hover:to-purple-50/30 dark:hover:from-violet-900/10 dark:hover:to-purple-900/5 transition-all group">
                        <span class="flex h-8 w-8 items-center justify-center rounded-lg text-xs font-bold
                            {% if conv_status == 'open' %}bg-gradient-to-br from-emerald-100 to-green-100 text-emerald-700 dark:from-emerald-900/40 dark:to-green-900/30 dark:text-emerald-400
                            {% elif conv_status == 'pending' %}bg-gradient-to-br from-amber-100 to-orange-100 text-amber-700 dark:from-amber-900/40 dark:to-orange-900/30 dark:text-amber-400
                            {% else %}bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        </span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-slate-900 dark:text-white truncate group-hover:text-violet-600 dark:group-hover:text-violet-400 transition-colors">{{ conv.subject | default('No subject') }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">{{ conv.last_message_at.strftime('%b %d, %H:%M') if conv.last_message_at else conv.created_at.strftime('%b %d, %H:%M') }}</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Notifications -->
                {% if notifications %}
                <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide mb-3">Recent Notifications</p>
                <div class="space-y-2">
                    {% for notif in notifications[:3] %}
                    {% set notif_status = notif.status.value if notif.status is not string and notif.status else (notif.status | default('queued')) %}
                    {% set notif_channel = notif.channel.value if notif.channel is not string and notif.channel else (notif.channel | default('email')) %}
                    <div class="flex items-start gap-3 p-3 rounded-xl bg-slate-50/50 dark:bg-slate-700/30">
                        <span class="flex h-8 w-8 items-center justify-center rounded-lg
                            {% if notif_channel == 'email' %}bg-violet-100 text-violet-600 dark:bg-violet-900/40 dark:text-violet-400
                            {% elif notif_channel == 'sms' %}bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400
                            {% elif notif_channel == 'whatsapp' %}bg-emerald-100 text-emerald-600 dark:bg-emerald-900/40 dark:text-emerald-400
                            {% else %}bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400{% endif %}">
                            {% if notif_channel == 'email' %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            {% elif notif_channel == 'sms' %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                            {% else %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                            {% endif %}
                        </span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-slate-900 dark:text-white truncate">{{ notif.subject | default('Notification') }}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="inline-flex rounded-full px-2 py-0.5 text-xs font-medium
                                    {% if notif_status == 'delivered' %}bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400
                                    {% elif notif_status == 'failed' %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400
                                    {% elif notif_status == 'sending' %}bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400
                                    {% else %}bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400{% endif %}">
                                    {{ notif_status | title }}
                                </span>
                                <span class="text-xs text-slate-400 dark:text-slate-500">{{ notif.created_at.strftime('%b %d, %H:%M') }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if not conversations and not notifications %}
                <div class="text-center py-6">
                    <p class="text-sm text-slate-500 dark:text-slate-400">No communications yet</p>
                    <a href="/admin/crm/inbox" class="mt-2 inline-block text-sm font-semibold text-violet-600 hover:text-violet-700 dark:text-violet-400 transition-colors">Open Inbox</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="section-card rounded-2xl border border-slate-200/60 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-800 animate-fade-in-up" style="animation-delay: 300ms;">
            <div class="flex items-center justify-between border-b border-slate-200/60 px-5 py-4 dark:border-slate-700/60">
                <div class="flex items-center gap-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-slate-500 to-slate-600 shadow-lg shadow-slate-500/25">
                        <svg class="h-4.5 w-4.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Activity</h2>
                </div>
            </div>
            <div class="p-5">
                {% if timeline %}
                <div class="relative">
                    <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gradient-to-b from-amber-200 via-slate-200 to-slate-100 dark:from-amber-800 dark:via-slate-700 dark:to-slate-800"></div>
                    <div class="space-y-4">
                        {% for event in timeline %}
                        <div class="relative flex items-start gap-4 pl-10">
                            <div class="absolute left-0 flex h-8 w-8 items-center justify-center rounded-full bg-white dark:bg-slate-800 border-2 shadow-sm
                                {% if event.type == 'payment' %}border-emerald-500
                                {% elif event.type == 'service' %}border-amber-500
                                {% elif event.type == 'ticket' %}border-violet-500
                                {% else %}border-slate-300 dark:border-slate-600{% endif %}">
                                {% if event.type == 'payment' %}
                                <svg class="h-3.5 w-3.5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                {% elif event.type == 'service' %}
                                <svg class="h-3.5 w-3.5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                {% elif event.type == 'ticket' %}
                                <svg class="h-3.5 w-3.5 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
                                {% else %}
                                <svg class="h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0 pt-1">
                                <p class="text-sm font-medium text-slate-900 dark:text-white">{{ event.title }}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">{{ event.detail }} · <span class="text-slate-400 dark:text-slate-500">{{ event.time }}</span></p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600">
                        <svg class="h-7 w-7 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="mt-3 text-sm font-medium text-slate-500 dark:text-slate-400">No activity yet</p>
                    <p class="text-xs text-slate-400 dark:text-slate-500">Activity will appear here as you interact with this subscriber.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Subscription Modal -->
<div x-data="{ open: false }"
     @open-subscription-modal.window="open = true"
     @keydown.escape.window="open = false"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto">
    <!-- Backdrop -->
    <div x-show="open"
         x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
         @click="open = false"
         class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>

    <!-- Modal -->
    <div class="flex min-h-full items-center justify-center p-4">
        <div x-show="open"
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
             @click.stop
             class="relative w-full max-w-lg rounded-2xl bg-white shadow-2xl dark:bg-slate-800">

            <!-- Header -->
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Add Subscription</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Select a plan for {{ subscriber.person.first_name if subscriber.person else 'this subscriber' }}</p>
                </div>
                <button type="button" @click="open = false" class="rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 dark:hover:bg-slate-700 dark:hover:text-slate-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Form -->
            <form method="POST" action="/admin/catalog/subscriptions" class="p-6 space-y-5">
                <input type="hidden" name="subscriber_id" value="{{ subscriber.id }}">
                {% if accounts and accounts|length == 1 %}
                <input type="hidden" name="account_id" value="{{ accounts[0].id }}">
                {% elif accounts and accounts|length > 1 %}
                <div>
                    <label for="modal_account_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Account</label>
                    <select name="account_id" id="modal_account_id" required
                        class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-amber-500 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        {% for account in accounts %}
                        <option value="{{ account.id }}">{{ account.account_number or ('Account #' ~ loop.index) }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div>
                    <label for="modal_offer_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Plan / Tariff <span class="text-red-500">*</span></label>
                    <select name="offer_id" id="modal_offer_id" required
                        class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-amber-500 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <option value="" disabled selected>Select a plan</option>
                        {% for offer in offers or [] %}
                        <option value="{{ offer.id }}">{{ offer.name }}{% if offer.prices and offer.prices|length > 0 %} - ₦{{ "{:,.0f}".format(offer.prices[0].amount) }}/mo{% endif %}</option>
                        {% endfor %}
                    </select>
                    {% if not offers %}
                    <p class="mt-2 text-xs text-amber-600 dark:text-amber-400">No active plans found. <a href="/admin/catalog/offers/new" class="underline">Create a tariff</a> first.</p>
                    {% endif %}
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal_contract_term" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Contract Term</label>
                        <select name="contract_term" id="modal_contract_term"
                            class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-amber-500 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                            {% for term in contract_terms or ['month_to_month', 'twelve_month', 'twentyfour_month'] %}
                            <option value="{{ term }}">{{ term.replace('_', ' ') | title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="modal_status" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Status</label>
                        <select name="status" id="modal_status"
                            class="mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-amber-500 focus:ring-amber-500 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                            {% for status in subscription_statuses or ['pending', 'active', 'suspended', 'canceled'] %}
                            <option value="{{ status }}" {% if status == 'pending' %}selected{% endif %}>{{ status | title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <p class="text-xs text-slate-500 dark:text-slate-400">
                    <svg class="inline h-3.5 w-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Pending subscriptions automatically create a service order for installation.
                </p>

                <!-- Actions -->
                <div class="flex items-center justify-end gap-3 pt-2">
                    <button type="button" @click="open = false" class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600">
                        Cancel
                    </button>
                    <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-amber-500 to-orange-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-amber-500/25 hover:shadow-xl transition-all">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Add Subscription
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js for bandwidth charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="/static/js/charts.js"></script>
<script src="/static/js/bandwidth-chart.js"></script>

{% if map_data %}
<!-- Leaflet JS for mini-map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    const mapData = {{ map_data | tojson | safe }};
    if (!mapData || !mapData.center) return;

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Initialize mini-map
    const map = L.map('subscriber-mini-map', {
        zoomControl: false,
        attributionControl: false
    }).setView(mapData.center, 15);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Custom icons
    const icons = {
        customer: L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#f59e0b,#ea580c);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 4px 12px rgba(245,158,11,0.4)"><svg style="width:14px;height:14px;color:white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg></div>',
            className: '',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
        }),
        fdh_cabinet: L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 8px rgba(139,92,246,0.4)"><svg style="width:12px;height:12px;color:white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/></svg></div>',
            className: '',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
        }),
        splice_closure: L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#14b8a6,#0d9488);width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 6px rgba(20,184,166,0.4)"></div>',
            className: '',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
        })
    };

    // Track nearby assets for summary
    const nearbyAssets = { fdh: [], closure: [] };

    // Add features
    if (mapData.geojson && mapData.geojson.features) {
        mapData.geojson.features.forEach(feature => {
            const p = feature.properties;
            const coords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            const icon = icons[p.type] || icons.customer;
            const marker = L.marker(coords, { icon: icon }).addTo(map);

            if (p.type === 'fdh_cabinet') {
                nearbyAssets.fdh.push({ name: p.name, distance: p.distance_m });
                marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${p.distance_m}m away`);
            } else if (p.type === 'splice_closure') {
                nearbyAssets.closure.push({ name: p.name, distance: p.distance_m });
                marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${p.distance_m}m away`);
            } else if (p.type === 'customer') {
                marker.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${escapeHtml(p.address)}`);
            }
        });
    }

    // Show nearby assets summary
    const summaryEl = document.getElementById('map-nearby-assets');
    if (summaryEl) {
        let html = '';
        if (nearbyAssets.fdh.length > 0) {
            const nearest = nearbyAssets.fdh.sort((a, b) => a.distance - b.distance)[0];
            html += `<span class="inline-flex items-center gap-1.5 mr-3"><span class="h-2.5 w-2.5 rounded bg-gradient-to-r from-violet-500 to-purple-600"></span>Nearest FDH: ${escapeHtml(nearest.name)} (${nearest.distance}m)</span>`;
        }
        if (nearbyAssets.closure.length > 0) {
            html += `<span class="inline-flex items-center gap-1.5"><span class="h-2.5 w-2.5 rounded-full bg-gradient-to-r from-teal-500 to-emerald-500"></span>${nearbyAssets.closure.length} splice closure${nearbyAssets.closure.length > 1 ? 's' : ''} nearby</span>`;
        }
        if (!html) {
            html = '<span class="text-slate-400 dark:text-slate-500">No nearby infrastructure found</span>';
        }
        summaryEl.innerHTML = html;
    }
})();
</script>
{% endif %}
{% endblock %}
