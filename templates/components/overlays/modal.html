{#
   Modal Component
   Usage: {% include "components/overlays/modal.html" %}

   Parameters:
   - name: Modal identifier (required)
   - title: Modal title
   - size: sm, md, lg, xl, full (default: md)
   - show_footer: Boolean (default: true)
   - form_id: Form ID for submit button
   - submit_label: Submit button label
   - close_on_backdrop: Boolean (default: true)
   - slide_from: right (optional)
   - allow_background_interaction: Boolean (default: false)
#}
{% set sizes = {
    'sm': 'max-w-sm',
    'md': 'max-w-lg',
    'lg': 'max-w-2xl',
    'xl': 'max-w-4xl',
    'full': 'max-w-full mx-4'
} %}

<div x-data="{ open: false, focusables: [], first: null, last: null }"
     x-on:open-modal.window="if ($event.detail.name === '{{ name }}') { open = true; $nextTick(() => { focusables = $refs.modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex=\'-1\'])'); first = focusables[0]; last = focusables[focusables.length - 1]; ($refs.modal)?.focus(); if (first) first.focus(); }) }"
     x-on:close-modal.window="if ($event.detail.name === '{{ name }}') open = false"
     x-on:keydown.escape.window="open = false"
     x-on:keydown.tab.prevent="if (!open) return; if (!first || !last) { $event.preventDefault(); return; } if ($event.shiftKey && document.activeElement === first) { last.focus(); return; } if (!$event.shiftKey && document.activeElement === last) { first.focus(); }"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto {% if allow_background_interaction %}pointer-events-none{% endif %}"
     role="dialog"
     aria-modal="true"
     aria-labelledby="modal-title-{{ name }}">

    <!-- Backdrop -->
    <div x-show="open"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         {% if close_on_backdrop is not false %}x-on:click="open = false"{% endif %}
         class="fixed inset-0 bg-slate-900/60 {% if allow_background_interaction %}pointer-events-none bg-slate-900/20 dark:bg-slate-900/40{% else %}backdrop-blur-sm dark:bg-slate-900/80{% endif %}"></div>

    <!-- Modal Panel -->
    <div class="{% if slide_from == 'right' %}flex min-h-full items-stretch justify-end p-0{% else %}flex min-h-full items-center justify-center p-4{% endif %}">
        <div x-show="open"
             x-transition:enter="ease-out duration-300"
             {% if slide_from == 'right' %}
             x-transition:enter-start="opacity-0 translate-x-full"
             x-transition:enter-end="opacity-100 translate-x-0"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-x-0"
             x-transition:leave-end="opacity-0 translate-x-full"
             {% else %}
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             {% endif %}
             x-on:click.stop
             x-ref="modal"
             tabindex="-1"
             class="relative w-full {{ sizes[size | default('md')] }} rounded-2xl bg-white shadow-2xl dark:bg-slate-800 {% if slide_from == 'right' %}h-full rounded-none sm:rounded-l-2xl{% endif %} {% if allow_background_interaction %}pointer-events-auto{% endif %}">

            <!-- Header -->
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <h3 id="modal-title-{{ name }}" class="text-lg font-semibold text-slate-900 dark:text-white">{{ title }}</h3>
                <button x-on:click="open = false"
                        aria-label="Close modal"
                        class="flex h-8 w-8 items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-500 dark:hover:bg-slate-700 dark:hover:text-slate-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="px-6 py-4">
                {% if body_html %}
                    {{ body_html | safe }}
                {% elif body_id %}
                    <div id="{{ body_id }}"></div>
                {% else %}
                    {% block modal_content %}{% endblock %}
                {% endif %}
            </div>

            <!-- Footer -->
            {% if show_footer is not false %}
            <div class="flex items-center justify-end gap-3 border-t border-slate-200 px-6 py-4 dark:border-slate-700">
                {% block modal_footer %}
                <button x-on:click="open = false"
                        type="button"
                        class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600">
                    Cancel
                </button>
                {% if form_id %}
                <button type="submit"
                        form="{{ form_id }}"
                        class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800">
                    {{ submit_label | default('Save') }}
                </button>
                {% endif %}
                {% endblock %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
