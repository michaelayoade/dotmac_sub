(function () {
  function trapPlugin(Alpine) {
    Alpine.directive(
      "trap",
      (el, { expression, modifiers }, { evaluateLater, effect, cleanup }) => {
        const evaluate = evaluateLater(expression);
        const focusableSelector =
          'a[href],area[href],input:not([disabled]):not([type="hidden"]),select:not([disabled]),textarea:not([disabled]),button:not([disabled]),iframe,object,embed,[contenteditable],[tabindex]:not([tabindex="-1"])';
        let enabled = false;
        let lastFocused = null;
        let inerted = [];
        let overflowState = null;

        const getFocusable = () =>
          Array.from(el.querySelectorAll(focusableSelector)).filter(
            (node) => !node.hasAttribute("disabled") && node.tabIndex !== -1
          );

        const handleKeydown = (event) => {
          if (event.key !== "Tab") return;
          const focusable = getFocusable();
          if (focusable.length === 0) {
            event.preventDefault();
            return;
          }
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (event.shiftKey && document.activeElement === first) {
            event.preventDefault();
            last.focus({ preventScroll: true });
          } else if (!event.shiftKey && document.activeElement === last) {
            event.preventDefault();
            first.focus({ preventScroll: true });
          }
        };

        const enableTrap = () => {
          lastFocused = document.activeElement;
          if (modifiers.includes("noscroll")) {
            overflowState = {
              body: document.body.style.overflow,
              html: document.documentElement.style.overflow,
            };
            document.body.style.overflow = "hidden";
            document.documentElement.style.overflow = "hidden";
          }
          if (modifiers.includes("inert")) {
            const siblings = Array.from(document.body.children).filter(
              (child) => !child.contains(el)
            );
            inerted = siblings;
            siblings.forEach((child) => {
              child.setAttribute("inert", "");
            });
          }
          const focusable = getFocusable();
          if (focusable.length > 0) {
            focusable[0].focus({ preventScroll: true });
          } else {
            el.setAttribute("tabindex", "-1");
            el.focus({ preventScroll: true });
          }
          document.addEventListener("keydown", handleKeydown, true);
        };

        const disableTrap = () => {
          document.removeEventListener("keydown", handleKeydown, true);
          if (modifiers.includes("inert")) {
            inerted.forEach((child) => {
              child.removeAttribute("inert");
            });
            inerted = [];
          }
          if (modifiers.includes("noscroll") && overflowState) {
            document.body.style.overflow = overflowState.body || "";
            document.documentElement.style.overflow = overflowState.html || "";
            overflowState = null;
          }
          if (lastFocused && typeof lastFocused.focus === "function") {
            lastFocused.focus({ preventScroll: true });
          }
        };

        effect(() => {
          evaluate((value) => {
            const shouldEnable = !!value;
            if (shouldEnable === enabled) return;
            enabled = shouldEnable;
            if (enabled) {
              enableTrap();
            } else {
              disableTrap();
            }
          });
        });

        cleanup(() => {
          if (enabled) disableTrap();
        });
      }
    );
  }

  document.addEventListener("alpine:init", () => {
    if (window.Alpine) {
      window.Alpine.plugin(trapPlugin);
    }
  });
})();
