# API Scan Report — Cycle 10
**Date:** 2026-02-28
**Scan type:** api
**Files scanned:** All files under `app/api/` (30+ files, ~1,800+ route endpoints)

---

## Summary

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High     | 0 |
| Medium   | 5 |
| Low      | 3 |
| **Total**| **8** |

The API layer is progressively improving. Previous cycles closed multiple response_model and permission gaps. This cycle's findings are concentrated in pagination consistency, spatial endpoint safety, and a handful of style/documentation issues — no new security-critical gaps were found.

---

## Findings

### Medium

| ID | File | Line | Issue |
|----|------|------|-------|
| api-c10-1 | `app/api/wireguard.py` | 37, 130 | `list_servers` and `list_peers` return bare `list[X]` instead of `ListResponse[X]` despite having limit/offset params |
| api-c10-2 | `app/api/wireguard.py` | 331 | `list_peer_connection_logs` does Pydantic construction in route handler (thin-wrapper violation) + bare list without `ListResponse` |
| api-c10-3 | `app/api/gis.py` | 103, 122 | `find_nearby_locations` and `find_locations_in_area` have no limit parameter — unbounded spatial queries |
| api-c10-4 | `app/api/gis.py` | 223 | `find_areas_containing_point` has no limit — unbounded result set |
| api-c10-5 | `app/api/nas.py` | 282 | `preview_template` has no `response_model` and builds raw dict in route handler |

### Low

| ID | File | Line | Issue |
|----|------|------|-------|
| api-c10-6 | `app/api/bandwidth.py` | 114, 240 | SSE endpoints missing `response_model` / `summary` — event payload shape undocumented |
| api-c10-7 | `app/api/provisioning.py`, `nas.py` | 108+ | Literal `status_code=201`/`204` instead of `status.HTTP_201_CREATED`/`HTTP_204_NO_CONTENT` — 19 occurrences |
| api-c10-8 | `app/api/bandwidth.py` | 162 | `get_top_users` returns bare `list[TopUserEntry]` without `ListResponse` wrapper |

---

## Comparison with Previous Cycles

### What's new (cycle 10 only)
- Spatial query endpoints (`gis.py`) returning unbounded lists with no limit guard — could cause large memory spikes on GIS-dense deployments
- `wireguard.py` list endpoints using bare `list[X]` despite having pagination params — clients can't determine total counts
- `nas.py:preview_template` building dict in route handler (thin-wrapper violation, no response schema)
- Literal integer status codes in `provisioning.py`/`nas.py` vs named constants everywhere else

### What remains open from prior cycles (not fixed yet)
- `app/api/wireguard.py:49,149` N+1 — `to_read_schema()` per item in list handlers (api cycle 3 / quality cycle 6)
- `app/api/analytics.py:82` — unbounded `list[KPIReadout]` with no pagination (api cycle 7)
- `app/api/nas.py:136,342,373` — `response_model=dict` on list endpoints (api cycle 7)
- `app/api/provisioning.py:79,180,264,349,416,515,601` — `response_model=dict` on list endpoints (api cycle 3)
- `app/api/search.py:140` — `GET /search/global` no `response_model` (api cycle 7)
- `app/api/tables.py:78` — no bounds on limit/offset (api cycle 7)
- `app/api/nextcloud_talk.py` — `response_model=dict` / `list[dict]` (api cycle 3)
- `app/api/gis.py:207` — `response_model=dict` on contains-point endpoint (api cycle 7)
- `app/api/billing.py:76` — no response_model on billing dashboard (api cycle 3)
- `app/api/imports.py:10` — no response_model + no permission (api cycle 7)

### What was fixed between cycles 9 → 10
_(No api-specific fixes merged since cycle 9 — pm-agent queue likely has pending tasks)_

---

## Top 3 Priority Fixes

1. **api-c10-3** — Add limit/offset to spatial query endpoints in `gis.py` (unbounded DB queries, possible memory/performance risk on large GIS datasets; trivial fix)
2. **api-c10-1** — Wrap WireGuard list endpoints in `ListResponse` (clients currently can't paginate correctly; small effort, breaks API contract if not fixed before next major release)
3. **api-c10-5** — Create `TemplatePreviewResponse` schema for `nas.py:preview_template` (fixes thin-wrapper violation and adds OpenAPI documentation for an important provisioning workflow endpoint)

---

## Codebase Health Score

**55 / 100**

Scoring rationale:
- Strong CRUD consistency with `ListResponse`, typed schemas, and `require_permission` across the majority of the codebase (+)
- No new critical or high findings in this cycle (+)
- ~15 open `response_model=dict` endpoints from prior cycles still unaddressed (-)
- Spatial endpoints with no result limits are a latent perf risk (-)
- Thin-wrapper violations in wireguard and nas (-)
- Literal status codes indicate inconsistent code review standards (-)

---

## Trend

**Stable → Slightly Improving**

The number of critical/high findings is zero this cycle (down from 4 in cycle 8 and 3 in cycle 9). Medium findings remain steady. The backlog of `response_model=dict` issues from earlier cycles is the main drag on the health score; once the PM assigns and closes those, the score should jump to 65+.
