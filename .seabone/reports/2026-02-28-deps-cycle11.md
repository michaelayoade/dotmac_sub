# Deps Scan Report — Cycle 11
**Date:** 2026-02-28
**Type:** deps
**Scan scope:** `app/`, `pyproject.toml`, `poetry.lock`, `stubs/`

---

## Summary

9 findings: 0 Critical / 3 High / 3 Medium / 3 Low

| ID | Severity | File | Issue |
|----|----------|------|-------|
| deps-c11-1 | HIGH | `app/tasks/olt_config_backup.py:33` | `pysnmp` used but undeclared + not installed |
| deps-c11-2 | HIGH | `app/services/auth_flow.py:12` | `python-jose` CVE-2024-33663/33664 still present despite fix-deps-003 |
| deps-c11-3 | HIGH | `app/services/auth_flow.py:13` | `passlib 1.7.4` unmaintained, bcrypt 5.x incompatibility |
| deps-c11-4 | MEDIUM | `app/poller/mikrotik_poller.py:87` | `asyncio.get_event_loop()` deprecated (×5) |
| deps-c11-5 | MEDIUM | `app/services/nas.py:885` | `requests` undeclared + minimal stub misses `get()` |
| deps-c11-6 | MEDIUM | `app/api/bandwidth.py:13` | `anyio` used directly but not declared |
| deps-c11-7 | LOW | `pyproject.toml:40` | `shapely` declared but never imported in `app/` |
| deps-c11-8 | LOW | `pyproject.toml:44` | `boto3` missing type stubs (`boto3-stubs[s3]`) |
| deps-c11-9 | LOW | `pyproject.toml:42` | `aiosmtpd` declared but never imported |

---

## Comparison with Previous Findings

### New this cycle
- **deps-c11-1** (`pysnmp` undeclared/uninstalled) — genuinely new, not previously recorded
- **deps-c11-4** (`asyncio.get_event_loop()` deprecated ×5 in `mikrotik_poller.py`) — new
- **deps-c11-7** (`shapely` declared but unused) — new; geoalchemy2 lists shapely as its own dep
- **deps-c11-8** (`boto3` missing `boto3-stubs[s3]`) — new

### Still open from cycle 4 (not yet fixed)
- **deps-c11-2** — `python-jose` CVE: fix-deps-003 was marked complete but `from jose import` still present in `auth_flow.py:12` and `observability.py:6`
- **deps-c11-3** — `passlib 1.7.4` (fix-deps-004): never appeared in the Already Fixed list; passlib import still at `auth_flow.py:13`
- **deps-c11-5** — `requests` undeclared + stub gap: `nas.py:885,2128` still use `import requests` inside function bodies; `stubs/requests/__init__.pyi` still only covers `post()` but `nas.py:905,915` calls `requests.get()`
- **deps-c11-6** — `anyio` undeclared: `bandwidth.py:13` and `request_parsing.py:7` still use `import anyio`
- **deps-c11-9** — `aiosmtpd` unused dep: still in pyproject.toml, zero app/ imports

### Fixed since last deps cycle (cycle 4 → cycle 11)
Approximately 12 deps fixes were completed (fix-deps-005 through fix-deps-015), addressing:
- Transitive `requests` usage in provisioning, legacy imports
- Undeclared packages in tasks and poller code
- CI pipeline dependency issues

---

## Top 3 Priority Fixes

### 1. Replace `python-jose` with `PyJWT` (deps-c11-2) — HIGH, effort: small
`python-jose 3.3.0` has two known CVEs (algorithm confusion attacks on JWT verification). fix-deps-003 was supposed to fix this but the `from jose import` lines are still in `auth_flow.py:12` and `observability.py:6`. `PyJWT` is a better-maintained alternative already transitively available. Exploiting these CVEs requires a crafted JWT, so any endpoint that accepts user tokens is at risk.

### 2. Replace `passlib` with direct `bcrypt` calls (deps-c11-3) — HIGH, effort: small
`passlib 1.7.4` is unmaintained (last release 2020). The installed `bcrypt 5.0+` removed the `bcrypt.__about__` attribute that passlib introspects, causing a `AttributeError` warning at startup or worse. fix-deps-004 was never created. Migrating to direct `bcrypt.hashpw`/`bcrypt.checkpw` calls (or `argon2-cffi`) removes the unmaintained library and the startup warning.

### 3. Add `pysnmp-lextudio` to pyproject.toml (deps-c11-1) — HIGH, effort: trivial
`pysnmp` is imported (guarded by `ImportError`) in OLT config backup and OLT views but is not in pyproject.toml or poetry.lock. This means SNMP-based config backup silently does nothing in all production environments. Adding `pysnmp-lextudio` (the maintained fork replacing abandoned `pysnmp`) as an optional dependency fixes the silent breakage.

---

## Codebase Health Score

**52 / 100** *(stable vs cycle 10's 55/100; deps-focused cycle reveals lingering CVEs)*

| Category | Assessment |
|----------|------------|
| Declared deps completeness | 72% — `pysnmp`, `anyio`, and historically `requests` are undeclared |
| CVE exposure | Poor — `python-jose` CVE-2024-33663/33664 fix incomplete; `passlib` unmaintained |
| Type coverage | Good — stubs exist for paramiko/requests; gap in boto3 and pysnmp |
| Deprecated API usage | Minor — `get_event_loop()` ×5 in one file |
| Unused deps bloat | Minor — `aiosmtpd` and `shapely` can be removed |

---

## Trend: Stable (slightly degrading on security)

- **Cycle 4 baseline:** 4 findings, score 58/100
- **Cycle 11:** 9 findings (including 4 previously-open cycle 4 regressions + 4 new), score 52/100
- The `python-jose` and `passlib` CVE/security fixes from cycle 4 remain incomplete; each passing cycle without remediation increases exposure window. 4 new findings (pysnmp, get_event_loop, shapely, boto3-stubs) are low-effort cleanups.
- **Improving areas:** ~12 other deps fixes landed between cycles; transitive-dep cleanup was thorough.
- **Degrading areas:** Security-sensitive deps (jose, passlib) are still not replaced 1 day after being identified.
