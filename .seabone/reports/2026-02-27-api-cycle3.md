# API Cycle 3 Scan Report — 2026-02-27

## Summary

**Scan type:** API layer audit
**Files scanned:** 39 files in `app/api/`
**New findings:** 11
**Severity breakdown:** 0 Critical / 3 High / 8 Medium / 0 Low

The API layer is largely well-structured — most endpoints use proper Pydantic `response_model`, pagination with validated `limit`/`offset` parameters, and consistent `status.HTTP_*` constants. The primary systemic gap is **missing or weak `response_model` declarations** on utility and action endpoints, and **N+1 query patterns** in the WireGuard list endpoints.

---

## New Findings (11)

| ID | Severity | File | Issue |
|----|----------|------|-------|
| api-c3-1 | HIGH | `app/api/wireguard.py:49` | N+1: `list_servers` calls `get_peer_count` DB query per server |
| api-c3-2 | HIGH | `app/api/wireguard.py:149` | N+1: `list_peers` queries server name per peer |
| api-c3-3 | HIGH | `app/api/billing.py:76` | `billing_dashboard` has no `response_model`; also has local import inside function body |
| api-c3-4 | MEDIUM | `app/api/gis.py:207` | `check_area_contains_point` uses `response_model=dict` |
| api-c3-5 | MEDIUM | `app/api/provisioning.py:68` | `get_order_stats` has no `response_model` |
| api-c3-6 | MEDIUM | `app/api/scheduler.py:58` | `refresh_schedule` and `enqueue_scheduled_task` have no `response_model` |
| api-c3-7 | MEDIUM | `app/api/integrations.py:111` | `refresh_integration_schedule` has no `response_model` |
| api-c3-8 | MEDIUM | `app/api/nas.py:194` | `get_backup_content` and `compare_backups` have no `response_model` |
| api-c3-9 | MEDIUM | `app/api/nas.py:397` | 4 utility enum-list endpoints (`/vendors`, `/connection-types`, `/provisioning-actions`, `/backup-methods`) have no `response_model` |
| api-c3-10 | MEDIUM | `app/api/nextcloud_talk.py:30` | All 3 Nextcloud Talk endpoints use `response_model=dict`/`list[dict]` |
| api-c3-11 | MEDIUM | `app/api/fiber_plant.py:12` | All 4 fiber plant endpoints have no `response_model` |

---

## Comparison with Previous Findings

### Still Open from Previous Cycles
- **quality-c2-13** (MEDIUM): `nas.py` (5 endpoints) and `provisioning.py` (7 endpoints) use `response_model=dict` — this cycle found that `provisioning.py:79` (`list_orders`) still has this issue; `nas.py:222` (`list_provisioning_templates`), `nas.py:342/373` (logs) still unaddressed.

### Newly Discovered This Cycle
All 11 findings above are new and not previously reported.

### What Was Fixed
The `fix-security-c1-*` series addressed a large number of security findings. The `frontend-audit` and `security-tests-c1` work is complete. No API-specific fixes were tracked in the "Already Fixed" list prior to this cycle.

---

## Top 3 Priority Fixes

### 1. `api-c3-1` + `api-c3-2` — WireGuard N+1 Queries (HIGH, effort: small)
**Why:** The `list_servers` and `list_peers` endpoints fire one extra DB query per row. At 50 servers (default limit), that is 51 DB round-trips for a single API call. This degrades under any meaningful WireGuard deployment. Fix with a single `GROUP BY` query for peer counts and a batch `IN (...)` for server name lookups.

### 2. `api-c3-3` — Billing Dashboard Missing Response Model (HIGH, effort: medium)
**Why:** `/api/v1/billing/dashboard` is likely polled by admin UIs and external consumers. Without a `response_model`, FastAPI cannot validate the output, the OpenAPI spec is silent on the schema, and the local-import anti-pattern adds unnecessary overhead on every call. Defining `BillingDashboardRead` also provides a contract for the `get_dashboard_stats()` return value.

### 3. `api-c3-9` — NAS Utility Enum Endpoints Missing Response Models (MEDIUM, effort: small)
**Why:** The four enum-list endpoints (`/vendors`, `/connection-types`, `/provisioning-actions`, `/backup-methods`) are consumed by frontend dropdowns. Without `response_model`, changes to their structure are invisible to the API contract, and the OpenAPI docs show no schema. A shared `EnumOption` schema is a one-time trivial definition that fixes all four.

---

## Codebase Health Score

**Score: 58 / 100**

| Dimension | Score | Notes |
|-----------|-------|-------|
| Response model coverage | 55/100 | ~85% of endpoints have typed models; gaps in utility/action endpoints |
| Pagination | 90/100 | Well-implemented across list endpoints |
| Auth & permissions | 75/100 | Router-level auth in place; some per-endpoint gaps (prior findings) |
| Query efficiency | 60/100 | N+1 in WireGuard; N+1 in enforcement (prior finding quality-c2-6) |
| Error consistency | 80/100 | HTTPException usage is consistent |
| OpenAPI documentation | 45/100 | Many endpoints lack summary/description; missing response models |

---

## Trend

**Stable → Slightly Improving**

- Security posture has improved significantly (30+ security fixes merged)
- Quality debt (SQLAlchemy 1.x, db.commit in services) remains open but is large-batch work
- API layer is fundamentally sound; the missing `response_model` issues are cosmetic/contract gaps rather than runtime failures
- No regressions detected vs. previous scans
