# API Quality Scan — Cycle 7
**Date:** 2026-02-27
**Scan type:** api
**Files scanned:** 39 API files (`app/api/*.py`)

---

## Summary

| Severity | Count |
|----------|-------|
| High     | 1     |
| Medium   | 7     |
| Low      | 2     |
| **Total**| **10**|

All 10 findings are new — none were reported in previous cycles.

---

## What's New (Cycle 7)

The cycle 7 scan focused on gaps that cycle 3 missed:

### New High-severity
- **`imports.py`** — The file-upload import endpoint has neither a `response_model` nor a `require_permission` dependency. Any authenticated user can trigger bulk CSV imports.

### New Medium-severity
- **`analytics.py:82`** — `GET /analytics/kpis` returns an unbounded `list[KPIReadout]` with no pagination; as KPI config count grows this becomes a slow, uncontrolled endpoint.
- **`nas.py:136,342,373`** — Three NAS list endpoints (device backups, provisioning logs, device logs) use `response_model=dict` — service layer returns correct `ListResponse` format but the API contract is invisible to OpenAPI/mypy.
- **`nas.py:222,281`** — Templates list uses `response_model=dict`; preview endpoint has no `response_model` at all.
- **`nas.py:89`** — Device stats endpoint has no `response_model`.
- **`gis.py:368`** — `POST /gis/sync` has no `response_model`.
- **`search.py:140`** — `GET /search/global` is the only endpoint in `search.py` without a `response_model` (all 12 siblings have `ListResponse[TypeaheadItem]`).
- **`tables.py:78`** — `GET /tables/{table_key}/data` extracts `limit`/`offset` from raw query params dict with no bounds validation; callers can request `?limit=999999`.

### New Low-severity
- **`imports.py`** — No docstring on the single import endpoint.
- **`nas.py:397-437`** — Four NAS enum utility endpoints have no `response_model` (different from cycle 3's "utility endpoints" note — these are the enum-list endpoints returning raw dicts without even `list[str]` typing).

---

## Comparison With Previous Cycles

### Still Open from Cycle 3 (api)
These were identified in cycle 3 and are NOT fixed yet (remain in open findings):
- `api/wireguard.py:49,149` — N+1 in list_servers / list_peers
- `api/billing.py:76` — no `response_model` on billing_dashboard + in-function import
- `fiber_plant.py` — 4 endpoints without `response_model`
- `nas.py` — `/backups/{id}/content`, `/backups/compare` missing `response_model`
- `provisioning.py:68` — `/orders/stats` missing `response_model`
- `scheduler.py:58,63` — refresh/enqueue missing `response_model`
- `integrations.py:111` — refresh-schedule missing `response_model`
- `nextcloud_talk.py` — all 3 endpoints `response_model=dict`/`list[dict]`
- `gis.py:207` — `/areas/{id}/contains-point` weak `response_model=dict`

### Fixed Since Last Scan
No API-specific fixes have been merged since cycle 3 (no fix tasks for API issues appear in the Already Fixed list in MEMORY.md).

---

## Top 3 Priority Fixes

### 1. `imports.py` — File upload without permission check (HIGH)
**Why:** A bulk import endpoint that any authenticated user can call is an authorization gap. Adding `require_permission("subscriber:write")` is a one-line fix that closes an access-control hole. Also add `response_model` for type safety.

**Fix:** Add `dependencies=[Depends(require_permission("subscriber:write"))]` and a `response_model=ImportResult` to the decorator.

### 2. `tables.py:78` — Unbounded pagination (MEDIUM)
**Why:** The dynamic table data endpoint bypasses the `Query(ge=1, le=200)` guard used by every other list endpoint. An attacker (or misbehaving client) can request `?limit=999999` against any registered table, potentially dumping the entire table in one response and causing an OOM or timeout. This is the highest-impact bug in the new set.

**Fix:** Replace raw dict extraction with typed `Query` parameters with bounds.

### 3. `analytics.py:82` — Unbounded KPI list (MEDIUM)
**Why:** As KPI configs grow, `GET /kpis` becomes increasingly slow with no client control. Wrapping it in `ListResponse` with pagination is low effort and brings it in line with every other list endpoint in the project.

**Fix:** Add `limit`/`offset` Query params, return `ListResponse[KPIReadout]`.

---

## Codebase Health Score

**58/100** (stable vs cycle 3's 58/100)

Breakdown:
- Cycle 3 open API findings: 9 (still unfixed)
- Cycle 7 new findings: 10 (1H + 7M + 2L)
- ~85% of endpoints have correct response_model (unchanged from cycle 3 estimate)
- Remaining gaps concentrated in: `nas.py` (6 open issues), utility/action endpoints
- Good: ~95% of list endpoints now have proper pagination; most CRUD modules are clean

**Trend: Stable** — The core CRUD modules (comms, webhooks, qualification, external, analytics kpi-configs, connectors, subscribers, audit) are all clean with proper response_models and pagination. The remaining gaps are concentrated in a small number of files: `nas.py` (complex mixed module), `fiber_plant.py`, `billing.py` dashboard, and a handful of utility/action endpoints that were added without schemas.

---

## Files With No New Issues (Good)
- `audit.py`, `bandwidth.py`, `comms.py`, `connectors.py`, `domains.py`, `domains_network_access.py`, `domains_network_fiber.py`, `domains_monitoring.py`, `domains_provisioning.py`, `domains_usage.py`, `external.py`, `files.py`, `geocoding.py`, `notifications.py`, `qualification.py`, `rbac.py`, `settings.py`, `subscribers.py`, `subscriptions.py`, `tables.py` (except pagination bypass), `validation.py`, `webhooks.py`
