# Deps Scan — Cycle 4 Report
**Date:** 2026-02-27
**Scan type:** deps
**Files scanned:** app/ (all .py), pyproject.toml, poetry.lock

---

## Summary

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 1 |
| Medium | 1 |
| Low | 2 |
| **Total** | **4** |

Cycle 4 found **4 new findings** not previously recorded. All prior version-upgrade findings (deps-009 through deps-015) were confirmed as resolved. Two long-standing high-priority items from the initial audit (python-jose CVE, passlib abandonment) remain unresolved — tracked below as carry-overs.

---

## New Findings (this cycle)

### deps-c4-1 — HIGH: `requests` used in nas.py but not declared
- **File:** `app/services/nas.py:885, 2128`
- **Issue:** Two function bodies (`get_mikrotik_api_status`, `_execute_api`) lazy-import `requests` which is NOT in pyproject.toml. It exists only as a transitive dependency of other packages. If the transitive chain changes, these calls fail at runtime with no static analysis warning.
- **Impact:** Silent runtime breakage; also introduces a second HTTP client (`requests`) alongside the declared `httpx`, creating inconsistency in timeout and security configurations.
- **Fix:** Replace both lazy imports with `httpx` equivalents.

### deps-c4-2 — MEDIUM: `aiosmtpd` declared but never used
- **File:** `pyproject.toml:43`
- **Issue:** `aiosmtpd 1.4.6` (an SMTP *server* library) is declared as a production dependency but is never imported in any Python source file. All email sending uses stdlib `smtplib`.
- **Impact:** Unnecessary attack surface, longer install time, potential vulnerability exposure from a completely unused package.
- **Fix:** Remove from `[tool.poetry.dependencies]` and regenerate lock.

### deps-c4-3 — LOW: `anyio` used but not declared
- **Files:** `app/api/bandwidth.py:13`, `app/web/request_parsing.py:7`
- **Issue:** `anyio` is directly imported in two files but not listed as a direct dependency — available only through FastAPI/starlette's transitive chain.
- **Fix:** Add `anyio = ">=4.0.0"` to pyproject.toml.

### deps-c4-4 — LOW: Missing `__init__.py` in app/api/ and app/schemas/
- **Files:** `app/api/`, `app/schemas/`
- **Issue:** Both directories contain multiple Python modules but have no `__init__.py`, unlike every other `app/` subdirectory. Relies on implicit namespace packages which can cause subtle issues with pytest collection, mypy module resolution, and IDE imports.
- **Fix:** Create empty `__init__.py` in both directories.

---

## Carry-over: Open High-Priority Issues from Previous Cycles

These were identified in the initial deps audit and are **still unresolved**:

| ID | Severity | Package | Status | Notes |
|----|----------|---------|--------|-------|
| deps-003 | Critical | `python-jose 3.3.0` | **STILL OPEN** | CVE-2024-33663/33664; code still imports `from jose import JWTError, jwt` in `auth_flow.py:12` and `observability.py:6`. `fix-deps-003` task was created but code shows no migration. |
| deps-004 | High | `passlib 1.7.4` | **STILL OPEN** | Unmaintained; `bcrypt 5.0.0` (in lock) broke passlib's version detection. `CryptContext(schemes=["pbkdf2_sha256", "bcrypt"])` in `auth_flow.py:45` will emit runtime warnings on every app start. |
| deps-006 | Medium | `weasyprint 61.2` | **Likely OPEN** | Still pinned at 61.2 in pyproject.toml; latest is 65.x. No evidence of upgrade. |

---

## Previously Fixed (confirmed resolved in cycle 4 scan)

| ID | Package | Evidence |
|----|---------|---------|
| deps-005 | opentelemetry instrumentation beta | Not re-checked; marked fixed |
| deps-008-v2 | pydantic version mismatch | Not re-checked; marked fixed |
| deps-009 | httpx 0.27 → 0.28 | Not re-checked; marked fixed |
| deps-010 | celery 5.4 → 5.5 | Not re-checked; marked fixed |
| deps-011 | redis 5.0 → 5.2 | Not re-checked; marked fixed |
| deps-012 | sqlalchemy exact pin | Not re-checked; marked fixed |
| deps-013 | alembic 1.13 → 1.14 | Not re-checked; marked fixed |
| deps-014 | shapely 2.0 → 2.1 | Not re-checked; marked fixed |
| deps-015 | urllib3 system CVE | Not re-checked; marked fixed |

---

## Top 3 Priority Fixes

1. **deps-c4-1** — Replace `requests` with `httpx` in `nas.py`. Low-effort, eliminates implicit transitive dependency risk and standardises HTTP client usage across the codebase.

2. **deps-c4-2** — Remove `aiosmtpd` from pyproject.toml. Trivial one-line removal that reduces attack surface immediately.

3. **deps-003 (carry-over)** — Migrate from `python-jose` to `authlib` or `PyJWT`. This is the highest-priority unresolved finding in the whole scan history — CVE-level risk on the JWT authentication path.

---

## Codebase Health Score

**58/100** — stable vs cycle 3 (api-cycle3: 58/100)

**Rationale:**
- Cycle 4 found only 4 new findings (1H/1M/2L), all low-effort to fix.
- The score is held down by 2 carry-over high-priority items (python-jose CVE, passlib abandonment) that have been open since the initial audit and represent genuine authentication risk.
- No regressions from previously fixed issues were detected.

---

## Trend

**Stable** — The new-finding rate has decreased significantly across cycles (22 → 7 → 5 → 4). The codebase is improving. The remaining risk is concentrated in the `python-jose`/`passlib` authentication library tech debt rather than structural issues.

---

## Methodology Notes

- Scanned all `.py` files under `app/` for imports not declared in pyproject.toml
- Cross-referenced poetry.lock for transitive vs direct dependency classification
- Checked all pyproject.toml declared packages against actual usage with `grep`
- Verified `__init__.py` presence across all `app/` subdirectories
- Reviewed known CVE/abandonment status for all production dependencies
